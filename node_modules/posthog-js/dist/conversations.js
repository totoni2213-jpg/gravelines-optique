!function(){"use strict";function e(e,t,i,r,n,o,s){try{var l=e[o](s),a=l.value}catch(e){return void i(e)}l.done?t(a):Promise.resolve(a).then(r,n)}function t(t){return function(){var i=this,r=arguments;return new Promise((function(n,o){var s=t.apply(i,r);function l(t){e(s,n,o,l,a,"next",t)}function a(t){e(s,n,o,l,a,"throw",t)}l(void 0)}))}}function i(){return i=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var i=arguments[t];for(var r in i)({}).hasOwnProperty.call(i,r)&&(e[r]=i[r])}return e},i.apply(null,arguments)}var r,n,o,s,l,a,u,d,c,h,f,p={},v=[],g=/acit|ex(?:s|g|n|p|$)|rph|grid|ows|mnc|ntw|ine[ch]|zoo|^ord|itera/i,m=Array.isArray;function y(e,t){for(var i in t)e[i]=t[i];return e}function x(e){e&&e.parentNode&&e.parentNode.removeChild(e)}function w(e,t,i,r,s){var l={type:e,props:t,key:i,ref:r,__k:null,__:null,__b:0,__e:null,__c:null,constructor:void 0,__v:null==s?++o:s,__i:-1,__u:0};return null==s&&null!=n.vnode&&n.vnode(l),l}function b(e){return e.children}function k(e,t){this.props=e,this.context=t}function _(e,t){if(null==t)return e.__?_(e.__,e.__i+1):null;for(var i;t<e.__k.length;t++)if(null!=(i=e.__k[t])&&null!=i.__e)return i.__e;return"function"==typeof e.type?_(e):null}function S(e){var t,i;if(null!=(e=e.__)&&null!=e.__c){for(e.__e=e.__c.base=null,t=0;t<e.__k.length;t++)if(null!=(i=e.__k[t])&&null!=i.__e){e.__e=e.__c.base=i.__e;break}return S(e)}}function C(e){(!e.__d&&(e.__d=!0)&&s.push(e)&&!$.__r++||l!=n.debounceRendering)&&((l=n.debounceRendering)||a)($)}function $(){for(var e,t,i,r,o,l,a,d=1;s.length;)s.length>d&&s.sort(u),e=s.shift(),d=s.length,e.__d&&(i=void 0,r=void 0,o=(r=(t=e).__v).__e,l=[],a=[],t.__P&&((i=y({},r)).__v=r.__v+1,n.vnode&&n.vnode(i),q(t.__P,i,r,t.__n,t.__P.namespaceURI,32&r.__u?[o]:null,l,null==o?_(r):o,!!(32&r.__u),a),i.__v=r.__v,i.__.__k[i.__i]=i,W(l,i,a),r.__e=r.__=null,i.__e!=o&&S(i)));$.__r=0}function E(e,t,i,r,n,o,s,l,a,u,d){var c,h,f,g,m,y,x,w=r&&r.__k||v,b=t.length;for(a=I(i,t,w,a,b),c=0;c<b;c++)null!=(f=i.__k[c])&&(h=-1==f.__i?p:w[f.__i]||p,f.__i=c,y=q(e,f,h,n,o,s,l,a,u,d),g=f.__e,f.ref&&h.ref!=f.ref&&(h.ref&&N(h.ref,null,f),d.push(f.ref,f.__c||g,f)),null==m&&null!=g&&(m=g),(x=!!(4&f.__u))||h.__k===f.__k?a=T(f,a,e,x):"function"==typeof f.type&&void 0!==y?a=y:g&&(a=g.nextSibling),f.__u&=-7);return i.__e=m,a}function I(e,t,i,r,n){var o,s,l,a,u,d=i.length,c=d,h=0;for(e.__k=new Array(n),o=0;o<n;o++)null!=(s=t[o])&&"boolean"!=typeof s&&"function"!=typeof s?("string"==typeof s||"number"==typeof s||"bigint"==typeof s||s.constructor==String?s=e.__k[o]=w(null,s,null,null,null):m(s)?s=e.__k[o]=w(b,{children:s},null,null,null):void 0===s.constructor&&s.__b>0?s=e.__k[o]=w(s.type,s.props,s.key,s.ref?s.ref:null,s.__v):e.__k[o]=s,a=o+h,s.__=e,s.__b=e.__b+1,l=null,-1!=(u=s.__i=M(s,i,a,c))&&(c--,(l=i[u])&&(l.__u|=2)),null==l||null==l.__v?(-1==u&&(n>d?h--:n<d&&h++),"function"!=typeof s.type&&(s.__u|=4)):u!=a&&(u==a-1?h--:u==a+1?h++:(u>a?h--:h++,s.__u|=4))):e.__k[o]=null;if(c)for(o=0;o<d;o++)null!=(l=i[o])&&0==(2&l.__u)&&(l.__e==r&&(r=_(l)),P(l,l));return r}function T(e,t,i,r){var n,o;if("function"==typeof e.type){for(n=e.__k,o=0;n&&o<n.length;o++)n[o]&&(n[o].__=e,t=T(n[o],t,i,r));return t}e.__e!=t&&(r&&(t&&e.type&&!t.parentNode&&(t=_(e)),i.insertBefore(e.__e,t||null)),t=e.__e);do{t=t&&t.nextSibling}while(null!=t&&8==t.nodeType);return t}function M(e,t,i,r){var n,o,s,l=e.key,a=e.type,u=t[i],d=null!=u&&0==(2&u.__u);if(null===u&&null==l||d&&l==u.key&&a==u.type)return i;if(r>(d?1:0))for(n=i-1,o=i+1;n>=0||o<t.length;)if(null!=(u=t[s=n>=0?n--:o++])&&0==(2&u.__u)&&l==u.key&&a==u.type)return s;return-1}function R(e,t,i){"-"==t[0]?e.setProperty(t,null==i?"":i):e[t]=null==i?"":"number"!=typeof i||g.test(t)?i:i+"px"}function L(e,t,i,r,n){var o,s;e:if("style"==t)if("string"==typeof i)e.style.cssText=i;else{if("string"==typeof r&&(e.style.cssText=r=""),r)for(t in r)i&&t in i||R(e.style,t,"");if(i)for(t in i)r&&i[t]==r[t]||R(e.style,t,i[t])}else if("o"==t[0]&&"n"==t[1])o=t!=(t=t.replace(d,"$1")),s=t.toLowerCase(),t=s in e||"onFocusOut"==t||"onFocusIn"==t?s.slice(2):t.slice(2),e.l||(e.l={}),e.l[t+o]=i,i?r?i.u=r.u:(i.u=c,e.addEventListener(t,o?f:h,o)):e.removeEventListener(t,o?f:h,o);else{if("http://www.w3.org/2000/svg"==n)t=t.replace(/xlink(H|:h)/,"h").replace(/sName$/,"s");else if("width"!=t&&"height"!=t&&"href"!=t&&"list"!=t&&"form"!=t&&"tabIndex"!=t&&"download"!=t&&"rowSpan"!=t&&"colSpan"!=t&&"role"!=t&&"popover"!=t&&t in e)try{e[t]=null==i?"":i;break e}catch(e){}"function"==typeof i||(null==i||!1===i&&"-"!=t[4]?e.removeAttribute(t):e.setAttribute(t,"popover"==t&&1==i?"":i))}}function F(e){return function(t){if(this.l){var i=this.l[t.type+e];if(null==t.t)t.t=c++;else if(t.t<i.u)return;return i(n.event?n.event(t):t)}}}function q(e,t,i,r,o,s,l,a,u,d){var c,h,f,p,v,g,w,_,S,C,I,$,T,M,R,L,F,q=t.type;if(void 0!==t.constructor)return null;128&i.__u&&(u=!!(32&i.__u),s=[a=t.__e=i.__e]),(c=n.__b)&&c(t);e:if("function"==typeof q)try{if(_=t.props,S="prototype"in q&&q.prototype.render,C=(c=q.contextType)&&r[c.__c],I=c?C?C.props.value:c.__:r,i.__c?w=(h=t.__c=i.__c).__=h.__E:(S?t.__c=h=new q(_,I):(t.__c=h=new k(_,I),h.constructor=q,h.render=A),C&&C.sub(h),h.state||(h.state={}),h.__n=r,f=h.__d=!0,h.__h=[],h._sb=[]),S&&null==h.__s&&(h.__s=h.state),S&&null!=q.getDerivedStateFromProps&&(h.__s==h.state&&(h.__s=y({},h.__s)),y(h.__s,q.getDerivedStateFromProps(_,h.__s))),p=h.props,v=h.state,h.__v=t,f)S&&null==q.getDerivedStateFromProps&&null!=h.componentWillMount&&h.componentWillMount(),S&&null!=h.componentDidMount&&h.__h.push(h.componentDidMount);else{if(S&&null==q.getDerivedStateFromProps&&_!==p&&null!=h.componentWillReceiveProps&&h.componentWillReceiveProps(_,I),t.__v==i.__v||!h.__e&&null!=h.shouldComponentUpdate&&!1===h.shouldComponentUpdate(_,h.__s,I)){for(t.__v!=i.__v&&(h.props=_,h.state=h.__s,h.__d=!1),t.__e=i.__e,t.__k=i.__k,t.__k.some((function(e){e&&(e.__=t)})),$=0;$<h._sb.length;$++)h.__h.push(h._sb[$]);h._sb=[],h.__h.length&&l.push(h);break e}null!=h.componentWillUpdate&&h.componentWillUpdate(_,h.__s,I),S&&null!=h.componentDidUpdate&&h.__h.push((function(){h.componentDidUpdate(p,v,g)}))}if(h.context=I,h.props=_,h.__P=e,h.__e=!1,T=n.__r,M=0,S){for(h.state=h.__s,h.__d=!1,T&&T(t),c=h.render(h.props,h.state,h.context),R=0;R<h._sb.length;R++)h.__h.push(h._sb[R]);h._sb=[]}else do{h.__d=!1,T&&T(t),c=h.render(h.props,h.state,h.context),h.state=h.__s}while(h.__d&&++M<25);h.state=h.__s,null!=h.getChildContext&&(r=y(y({},r),h.getChildContext())),S&&!f&&null!=h.getSnapshotBeforeUpdate&&(g=h.getSnapshotBeforeUpdate(p,v)),L=c,null!=c&&c.type===b&&null==c.key&&(L=D(c.props.children)),a=E(e,m(L)?L:[L],t,i,r,o,s,l,a,u,d),h.base=t.__e,t.__u&=-161,h.__h.length&&l.push(h),w&&(h.__E=h.__=null)}catch(e){if(t.__v=null,u||null!=s)if(e.then){for(t.__u|=u?160:128;a&&8==a.nodeType&&a.nextSibling;)a=a.nextSibling;s[s.indexOf(a)]=null,t.__e=a}else{for(F=s.length;F--;)x(s[F]);z(t)}else t.__e=i.__e,t.__k=i.__k,e.then||z(t);n.__e(e,t,i)}else null==s&&t.__v==i.__v?(t.__k=i.__k,t.__e=i.__e):a=t.__e=B(i.__e,t,i,r,o,s,l,u,d);return(c=n.diffed)&&c(t),128&t.__u?void 0:a}function z(e){e&&e.__c&&(e.__c.__e=!0),e&&e.__k&&e.__k.forEach(z)}function W(e,t,i){for(var r=0;r<i.length;r++)N(i[r],i[++r],i[++r]);n.__c&&n.__c(t,e),e.some((function(t){try{e=t.__h,t.__h=[],e.some((function(e){e.call(t)}))}catch(e){n.__e(e,t.__v)}}))}function D(e){return"object"!=typeof e||null==e||e.__b&&e.__b>0?e:m(e)?e.map(D):y({},e)}function B(e,t,i,o,s,l,a,u,d){var c,h,f,v,g,y,w,b=i.props||p,k=t.props,S=t.type;if("svg"==S?s="http://www.w3.org/2000/svg":"math"==S?s="http://www.w3.org/1998/Math/MathML":s||(s="http://www.w3.org/1999/xhtml"),null!=l)for(c=0;c<l.length;c++)if((g=l[c])&&"setAttribute"in g==!!S&&(S?g.localName==S:3==g.nodeType)){e=g,l[c]=null;break}if(null==e){if(null==S)return document.createTextNode(k);e=document.createElementNS(s,S,k.is&&k),u&&(n.__m&&n.__m(t,l),u=!1),l=null}if(null==S)b===k||u&&e.data==k||(e.data=k);else{if(l=l&&r.call(e.childNodes),!u&&null!=l)for(b={},c=0;c<e.attributes.length;c++)b[(g=e.attributes[c]).name]=g.value;for(c in b)if(g=b[c],"children"==c);else if("dangerouslySetInnerHTML"==c)f=g;else if(!(c in k)){if("value"==c&&"defaultValue"in k||"checked"==c&&"defaultChecked"in k)continue;L(e,c,null,g,s)}for(c in k)g=k[c],"children"==c?v=g:"dangerouslySetInnerHTML"==c?h=g:"value"==c?y=g:"checked"==c?w=g:u&&"function"!=typeof g||b[c]===g||L(e,c,g,b[c],s);if(h)u||f&&(h.__html==f.__html||h.__html==e.innerHTML)||(e.innerHTML=h.__html),t.__k=[];else if(f&&(e.innerHTML=""),E("template"==t.type?e.content:e,m(v)?v:[v],t,i,o,"foreignObject"==S?"http://www.w3.org/1999/xhtml":s,l,a,l?l[0]:i.__k&&_(i,0),u,d),null!=l)for(c=l.length;c--;)x(l[c]);u||(c="value","progress"==S&&null==y?e.removeAttribute("value"):null!=y&&(y!==e[c]||"progress"==S&&!y||"option"==S&&y!=b[c])&&L(e,c,y,b[c],s),c="checked",null!=w&&w!=e[c]&&L(e,c,w,b[c],s))}return e}function N(e,t,i){try{if("function"==typeof e){var r="function"==typeof e.__u;r&&e.__u(),r&&null==t||(e.__u=e(t))}else e.current=t}catch(e){n.__e(e,i)}}function P(e,t,i){var r,o;if(n.unmount&&n.unmount(e),(r=e.ref)&&(r.current&&r.current!=e.__e||N(r,null,t)),null!=(r=e.__c)){if(r.componentWillUnmount)try{r.componentWillUnmount()}catch(e){n.__e(e,t)}r.base=r.__P=null}if(r=e.__k)for(o=0;o<r.length;o++)r[o]&&P(r[o],t,i||"function"!=typeof e.type);i||x(e.__e),e.__c=e.__=e.__e=void 0}function A(e,t,i){return this.constructor(e,i)}function U(e,t,i){var o,s,l;t==document&&(t=document.documentElement),n.__&&n.__(e,t),o=!1?null:t.__k,s=[],l=[],q(t,e=t.__k=function(e,t,i){var n,o,s,l={};for(s in t)"key"==s?n=t[s]:"ref"==s?o=t[s]:l[s]=t[s];if(arguments.length>2&&(l.children=arguments.length>3?r.call(arguments,2):i),"function"==typeof e&&null!=e.defaultProps)for(s in e.defaultProps)void 0===l[s]&&(l[s]=e.defaultProps[s]);return w(e,l,n,o,null)}(b,null,[e]),o||p,p,t.namespaceURI,o?null:t.firstChild?r.call(t.childNodes):null,s,o?o.__e:t.firstChild,false,l),W(s,e,l)}r=v.slice,n={__e:function(e,t,i,r){for(var n,o,s;t=t.__;)if((n=t.__c)&&!n.__)try{if((o=n.constructor)&&null!=o.getDerivedStateFromError&&(n.setState(o.getDerivedStateFromError(e)),s=n.__d),null!=n.componentDidCatch&&(n.componentDidCatch(e,r||{}),s=n.__d),s)return n.__E=n}catch(t){e=t}throw e}},o=0,k.prototype.setState=function(e,t){var i;i=null!=this.__s&&this.__s!=this.state?this.__s:this.__s=y({},this.state),"function"==typeof e&&(e=e(y({},i),this.props)),e&&y(i,e),null!=e&&this.__v&&(t&&this._sb.push(t),C(this))},k.prototype.forceUpdate=function(e){this.__v&&(this.__e=!0,e&&this.__h.push(e),C(this))},k.prototype.render=b,s=[],a="function"==typeof Promise?Promise.prototype.then.bind(Promise.resolve()):setTimeout,u=function(e,t){return e.__v.__b-t.__v.__b},$.__r=0,d=/(PointerCapture)$|Capture$/i,c=0,h=F(!1),f=F(!0);var O=Array.isArray,H=Object.prototype,V=H.hasOwnProperty,j=H.toString,Y=O||function(e){return"[object Array]"===j.call(e)},X=e=>void 0===e,G=e=>"[object Number]"==j.call(e)&&e==e,K="undefined"!=typeof window?window:void 0,J="undefined"!=typeof globalThis?globalThis:K;"undefined"==typeof self&&(J.self=J),"undefined"==typeof File&&(J.File=function(){});var Z=Array.prototype.forEach,Q=null==J?void 0:J.navigator,ee=null==J?void 0:J.document;null==J||J.location,null==J||J.fetch,null!=J&&J.XMLHttpRequest&&"withCredentials"in new J.XMLHttpRequest&&J.XMLHttpRequest,null==J||J.AbortController,null==Q||Q.userAgent;var te=null!=K?K:{},ie=function(e,t){var{debugEnabled:i}=void 0===t?{}:t,r={i:function(t){if(K&&(te.POSTHOG_DEBUG||i)&&!X(K.console)&&K.console){for(var r=("__rrweb_original__"in K.console[t]?K.console[t].__rrweb_original__:K.console[t]),n=arguments.length,o=new Array(n>1?n-1:0),s=1;s<n;s++)o[s-1]=arguments[s];r(e,...o)}},info:function(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];r.i("log",...t)},warn:function(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];r.i("warn",...t)},error:function(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];r.i("error",...t)},critical:function(){for(var t=arguments.length,i=new Array(t),r=0;r<t;r++)i[r]=arguments[r];console.error(e,...i)},uninitializedWarning:e=>{r.error("You must initialize PostHog before calling "+e)},createLogger:(t,i)=>ie(e+" "+t,i)};return r},re=ie("[PostHog.js]").createLogger;Math.trunc||(Math.trunc=function(e){return e<0?Math.ceil(e):Math.floor(e)}),Number.isInteger||(Number.isInteger=function(e){return G(e)&&isFinite(e)&&Math.floor(e)===e});var ne="0123456789abcdef";class oe{constructor(e){if(this.bytes=e,16!==e.length)throw new TypeError("not 128-bit length")}static fromFieldsV7(e,t,i,r){if(!Number.isInteger(e)||!Number.isInteger(t)||!Number.isInteger(i)||!Number.isInteger(r)||e<0||t<0||i<0||r<0||e>0xffffffffffff||t>4095||i>1073741823||r>4294967295)throw new RangeError("invalid field value");var n=new Uint8Array(16);return n[0]=e/Math.pow(2,40),n[1]=e/Math.pow(2,32),n[2]=e/Math.pow(2,24),n[3]=e/Math.pow(2,16),n[4]=e/Math.pow(2,8),n[5]=e,n[6]=112|t>>>8,n[7]=t,n[8]=128|i>>>24,n[9]=i>>>16,n[10]=i>>>8,n[11]=i,n[12]=r>>>24,n[13]=r>>>16,n[14]=r>>>8,n[15]=r,new oe(n)}toString(){for(var e="",t=0;t<this.bytes.length;t++)e=e+ne.charAt(this.bytes[t]>>>4)+ne.charAt(15&this.bytes[t]),3!==t&&5!==t&&7!==t&&9!==t||(e+="-");if(36!==e.length)throw new Error("Invalid UUIDv7 was generated");return e}clone(){return new oe(this.bytes.slice(0))}equals(e){return 0===this.compareTo(e)}compareTo(e){for(var t=0;t<16;t++){var i=this.bytes[t]-e.bytes[t];if(0!==i)return Math.sign(i)}return 0}}class se{constructor(){this.o=0,this.h=0,this.p=new ue}generate(){var e=this.generateOrAbort();if(X(e)){this.o=0;var t=this.generateOrAbort();if(X(t))throw new Error("Could not generate UUID after timestamp reset");return t}return e}generateOrAbort(){var e=Date.now();if(e>this.o)this.o=e,this.v();else{if(!(e+1e4>this.o))return;this.h++,this.h>4398046511103&&(this.o++,this.v())}return oe.fromFieldsV7(this.o,Math.trunc(this.h/Math.pow(2,30)),this.h&Math.pow(2,30)-1,this.p.nextUint32())}v(){this.h=1024*this.p.nextUint32()+(1023&this.p.nextUint32())}}var le,ae=e=>{if("undefined"!=typeof UUIDV7_DENY_WEAK_RNG&&UUIDV7_DENY_WEAK_RNG)throw new Error("no cryptographically strong RNG available");for(var t=0;t<e.length;t++)e[t]=65536*Math.trunc(65536*Math.random())+Math.trunc(65536*Math.random());return e};K&&!X(K.crypto)&&crypto.getRandomValues&&(ae=e=>crypto.getRandomValues(e));class ue{constructor(){this.m=new Uint32Array(8),this.k=1/0}nextUint32(){return this.k>=this.m.length&&(ae(this.m),this.k=0),this.m[this.k++]}}var de=()=>(le||(le=new se)).generate(),ce=re("[ConversationsPersistence]"),he="$conversations_widget_session_id",fe="$conversations_ticket_id",pe="$conversations_widget_state",ve="$conversations_user_traits";class ge{constructor(e){this.S=null,this._posthog=e,this.C=function(e){var t,i=null==(t=e.config)?void 0:t.token;return i?"ph_conv_"+i:null}(e),this.I()}getOrCreateWidgetSessionId(){var e;if(this.S)return this.S;var t=null==(e=this.T())?void 0:e.widgetSessionId;return t||(t=de().toString(),this.M({widgetSessionId:t})),this.S=t,t}setWidgetSessionId(e){this.S=e;var t=this.T()||{};this.M(i({},t,{widgetSessionId:e}))}clearWidgetSessionId(){this.S=null;var e=this.T();e&&(delete e.widgetSessionId,this.M(e))}saveTicketId(e){var t=this.T()||{};this.M(i({},t,{ticketId:e}))}loadTicketId(){var e;return(null==(e=this.T())?void 0:e.ticketId)||null}clearTicketId(){var e=this.T();e&&(delete e.ticketId,this.M(e))}saveWidgetState(e){var t=this.T()||{};this.M(i({},t,{widgetState:e}))}loadWidgetState(){var e,t=null==(e=this.T())?void 0:e.widgetState;return"open"===t||"closed"===t?t:null}saveUserTraits(e){var t=this.T()||{};this.M(i({},t,{userTraits:e}))}loadUserTraits(){var e,t=null==(e=this.T())?void 0:e.userTraits;return t&&(t.name||t.email)?t:null}clearUserTraits(){var e=this.T();e&&(delete e.userTraits,this.M(e))}clearAll(){if(this.S=null,this.C)try{var e;null==K||null==(e=K.localStorage)||e.removeItem(this.C)}catch(e){ce.error("Failed to remove localStorage item")}}T(){if(!this.C)return null;try{var e,t=null==K||null==(e=K.localStorage)?void 0:e.getItem(this.C);return t?JSON.parse(t):null}catch(e){return null}}M(e){if(this.C)try{var t;null==K||null==(t=K.localStorage)||t.setItem(this.C,JSON.stringify(e))}catch(e){ce.error("Failed to write to localStorage",e)}}I(){var e;if(this.C&&(null==(e=this.T())||!e.widgetSessionId))try{var t=this._posthog.persistence;if(!t||null!=t.isDisabled&&t.isDisabled())return;var i=t.get_property(he);if(!i){var r=this.R();return void(r&&(this.M(r),ce.info("Migrated conversations data from raw localStorage")))}var n={widgetSessionId:i},o=t.get_property(fe);o&&(n.ticketId=o);var s=t.get_property(pe);"open"!==s&&"closed"!==s||(n.widgetState=s);var l=t.get_property(ve);l&&(n.userTraits=l),this.M(n),t.unregister(he),t.unregister(fe),t.unregister(pe),t.unregister(ve),ce.info("Migrated conversations data to dedicated storage")}catch(e){ce.error("Migration from legacy persistence failed",e)}}R(){try{var e,t,i=null==(e=this._posthog.config)?void 0:e.token;if(!i)return null;var r=this._posthog.config.persistence_name?"ph_"+this._posthog.config.persistence_name:"ph_"+i+"_posthog",n=null==K||null==(t=K.localStorage)?void 0:t.getItem(r);if(!n)return null;var o=JSON.parse(n),s=null==o?void 0:o[he];if("string"!=typeof s||!s)return null;var l={widgetSessionId:s},a=null==o?void 0:o[fe];a&&(l.ticketId=a);var u=null==o?void 0:o[pe];"open"!==u&&"closed"!==u||(l.widgetState=u);var d=null==o?void 0:o[ve];return d&&(l.userTraits=d),l}catch(e){return null}}}function me(e){var t=e.replace(/^#/,""),i=3===t.length?t[0]+t[0]+t[1]+t[1]+t[2]+t[2]:t,r=parseInt(i.slice(0,2),16),n=parseInt(i.slice(2,4),16),o=parseInt(i.slice(4,6),16);return Math.sqrt(r*r*.299+n*n*.587+o*o*.114)>127.5?"#020617":"white"}var ye=function(e,t){void 0===t&&(t="bottom_right");var r=t.includes("left"),n=t.includes("top");return{widget:i({position:"fixed"},n?{top:"20px"}:{bottom:"20px"},r?{left:"20px"}:{right:"20px"},{zIndex:2147483644,fontFamily:'-apple-system, BlinkMacSystemFont, "Inter", "Segoe UI", "Roboto", Helvetica, Arial, sans-serif'}),buttonContainer:{position:"relative"},button:{width:"50px",height:"50px",borderRadius:"50%",background:e,color:me(e),border:"none",cursor:"pointer",boxShadow:"0 4px 12px rgba(0, 0, 0, 0.15)",display:"flex",alignItems:"center",justifyContent:"center",transition:"transform 0.2s ease-out, box-shadow 0.2s ease-out"},unreadBadge:i({position:"absolute"},n?{bottom:"-4px"}:{top:"-4px"},r?{left:"-4px"}:{right:"-4px"},{minWidth:"20px",height:"20px",borderRadius:"10px",background:"#ef4444",color:"white",fontSize:"11px",fontWeight:600,display:"flex",alignItems:"center",justifyContent:"center",padding:"0 5px",boxShadow:"0 2px 4px rgba(0, 0, 0, 0.2)",border:"2px solid white",boxSizing:"border-box"}),window:i({position:"absolute"},n?{top:0}:{bottom:0},r?{left:0}:{right:0},{background:"white",borderRadius:"10px",boxShadow:"0 10px 25px -3px rgba(0,0,0,0.12), 0 4px 12px -2px rgba(0,0,0,0.10)",display:"flex",flexDirection:"column",overflow:"hidden",transition:"all 0.3s cubic-bezier(0.4, 0, 0.2, 1)",border:"none"}),windowOpen:{width:"400px",maxWidth:"calc(100vw - 40px)",height:"600px",maxHeight:"calc(100vh - 100px)"},header:{background:e,color:me(e),padding:"8px 12px",display:"flex",justifyContent:"space-between",alignItems:"center",flexShrink:0},headerTitle:{fontWeight:500,fontSize:"14px"},headerActions:{display:"flex",gap:"4px",alignItems:"center"},headerLinkButton:{background:"transparent",border:"none",color:me(e),cursor:"pointer",padding:"6px 8px",fontSize:"12px",borderRadius:"4px",opacity:.9},headerButton:{background:"transparent",border:"none",color:me(e),cursor:"pointer",padding:"6px 8px",fontSize:"16px",lineHeight:1,borderRadius:"4px",transition:"background 0.2s ease-out",opacity:.9},messages:{flex:1,overflowY:"auto",padding:"14px",display:"flex",flexDirection:"column",gap:"8px",background:"white"},message:{display:"flex",flexDirection:"column",maxWidth:"85%",animation:"fadeIn 0.2s ease-out"},messageCustomer:{alignSelf:"flex-end",alignItems:"flex-end"},messageAgent:{alignSelf:"flex-start",alignItems:"flex-start"},messageAuthor:{fontSize:"10px",color:"#939393",marginBottom:"4px",fontWeight:500},messageContent:{padding:"8px 12px",borderRadius:"8px",fontSize:"12px",lineHeight:1.5,wordWrap:"break-word",whiteSpace:"pre-wrap"},messageContentCustomer:{background:e,color:me(e),borderBottomRightRadius:"2px"},messageContentAgent:{background:"white",color:"#020617",border:"1.5px solid #dcdcdc",borderBottomLeftRadius:"2px"},messageTime:{fontSize:"10px",color:"#939393",marginTop:"4px",opacity:.8},error:{padding:"10px 16px",background:"#fee2e2",color:"#991b1b",fontSize:"13px",borderTop:"1px solid #fecaca",borderBottom:"1px solid #fecaca",textAlign:"center",fontWeight:500},inputContainer:{padding:"8px 12px",background:"white",borderTop:"1px solid #dcdcdc",display:"flex",gap:"8px",alignItems:"center",flexShrink:0},input:{flex:1,maxHeight:"120px",fontSize:"14px",resize:"vertical",fontFamily:"inherit",lineHeight:1.5,color:"#020617",background:"white",border:"none",outline:"none",transition:"border-color 0.2s ease-out, box-shadow 0.2s ease-out",display:"flex",alignItems:"center",fieldSizing:"content"},sendButton:{width:"33px",height:"33px",borderRadius:"10px",background:e,color:me(e),border:"none",cursor:"pointer",display:"flex",alignItems:"center",justifyContent:"center",transition:"all 0.2s ease-out",boxShadow:"0 2px 0 rgba(0, 0, 0, 0.045)",fontWeight:700,flexShrink:0},identificationForm:{flex:1,display:"flex",flexDirection:"column",padding:"24px",background:"#eeeded",overflowY:"auto"},formTitle:{fontSize:"18px",fontWeight:600,color:"#020617",marginBottom:"8px"},formDescription:{fontSize:"14px",color:"#64748b",marginBottom:"24px",lineHeight:1.5},recoverFooter:{padding:"10px 14px",borderTop:"1px solid #e5e7eb",fontSize:"12px",color:"#64748b",lineHeight:1.5,flexShrink:0,textAlign:"center"},recoverFooterLink:{background:"none",border:"none",padding:0,color:"#64748b",cursor:"pointer",fontSize:"12px",fontFamily:"inherit",textDecoration:"underline"},formField:{marginBottom:"16px"},formLabel:{display:"block",fontSize:"13px",fontWeight:500,color:"#020617",marginBottom:"6px"},formInput:{width:"100%",padding:"10px 12px",border:"1px solid #dcdcdc",borderRadius:"6px",fontSize:"14px",fontFamily:"inherit",color:"#020617",background:"white",transition:"border-color 0.2s ease-out, box-shadow 0.2s ease-out",boxSizing:"border-box"},formInputError:{borderColor:"#ef4444"},formError:{fontSize:"12px",color:"#ef4444",marginTop:"4px"},formSubmitButton:{width:"100%",padding:"12px 16px",borderRadius:"6px",background:e,color:me(e),border:"none",cursor:"pointer",fontSize:"14px",fontWeight:600,transition:"all 0.2s ease-out",marginTop:"8px"},formOptional:{fontSize:"12px",color:"#939393",fontWeight:400},restoreRequestSuccess:{marginTop:"12px",fontSize:"12px",color:"#166534",background:"#dcfce7",border:"1px solid #86efac",borderRadius:"6px",padding:"10px 12px",lineHeight:1.4},ticketListContainer:{flex:1,display:"flex",flexDirection:"column",background:"white",overflowY:"auto"},ticketList:{flex:1,overflowY:"auto"},ticketItem:{padding:"14px 16px",borderBottom:"1px solid #f1f1f1",cursor:"pointer",transition:"background 0.15s ease-out",background:"white",display:"flex",alignItems:"center",gap:"12px"},ticketItemUnread:{background:"#fafafa"},ticketItemContent:{display:"flex",flexDirection:"column",gap:"6px",flex:1,minWidth:0},ticketItemArrow:{color:"#939393",flexShrink:0,display:"flex",alignItems:"center"},ticketItemHeader:{display:"flex",justifyContent:"space-between",alignItems:"flex-start",gap:"8px"},ticketPreview:{fontSize:"13px",color:"#020617",lineHeight:1.4,flex:1,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"},ticketPreviewUnread:{fontSize:"13px",color:"#020617",lineHeight:1.4,flex:1,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap",fontWeight:600},ticketUnreadBadge:{minWidth:"18px",height:"18px",borderRadius:"9px",background:"#ef4444",color:"white",fontSize:"10px",fontWeight:600,display:"flex",alignItems:"center",justifyContent:"center",padding:"0 5px",flexShrink:0},ticketMeta:{display:"flex",alignItems:"center",gap:"8px"},ticketTime:{fontSize:"11px",color:"#939393"},ticketStatus:{fontSize:"10px",color:"#64748b",background:"#f1f5f9",padding:"2px 6px",borderRadius:"4px",textTransform:"uppercase",letterSpacing:"0.3px"},newConversationButton:{display:"flex",alignItems:"center",justifyContent:"center",margin:"12px 16px",padding:"10px 16px",borderRadius:"8px",background:e,color:me(e),border:"none",cursor:"pointer",fontSize:"13px",fontWeight:500,transition:"all 0.2s ease-out"},ticketListLoading:{flex:1,display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",gap:"12px",color:"#64748b",fontSize:"13px"},loadingSpinner:{width:"24px",height:"24px",border:"2px solid #e2e8f0",borderTop:"2px solid "+e,borderRadius:"50%",animation:"spin 0.8s linear infinite"},ticketListEmpty:{flex:1,display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",padding:"32px 24px",textAlign:"center"},emptyStateIcon:{color:"#cbd5e1",marginBottom:"16px"},emptyStateTitle:{fontSize:"16px",fontWeight:600,color:"#020617",marginBottom:"8px"},emptyStateDescription:{fontSize:"13px",color:"#64748b",lineHeight:1.5,marginBottom:"20px"},newConversationButtonLarge:{padding:"12px 24px",borderRadius:"8px",background:e,color:me(e),border:"none",cursor:"pointer",fontSize:"14px",fontWeight:600,transition:"all 0.2s ease-out"},fetchPreviousButton:{marginTop:"10px",background:"transparent",border:"none",color:e,cursor:"pointer",fontSize:"13px",textDecoration:"underline",opacity:1},backButton:{background:"transparent",border:"none",color:me(e),cursor:"pointer",padding:"6px 0px",marginRight:"4px",fontSize:"16px",lineHeight:1,borderRadius:"4px",transition:"background 0.2s ease-out",opacity:.9,display:"flex",alignItems:"center",justifyContent:"center"},headerWithBack:{display:"flex",alignItems:"center"}}},xe=0;function we(e,t,i,r,o,s){t||(t={});var l,a,u=t;if("ref"in u)for(a in u={},t)"ref"==a?l=t[a]:u[a]=t[a];var d={type:e,props:u,key:i,ref:l,__k:null,__:null,__b:0,__e:null,__c:null,constructor:void 0,__v:--xe,__i:-1,__u:0,__source:o,__self:s};if("function"==typeof e&&(l=e.defaultProps))for(a in l)void 0===u[a]&&(u[a]=l[a]);return n.vnode&&n.vnode(d),d}var be=e=>{var{primaryColor:t,position:i="bottom_right",handleToggleOpen:r,unreadCount:n=0}=e,o=ye(t,i),s=n>99?"99+":n.toString();return we("div",{style:o.widget,children:we("div",{style:o.buttonContainer,children:[we("button",{style:o.button,onClick:r,"aria-label":n>0?"Open chat ("+n+" unread)":"Open chat",onMouseEnter:e=>{e.currentTarget.style.transform="scale(1.05)",e.currentTarget.style.boxShadow="0 6px 20px rgba(0, 0, 0, 0.2)"},onMouseLeave:e=>{e.currentTarget.style.transform="scale(1)",e.currentTarget.style.boxShadow="0 4px 12px rgba(0, 0, 0, 0.15)"},children:we("svg",{width:"24",height:"24",viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg",children:we("path",{d:"M12 2C6.48 2 2 6.48 2 12C2 13.93 2.6 15.71 3.64 17.18L2.5 21.5L7.04 20.42C8.46 21.28 10.17 21.75 12 21.75C17.52 21.75 22 17.27 22 11.75C22 6.23 17.52 2 12 2Z",fill:"currentColor"})})}),n>0&&we("div",{style:o.unreadBadge,children:s})]})})},ke=e=>{var{primaryColor:t,handleClose:i}=e;return we("button",{style:ye(t).headerButton,onClick:i,"aria-label":"Close",onMouseEnter:e=>{e.currentTarget.style.background="rgba(255, 255, 255, 0.15)",e.currentTarget.style.opacity="1"},onMouseLeave:e=>{e.currentTarget.style.background="transparent",e.currentTarget.style.opacity="0.9"},children:"âœ•"})};function _e(e){if(!e)return"";var t=new Date(e),i=(new Date).getTime()-t.getTime(),r=Math.floor(i/6e4),n=Math.floor(r/60),o=Math.floor(n/24);return r<1?"Just now":r<60?r+"m ago":n<24?n+"h ago":1===o?"Yesterday":o<7?o+"d ago":t.toLocaleDateString()}function Se(e,t){return e?e.length<=t?e:e.substring(0,t-3)+"...":"No messages yet"}var Ce=e=>{var t,r,{ticket:n,styles:o,onClick:s}=e,l=(n.unread_count||0)>0,a="on_hold"===(t=n.status)?"On hold":t.charAt(0).toUpperCase()+t.slice(1),u=()=>{s(n.id)};return we("div",{style:i({},o.ticketItem,l?o.ticketItemUnread:{}),onClick:u,onKeyDown:e=>{"Enter"!==e.key&&" "!==e.key||(e.preventDefault(),u())},role:"button",tabIndex:0,children:[we("div",{style:o.ticketItemContent,children:[we("div",{style:o.ticketItemHeader,children:[we("span",{style:l?o.ticketPreviewUnread:o.ticketPreview,children:Se((r=n.last_message,r?r.replace(/```[\s\S]*?```/g,"").replace(/`([^`]+)`/g,"$1").replace(/!\[([^\]]*)\]\([^)]+\)/g,"").replace(/\[([^\]]+)\]\([^)]+\)/g,"$1").replace(/^#{1,6}\s+/gm,"").replace(/^>\s*/gm,"").replace(/^[-*_]{3,}\s*$/gm,"").replace(/^[\s]*[-*+]\s+/gm,"").replace(/^[\s]*\d+\.\s+/gm,"").replace(/\*\*([^*]+)\*\*/g,"$1").replace(/\*([^*]+)\*/g,"$1").replace(/__([^_]+)__/g,"$1").replace(/_([^_]+)_/g,"$1").replace(/~~([^~]+)~~/g,"$1").replace(/<[^>]*>/g,"").replace(/[<>]/g,"").replace(/\n{2,}/g,"\n").trim():""),60)}),l&&we("span",{style:o.ticketUnreadBadge,children:n.unread_count})]}),we("div",{style:o.ticketMeta,children:[we("span",{style:o.ticketTime,children:_e(n.last_message_at||n.created_at)}),we("span",{style:o.ticketStatus,children:a})]})]}),we("div",{style:o.ticketItemArrow,children:we("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:we("polyline",{points:"9 18 15 12 9 6"})})})]})},Ee=e=>{var{styles:t}=e;return we("div",{style:t.ticketListLoading,children:[we("div",{style:t.loadingSpinner}),we("span",{children:"Loading conversations..."})]})},Ie=e=>{var{styles:t,onNewConversation:i,onOpenRestoreRequest:r}=e;return we("div",{style:t.ticketListEmpty,children:[we("div",{style:t.emptyStateIcon,children:we("svg",{width:"48",height:"48",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"1.5",children:we("path",{d:"M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"})})}),we("div",{style:t.emptyStateTitle,children:"No conversations yet"}),we("div",{style:t.emptyStateDescription,children:"Start a new conversation to get help from our team."}),we("button",{style:t.newConversationButtonLarge,onClick:i,onMouseEnter:e=>{e.currentTarget.style.opacity="0.9"},onMouseLeave:e=>{e.currentTarget.style.opacity="1"},children:"Start a conversation"}),we("button",{style:t.fetchPreviousButton,onClick:r,onMouseEnter:e=>{e.currentTarget.style.opacity="0.8"},onMouseLeave:e=>{e.currentTarget.style.opacity="1"},children:"Fetch previous conversations"})]})},Te=e=>{var{tickets:t,isLoading:i,styles:r,onSelectTicket:n,onNewConversation:o,onOpenRestoreRequest:s}=e;return i&&0===t.length?we(Ee,{styles:r}):0===t.length?we(Ie,{styles:r,onNewConversation:o,onOpenRestoreRequest:s}):we("div",{style:r.ticketListContainer,children:[we("div",{style:r.ticketList,children:[...t].sort(((e,t)=>{var i=new Date(e.last_message_at||e.created_at).getTime();return new Date(t.last_message_at||t.created_at).getTime()-i})).map((e=>we(Ce,{ticket:e,styles:r,onClick:n},e.id+"-"+(e.last_message_at||e.created_at)+"-"+e.unread_count)))}),we("button",{style:r.newConversationButton,onClick:o,onMouseEnter:e=>{e.currentTarget.style.opacity="0.9"},onMouseLeave:e=>{e.currentTarget.style.opacity="1"},children:[we("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",style:{marginRight:"8px"},children:[we("line",{x1:"12",y1:"5",x2:"12",y2:"19"}),we("line",{x1:"5",y1:"12",x2:"19",y2:"12"})]}),"New conversation"]})]})};function Me(e){var{config:t,styles:r,formName:n,formEmail:o,formEmailError:s,onNameChange:l,onEmailChange:a,onSubmit:u}=e,d=t.identificationFormTitle||"Before we start...",c=t.identificationFormDescription||"Please provide your details so we can help you better.",h=!1!==t.collectName;return we("div",{style:r.identificationForm,children:[we("div",{style:r.formTitle,children:d}),we("div",{style:r.formDescription,children:c}),we("form",{onSubmit:u,children:[h&&we("div",{style:r.formField,children:[we("label",{style:r.formLabel,children:["Name ",we("span",{style:r.formOptional,children:"(optional)"})]}),we("input",{type:"text",style:r.formInput,value:n,onInput:l,placeholder:"Your name",autoComplete:"name"})]}),we("div",{style:r.formField,children:[we("label",{style:r.formLabel,children:["Email ",!t.requireEmail&&we("span",{style:r.formOptional,children:"(optional)"})]}),we("input",{type:"email",style:i({},r.formInput,s?r.formInputError:{}),value:o,onInput:a,placeholder:"you@example.com",autoComplete:"email"}),s&&we("div",{style:r.formError,children:s})]}),we("button",{type:"submit",style:r.formSubmitButton,onMouseEnter:e=>{e.currentTarget.style.opacity="0.9"},onMouseLeave:e=>{e.currentTarget.style.opacity="1"},children:"Start Chat"})]})]})}function Re(e){var{styles:t,restoreEmail:r,restoreEmailError:n,restoreRequestLoading:o,restoreRequestSuccess:s,onEmailChange:l,onSubmit:a}=e;return we("div",{style:t.identificationForm,children:[we("div",{style:t.formTitle,children:"Restore conversations"}),we("div",{style:t.formDescription,children:"Don't see your previous conversations? Maybe you use another browser or computer. Enter your email and we will send a secure restore link if matching conversations exist."}),we("form",{onSubmit:a,children:[we("div",{style:t.formField,children:[we("label",{style:t.formLabel,children:"Email"}),we("input",{type:"email",style:i({},t.formInput,n?t.formInputError:{}),value:r,onInput:l,placeholder:"you@example.com",autoComplete:"email",disabled:o}),n&&we("div",{style:t.formError,children:n})]}),we("button",{type:"submit",style:t.formSubmitButton,disabled:o,children:o?"Sending...":"Send restore link"})]}),s&&we("div",{style:t.restoreRequestSuccess,children:"Check your email for a secure restore link. If an account is found, we sent it."})]})}var Le,Fe,qe,ze,We=e=>{var{primaryColor:t,inputValue:r,isLoading:n,handleSendMessage:o}=e;return we("button",{style:i({},ye(t).sendButton,{opacity:!r.trim()||n?.6:1,cursor:!r.trim()||n?"not-allowed":"pointer"}),onClick:o,disabled:!r.trim()||n,"aria-label":"Send message",onMouseEnter:e=>{e.currentTarget.disabled||(e.currentTarget.style.transform="scale(1.02)",e.currentTarget.style.boxShadow="0 4px 8px rgba(0, 0, 0, 0.1)")},onMouseLeave:e=>{e.currentTarget.style.transform="scale(1)",e.currentTarget.style.boxShadow="0 2px 0 rgba(0, 0, 0, 0.045)"},children:we("svg",{width:"20",height:"20",viewBox:"0 0 20 20",fill:"none",xmlns:"http://www.w3.org/2000/svg",children:we("path",{d:"M2 10L18 2L10 18L8 11L2 10Z",fill:"currentColor",stroke:"currentColor",strokeWidth:"2",strokeLinejoin:"round"})})})},De=0,Be=[],Ne=n,Pe=Ne.__b,Ae=Ne.__r,Ue=Ne.diffed,Oe=Ne.__c,$e=Ne.unmount,He=Ne.__;function Ve(e,t){Ne.__h&&Ne.__h(Fe,e,De||t),De=0;var i=Fe.__H||(Fe.__H={__:[],__h:[]});return e>=i.__.length&&i.__.push({}),i.__[e]}function je(){for(var e;e=Be.shift();)if(e.__P&&e.__H)try{e.__H.__h.forEach(Ge),e.__H.__h.forEach(Ke),e.__H.__h=[]}catch(t){e.__H.__h=[],Ne.__e(t,e.__v)}}Ne.__b=function(e){Fe=null,Pe&&Pe(e)},Ne.__=function(e,t){e&&t.__k&&t.__k.__m&&(e.__m=t.__k.__m),He&&He(e,t)},Ne.__r=function(e){Ae&&Ae(e),Le=0;var t=(Fe=e.__c).__H;t&&(qe===Fe?(t.__h=[],Fe.__h=[],t.__.forEach((function(e){e.__N&&(e.__=e.__N),e.u=e.__N=void 0}))):(t.__h.forEach(Ge),t.__h.forEach(Ke),t.__h=[],Le=0)),qe=Fe},Ne.diffed=function(e){Ue&&Ue(e);var t=e.__c;t&&t.__H&&(t.__H.__h.length&&(1!==Be.push(t)&&ze===Ne.requestAnimationFrame||((ze=Ne.requestAnimationFrame)||Xe)(je)),t.__H.__.forEach((function(e){e.u&&(e.__H=e.u),e.u=void 0}))),qe=Fe=null},Ne.__c=function(e,t){t.some((function(e){try{e.__h.forEach(Ge),e.__h=e.__h.filter((function(e){return!e.__||Ke(e)}))}catch(i){t.some((function(e){e.__h&&(e.__h=[])})),t=[],Ne.__e(i,e.__v)}})),Oe&&Oe(e,t)},Ne.unmount=function(e){$e&&$e(e);var t,i=e.__c;i&&i.__H&&(i.__H.__.forEach((function(e){try{Ge(e)}catch(e){t=e}})),i.__H=void 0,t&&Ne.__e(t,i.__v))};var Ye="function"==typeof requestAnimationFrame;function Xe(e){var t,i=function(){clearTimeout(r),Ye&&cancelAnimationFrame(t),setTimeout(e)},r=setTimeout(i,35);Ye&&(t=requestAnimationFrame(i))}function Ge(e){var t=Fe,i=e.__c;"function"==typeof i&&(e.__c=void 0,i()),Fe=t}function Ke(e){var t=Fe;e.__c=e.__(),Fe=t}function Je(e){if(e&&"string"==typeof e){var t=e.replace(/[\x00-\x1f\x7f\u200b-\u200d\ufeff]/g,"").trim();if(t){var i=t.replace(/\s+/g,"").toLowerCase();if(!(i.startsWith("javascript:")||i.startsWith("vbscript:")||i.startsWith("data:")||i.startsWith("file:")||t.startsWith("//"))){if(t.startsWith("/")||t.startsWith("./")||t.startsWith("../")||t.startsWith("#"))return t;var r=t.toLowerCase();return r.startsWith("http://")||r.startsWith("https://")||r.startsWith("mailto:")||r.startsWith("tel:")?t:void 0}}}}var Ze=20;function Qe(e,t,i,r){var n;if(i>Ze)return null;if("text"===e.type&&!X(e.text))return function(e,t,i,r){if(!t||0===t.length)return we("span",{children:e},r);var n=we(b,{children:e});for(var o of t)switch(o.type){case"bold":n=we("strong",{style:{fontWeight:700},children:n});break;case"italic":n=we("em",{style:{fontStyle:"italic"},children:n});break;case"underline":n=we("u",{style:{textDecoration:"underline"},children:n});break;case"strike":n=we("s",{style:{textDecoration:"line-through"},children:n});break;case"code":n=we("code",{style:i.code,children:n});break;case"link":var s,l=null==(s=o.attrs)?void 0:s.href,a="string"==typeof l?Je(l):void 0;a&&(n=we("a",{href:a,target:"_blank",rel:"noopener noreferrer",referrerPolicy:"no-referrer",style:i.link,children:n}))}return we("span",{children:n},r)}(e.text,e.marks,t,r);var o=(null==(n=e.content)?void 0:n.map(((e,n)=>Qe(e,t,i+1,r+"-"+n))))||[];switch(e.type){case"doc":return we(b,{children:o});case"paragraph":return we("p",{style:{margin:"0 0 8px 0"},children:o.length>0?o:we("br",{})},r);case"hardBreak":return we("br",{},r);case"codeBlock":var s,l=(null==(s=e.content)||null==(s=s[0])?void 0:s.text)||"";return we("pre",{style:t.codeBlock,children:we("code",{children:l})},r);case"image":var a,u,d=null==(a=e.attrs)?void 0:a.src,c=null==(u=e.attrs)?void 0:u.alt,h="string"==typeof d?Je(d):void 0;return h?we("img",{src:h,alt:"string"==typeof c?c:"",style:t.image,onError:e=>{e.target.style.display="none"}},r):null;case"bulletList":return we("ul",{style:{margin:"8px 0",paddingLeft:"24px"},children:o},r);case"orderedList":return we("ol",{style:{margin:"8px 0",paddingLeft:"24px"},children:o},r);case"listItem":return we("li",{style:{margin:"4px 0"},children:o},r);case"blockquote":return we("blockquote",{style:{margin:"8px 0",paddingLeft:"12px",borderLeft:"3px solid #e4e4e7",color:"#71717a"},children:o},r);case"heading":var f,p=null==(f=e.attrs)?void 0:f.level,v=G(p)?p:1;return we("h"+Math.min(Math.max(v,1),6),{style:{margin:"12px 0 8px 0"},children:o},r);case"horizontalRule":return we("hr",{style:{margin:"12px 0",border:"none",borderTop:"1px solid #e4e4e7"}},r);default:return o.length>0?we("span",{children:o},r):null}}function et(e){var{richContent:t,content:i,isCustomer:r,primaryColor:n}=e,o=function(e,t){var i=Ve(Le++,7);return function(e,t){return!e||e.length!==t.length||t.some((function(t,i){return t!==e[i]}))}(i.__H,t)&&(i.__=e(),i.__H=t,i.__h=e),i.__}((()=>function(e,t){return{code:{fontFamily:'ui-monospace, SFMono-Regular, "SF Mono", Menlo, Consolas, "Liberation Mono", monospace',fontSize:"0.9em",padding:"2px 4px",borderRadius:"3px",background:e?"rgba(255, 255, 255, 0.2)":"rgba(0, 0, 0, 0.06)"},codeBlock:{fontFamily:'ui-monospace, SFMono-Regular, "SF Mono", Menlo, Consolas, "Liberation Mono", monospace',fontSize:"0.85em",padding:"8px 10px",borderRadius:"6px",background:e?"rgba(255, 255, 255, 0.15)":"#f4f4f5",overflowX:"auto",whiteSpace:"pre-wrap",wordWrap:"break-word",wordBreak:"break-word",margin:"8px 0",display:"block",lineHeight:1.5,border:e?"none":"1px solid #e4e4e7"},link:{color:e?"white":t,textDecoration:"underline"},image:{maxWidth:"100%",borderRadius:"4px",marginTop:"4px",marginBottom:"4px",display:"block"}}}(r,n)),[r,n]);if(t)try{if(function(e){if(!e||"object"!=typeof e)return!1;var t=e;return"doc"===t.type&&(X(t.content)||Y(t.content))}(t)){var s=Qe(t,o,0,"root");if(s)return s}}catch(e){}return function(e){if(!e)return we(b,{});var t=e.split("\n");return we(b,{children:t.map(((e,i)=>we(b,{children:[e,i<t.length-1&&we("br",{})]},i)))})}(i)}function tt(e){var{message:t,styles:r,primaryColor:n}=e,o="customer"===t.author_type,s=i({},r.message,o?r.messageCustomer:r.messageAgent),l=i({},r.messageContent,o?r.messageContentCustomer:r.messageContentAgent);return we("div",{style:s,children:[!o&&t.author_name&&we("div",{style:r.messageAuthor,children:t.author_name}),we("div",{style:l,children:we(et,{richContent:t.rich_content,content:t.content,isCustomer:o,primaryColor:n})}),we("div",{style:r.messageTime,children:_e(t.created_at)})]},t.id)}function it(e){var{styles:t,primaryColor:i,placeholderText:r,messages:n,inputValue:o,isLoading:s,error:l,onInputChange:a,onKeyDown:u,onSendMessage:d,messagesEndRef:c,inputRef:h}=e;return we(b,{children:[we("div",{style:t.messages,children:[n.map((e=>we(tt,{message:e,styles:t,primaryColor:i},e.id))),we("div",{ref:c})]}),l&&we("div",{style:t.error,children:l}),we("div",{style:t.inputContainer,children:[we("textarea",{ref:h,style:t.input,placeholder:r,value:o,onInput:a,onKeyDown:u,rows:1,disabled:s}),we(We,{primaryColor:i,inputValue:o,isLoading:s,handleSendMessage:d})]})]})}var rt=re("[ConversationsWidget]");class nt extends k{constructor(e){var i;super(e),i=this,this.L=null,this.F=null,this.q=()=>{this.setState((e=>({state:"open"===e.state?"closed":"open"})))},this.W=()=>{this.setState({state:"closed"})},this.D=e=>{this.props.onSelectTicket&&this.props.onSelectTicket(e)},this.B=()=>{this.props.onNewConversation&&this.props.onNewConversation()},this.N=()=>{this.props.onBackToTickets&&this.props.onBackToTickets()},this.P=()=>{this.setState((e=>{var t;return{view:"restore_request",restoreEmail:e.restoreEmail||(null==(t=e.userTraits)?void 0:t.email)||"",restoreEmailError:null,restoreRequestSuccess:!1}})),this.props.onViewChange&&this.props.onViewChange("restore_request")},this.A=()=>{var e=this.state.hasMultipleTickets?"tickets":"messages";this.setState({view:e,restoreEmailError:null,restoreRequestSuccess:!1}),this.props.onViewChange&&this.props.onViewChange(e)},this.U=e=>{var t=e.target;this.setState({inputValue:t.value})},this.O=e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),this.$())},this.H=e=>{var t=e.target;this.setState({formName:t.value})},this.V=e=>{var t=e.target;this.setState({formEmail:t.value,formEmailError:null})},this.j=e=>{var t=e.target;this.setState({restoreEmail:t.value,restoreEmailError:null,restoreRequestSuccess:!1})},this.Y=e=>{e.preventDefault();var{formEmail:t,formName:i}=this.state,{config:r,onIdentify:n}=this.props;if(!r.requireEmail||t.trim())if(!t.trim()||this.X(t.trim())){var o={};i.trim()&&(o.name=i.trim()),t.trim()&&(o.email=t.trim());var s=this.state.hasMultipleTickets?"tickets":"messages";this.setState({userTraits:o,view:s}),n&&n(o),this.props.onViewChange&&this.props.onViewChange(s)}else this.setState({formEmailError:"Please enter a valid email address"});else this.setState({formEmailError:"Email is required"})},this.G=function(){var e=t((function*(e){if(e.preventDefault(),i.props.onRequestRestoreLink){var t=i.state.restoreEmail.trim();if(t)if(i.X(t)){i.setState({restoreRequestLoading:!0,restoreEmailError:null});try{yield i.props.onRequestRestoreLink(t),i.setState({restoreRequestLoading:!1,restoreRequestSuccess:!0})}catch(e){rt.error("Failed to request restore link",e),i.setState({restoreRequestLoading:!1,restoreEmailError:e instanceof Error?e.message:"Failed to request restore link"})}}else i.setState({restoreEmailError:"Please enter a valid email address"});else i.setState({restoreEmailError:"Email is required"})}}));return function(t){return e.apply(this,arguments)}}(),this.$=t((function*(){var{inputValue:e}=i.state,t=e.trim();if(t){var r={id:"temp-"+Date.now(),content:t,author_type:"customer",author_name:"You",created_at:(new Date).toISOString(),is_private:!1};i.setState({messages:[...i.state.messages,r],inputValue:"",isLoading:!0,error:null});try{yield i.props.onSendMessage(t),i.setState({isLoading:!1})}catch(e){rt.error("Failed to send message",e),i.setState((t=>({isLoading:!1,error:e instanceof Error?e.message:"Failed to send message",messages:t.messages.filter((e=>e.id!==r.id))})))}}}));var r=e.initialUserTraits||null,n=this.K(e.config,r,e.isUserIdentified)?"identification":e.initialView||"messages";this.state={state:e.initialState||"closed",view:n,messages:[],tickets:e.initialTickets||[],ticketsLoading:!1,inputValue:"",isLoading:!1,error:null,formName:(null==r?void 0:r.name)||"",formEmail:(null==r?void 0:r.email)||"",formEmailError:null,userTraits:r,unreadCount:0,hasMultipleTickets:e.hasMultipleTickets||!1,restoreEmail:(null==r?void 0:r.email)||"",restoreEmailError:null,restoreRequestLoading:!1,restoreRequestSuccess:!1}}K(e,t,i){return!i&&(!!e.requireEmail&&(null==t||!t.email))}componentDidMount(){"messages"===this.state.view&&0===this.state.messages.length&&this.props.config.greetingText&&this.J()}componentDidUpdate(e,t){this.state.messages.length!==t.messages.length&&this.Z(),this.state.state!==t.state&&this.props.onStateChange&&this.props.onStateChange(this.state.state),"open"===this.state.state&&"open"!==t.state&&(this.ee(),this.Z())}J(){var e={id:"greeting",content:this.props.config.greetingText||"Hi! How can we help?",author_type:"AI",author_name:"Support",created_at:(new Date).toISOString(),is_private:!1};this.setState({messages:[e]})}Z(){this.L&&this.L.scrollIntoView({behavior:"smooth"})}ee(){this.F&&this.F.focus()}X(e){return/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e)}addMessages(e){this.setState((t=>{var i=new Set(t.messages.map((e=>e.id))),r=e.filter((e=>!i.has(e.id)));return r.length>0?{messages:[...t.messages,...r]}:null}))}show(){this.setState({state:"open"})}hide(){this.setState({state:"closed"})}getUserTraits(){return this.state.userTraits}setUserIdentified(){if("identification"===this.state.view){var e=this.state.hasMultipleTickets?"tickets":"messages";this.setState({view:e}),this.props.onViewChange&&this.props.onViewChange(e)}}setUnreadCount(e){this.setState({unreadCount:e})}updateTickets(e){this.setState({tickets:e,ticketsLoading:!1,hasMultipleTickets:e.length>1})}setView(e){this.setState({view:e}),this.props.onViewChange&&this.props.onViewChange(e)}getView(){return this.state.view}setTicketsLoading(e){this.setState({ticketsLoading:e})}clearMessages(e){void 0===e&&(e=!1),this.setState({messages:[]},(()=>{e&&this.props.config.greetingText&&this.J()}))}te(e){return we(Me,{config:this.props.config,styles:e,formName:this.state.formName,formEmail:this.state.formEmail,formEmailError:this.state.formEmailError,onNameChange:this.H,onEmailChange:this.V,onSubmit:this.Y})}ie(e){var t="restore_request"===this.state.view?this.A:this.N;return we("button",{style:e.backButton,onClick:t,"aria-label":"Back to conversations",children:we("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:we("polyline",{points:"15 18 9 12 15 6"})})})}re(e){var{tickets:t,ticketsLoading:i}=this.state;return we(Te,{tickets:t,isLoading:i,styles:e,onSelectTicket:this.D,onNewConversation:this.B,onOpenRestoreRequest:this.P})}ne(e,t,i){return we(it,{styles:e,primaryColor:t,placeholderText:i,messages:this.state.messages,inputValue:this.state.inputValue,isLoading:this.state.isLoading,error:this.state.error,onInputChange:this.U,onKeyDown:this.O,onSendMessage:this.$,messagesEndRef:e=>{this.L=e},inputRef:e=>{this.F=e}})}oe(e){return we(Re,{styles:e,restoreEmail:this.state.restoreEmail,restoreEmailError:this.state.restoreEmailError,restoreRequestLoading:this.state.restoreRequestLoading,restoreRequestSuccess:this.state.restoreRequestSuccess,onEmailChange:this.j,onSubmit:this.G})}se(e){switch(e){case"tickets":return"Conversations";case"restore_request":return"Restore conversations";case"identification":case"messages":return"Support Chat"}}le(e,t,i){switch(this.state.view){case"identification":return this.te(e);case"restore_request":return this.oe(e);case"tickets":return this.re(e);case"messages":return this.ne(e,t,i)}}render(){var{config:e}=this.props,{state:t,view:r}=this.state,n=e.color||"#5375ff",o=e.widgetPosition||"bottom_right",s=e.placeholderText||"Type your message...",l=ye(n,o);if("closed"===t)return we(be,{primaryColor:n,position:o,handleToggleOpen:this.q,unreadCount:this.state.unreadCount});var a=i({},l.window,l.windowOpen),u="messages"===r&&this.state.hasMultipleTickets||"restore_request"===r,d="tickets"===r||"messages"===r;return we("div",{style:l.widget,children:we("div",{style:a,children:[we("div",{style:l.header,children:[we("div",{style:u?l.headerWithBack:l.headerTitle,children:[u&&this.ie(l),we("span",{style:l.headerTitle,children:this.se(r)})]}),we("div",{style:l.headerActions,children:we(ke,{primaryColor:n,handleClose:this.W})})]}),this.le(l,n,s),d&&we("div",{style:l.recoverFooter,children:["Don't see your previous tickets?"," ",we("button",{type:"button",style:l.recoverFooterLink,onClick:this.P,children:"Recover them here"})]})]})})}}var ot={};function st(e,t,i){if(!(e=>X(e)||(e=>null===e)(e))(e)){if(Y(e))return function(e,t,i){if(Y(e))if(Z&&e.forEach===Z)e.forEach(t,i);else if("length"in e&&e.length===+e.length)for(var r=0,n=e.length;r<n;r++)if(r in e&&t.call(i,e[r],r)===ot)return}(e,t,i);if((e=>e instanceof FormData)(e)){for(var r of e.entries())if(t.call(i,r[1],r[0])===ot)return}else for(var n in e)if(V.call(e,n)&&t.call(i,e[n],n)===ot)return}}var lt=function(e,t){var i,r;void 0===t&&(t="&");var n=[];return st(e,(function(e,t){X(e)||X(t)||"undefined"===t||(i=encodeURIComponent((e=>e instanceof File)(e)?e.name:e.toString()),r=encodeURIComponent(t),n[n.length]=r+"="+i)})),n.join(t)},at=re("[ConversationsManager]"),ut="ph_conv_restore";function dt(){var e;if(null==K||null==(e=K.location)||!e.search)return null;try{var t=new URLSearchParams(K.location.search).get(ut);return(null==t?void 0:t.trim())||null}catch(e){return at.warn("Failed to parse restore token from URL",e),null}}function ct(){var e;if(null!=K&&K.location&&null!=K&&null!=(e=K.history)&&e.replaceState)try{var t=new URL(K.location.href);t.searchParams.delete(ut);var i=""+t.pathname+t.search+t.hash;K.history.replaceState(K.history.state,"",i)}catch(e){at.warn("Failed to clear restore token from URL",e)}}var ht=re("[ConversationsManager]"),ft="ph-conversations-widget-container",pt=null;class vt{constructor(e,i){var r=this;this.ae=null,this.ue=null,this.de=null,this.ce=null,this.he=null,this.fe=!1,this.pe=!1,this.ve=null,this.ge=0,this.me="closed",this.ye=!1,this.xe=!1,this.we=null,this.be="messages",this.ke=[],this._e=!1,this.Se=e=>{this.Ce.saveUserTraits(e),this._posthog.capture("$conversations_user_identified",{hasName:!!e.name,hasEmail:!!e.email})},this.Ee=function(){var e=t((function*(e){var t=yield r.requestRestoreLink(e);return r._posthog.capture("$conversations_restore_link_requested",{hasEmail:!!e}),t}));return function(t){return e.apply(this,arguments)}}(),this.$=function(){var e=t((function*(e){var t,i=(null==(t=r.ae)?void 0:t.getUserTraits())||void 0;try{yield r.sendMessage(e,i),setTimeout((()=>r.Ie()),1e3)}catch(e){throw ht.error("Failed to send message",e),e}}));return function(t){return e.apply(this,arguments)}}(),this.Te=e=>{this.me=e,ht.info("Widget state changed",{state:e,view:this.be}),this._posthog.capture("$conversations_widget_state_changed",{state:e,view:this.be,ticketId:this.de}),this.Ce.saveWidgetState(e),"open"===e&&"messages"===this.be&&this.ge>0&&this.de&&this.Me()},this.Ie=t((function*(){if(!r.fe&&r.de){r.fe=!0;try{yield r.Re()}finally{r.fe=!1}}})),this.Le=t((function*(){if(!r.pe){r.pe=!0;try{yield r.Fe()}finally{r.pe=!1}}})),this.qe=t((function*(){"restore_request"!==r.be&&("messages"===r.be?yield r.Ie():yield r.Le())})),this.ze=e=>{ht.info("View changed",{from:this.be,to:e}),this.be=e},this.D=function(){var e=t((function*(e){var t,i;r.We(e),r.he=null,null==(t=r.ae)||t.clearMessages(),r.be="messages",null==(i=r.ae)||i.setView("messages"),yield r.Re(),r.De()&&r.ge>0&&r.Me()}));return function(t){return e.apply(this,arguments)}}(),this.B=()=>{var e,t;ht.info("New conversation requested"),this.de=null,this.Ce.clearTicketId(),this.he=null,this.be="messages",null==(e=this.ae)||e.setView("messages"),null==(t=this.ae)||t.clearMessages(!0)},this.N=t((function*(){var e,t;ht.info("Back to tickets requested"),r.be="tickets",null==(e=r.ae)||e.setView("tickets"),null==(t=r.ae)||t.setTicketsLoading(!0),yield r.Fe(),r._posthog.capture("$conversations_back_to_tickets")})),this._posthog=i,this.Be=e,this.Ce=new ge(i),this.Ne=this.Ce.getOrCreateWidgetSessionId(),this.Pe=!0===e.widgetEnabled,this.Ae=function(e){var t;if(!e||0===e.length)return!0;var i=null==K||null==(t=K.location)?void 0:t.hostname;return!i||e.some((e=>{var t=function(e){var t=e.replace(/^https?:\/\//,"");return(t=t.split("/")[0].split("?")[0].split(":")[0])||null}(e);if(!t)return!1;if(t.startsWith("*.")){var r=t.slice(2);return i.endsWith("."+r)||i===r}return i===t}))}(e.domains),ht.info("ConversationsManager initialized",{config:e,widgetSessionId:this.Ne,isWidgetEnabled:this.Pe,isDomainAllowed:this.Ae}),this.Ue()}sendMessage(e,i,r){var n=this;return t((function*(){var t=r?null:n.de,o=!t,s=n.Be.token;return new Promise(((l,a)=>{var u,d=n._posthog.get_distinct_id(),c=(null==(u=n._posthog.persistence)?void 0:u.props)||{},h=(null==i?void 0:i.name)||c.$name||c.name||null,f=(null==i?void 0:i.email)||c.$email||c.email||null,p={widget_session_id:n.Ne,distinct_id:d,message:e.trim(),traits:{name:h,email:f},ticket_id:t};try{var v,g=n._posthog.get_session_id();g&&(p.session_id=g);var m=n._posthog.get_session_replay_url({withTimestamp:!0,timestampLookBack:30}),y=o?null==K||null==(v=K.location)?void 0:v.href:void 0;(m||y)&&(p.session_context={session_replay_url:m||void 0,current_url:y||void 0})}catch(e){ht.warn("Failed to capture session context",e)}n._posthog._send_request({url:n._posthog.requestRouter.endpointFor("api","/api/conversations/v1/widget/message"),method:"POST",data:p,headers:{"X-Conversations-Token":s},callback:t=>{if(429!==t.statusCode){if(200!==t.statusCode&&201!==t.statusCode){var i,s,u=(null==(i=t.json)?void 0:i.detail)||(null==(s=t.json)?void 0:s.message)||"Failed to send message";return ht.error("Failed to send message",{status:t.statusCode}),void a(new Error(u))}if(t.json){var d=t.json;o&&d.ticket_id&&(n.de=d.ticket_id,n.Ce.saveTicketId(d.ticket_id),ht.info("New ticket created",{ticketId:d.ticket_id,forced:!0===r})),n._posthog.capture("$conversations_message_sent",{ticketId:d.ticket_id,isNewTicket:o,messageLength:e.length}),n.he=d.created_at,l(d)}else a(new Error("Invalid response from server"))}else a(new Error("Too many requests. Please wait before trying again."))}})}))}))()}We(e){e&&e!==this.de&&(this.de=e,this.Ce.saveTicketId(e),this.he=null)}getMessages(e,i){var r=this;return t((function*(){var t=e||r.de;if(!t)throw new Error("No ticket ID provided and no active conversation");r.We(e);var n=r.Be.token;return new Promise(((e,o)=>{var s={widget_session_id:r.Ne,limit:"50"};i&&(s.after=i),r._posthog._send_request({url:r._posthog.requestRouter.endpointFor("api","/api/conversations/v1/widget/messages/"+t+"?"+lt(s)),method:"GET",headers:{"X-Conversations-Token":n},callback:t=>{if(429!==t.statusCode){if(200!==t.statusCode){var i,r,n=(null==(i=t.json)?void 0:i.detail)||(null==(r=t.json)?void 0:r.message)||"Failed to fetch messages";return ht.error("Failed to fetch messages",{status:t.statusCode}),void o(new Error(n))}if(t.json){var s=t.json;e(s)}else o(new Error("Invalid response from server"))}else o(new Error("Too many requests. Please wait before trying again."))}})}))}))()}markAsRead(e){var i=this;return t((function*(){var t=e||i.de;if(!t)throw new Error("No ticket ID provided and no active conversation");i.We(e);var r=i.Be.token;return ht.info("Marking messages as read",{ticketId:t}),new Promise(((e,n)=>{i._posthog._send_request({url:i._posthog.requestRouter.endpointFor("api","/api/conversations/v1/widget/messages/"+t+"/read"),method:"POST",data:{widget_session_id:i.Ne},headers:{"X-Conversations-Token":r},callback:t=>{if(429!==t.statusCode){if(200!==t.statusCode){var i,r,o=(null==(i=t.json)?void 0:i.detail)||(null==(r=t.json)?void 0:r.message)||"Failed to mark messages as read";return ht.error("Failed to mark messages as read",{status:t.statusCode}),void n(new Error(o))}if(t.json){var s=t.json;e(s)}else n(new Error("Invalid response from server"))}else n(new Error("Too many requests. Please wait before trying again."))}})}))}))()}Ue(){if(ee&&K){var e=dt();if(e&&!this.xe)return this.xe=!0,ct(),setTimeout(ct,0),void this.Oe(e).catch((e=>{ht.warn("Failed to restore conversations from URL token",e)})).finally((()=>{ct(),this.$e()}));this.$e()}else ht.info("Conversations not available: Document or window not available")}$e(){this.xe=!0,this.de=this.Ce.loadTicketId(),ht.info("Loaded ticket ID from storage",{ticketId:this.de}),this._posthog.capture("$conversations_loaded",{hasExistingTicket:!!this.de,widgetEnabled:this.Pe,domainAllowed:this.Ae}),this.Pe&&this.Ae?this.He():ht.info("Widget not rendered",{widgetEnabled:this.Pe,domainAllowed:this.Ae}),this.Ve()}Oe(e){var i=this;return t((function*(){try{return yield i.je(e)}catch(t){return ht.warn("Restore token exchange failed, retrying once",t),yield i.je(e)}}))()}je(e){var i=this;return t((function*(){var t,r,n=i.Be.token,o={restore_token:e,widget_session_id:i.Ne,distinct_id:i._posthog.get_distinct_id(),current_url:null==K||null==(t=K.location)?void 0:t.href},s=yield new Promise(((e,t)=>{i._posthog._send_request({url:i._posthog.requestRouter.endpointFor("api","/api/conversations/v1/widget/restore"),method:"POST",data:o,headers:{"X-Conversations-Token":n},callback:i=>{if(429!==i.statusCode)if(200===i.statusCode)i.json?e(i.json):t(new Error("Invalid response from server"));else{var r,n,o,s=(null==(r=i.json)?void 0:r.error)||(null==(n=i.json)?void 0:n.detail)||(null==(o=i.json)?void 0:o.message)||"Failed to restore conversations";t(new Error(s))}else t(new Error("Too many requests. Please wait before trying again."))}})}));return"success"!==s.status?(ht.info("Restore token was not accepted",{status:s.status,code:s.code}),s):(i.he=null,i.ge=0,s.widget_session_id&&(i.Ne=s.widget_session_id,i.Ce.setWidgetSessionId(s.widget_session_id)),null!=(r=s.migrated_ticket_ids)&&r.length?(i.de=s.migrated_ticket_ids[0],i.Ce.saveTicketId(i.de),i.Ie(),i.Le()):(i.de=null,i.Ce.clearTicketId()),s)}))()}He(){return this.ye?Promise.resolve():(this.we||(this.we=this.Ye()),this.we)}Ye(){var e=this;return t((function*(){var t="open"===e.Ce.loadWidgetState()?"open":"closed";e.me=t;var i=e.Xe(),{view:r,tickets:n}=yield e.Ge();e.be=r,e.Ke(t,i,r,n),e.ye=!0,e._posthog.capture("$conversations_widget_loaded",{hasExistingTicket:!!e.de,initialState:t,initialView:r,ticketCount:n.length,hasUserTraits:!!i}),e.Je()}))()}Xe(){var e,t=(null==(e=this._posthog.persistence)?void 0:e.props)||{},i=t.$name||t.name,r=t.$email||t.email;if(i||r)return{name:i||void 0,email:r||void 0};var n=this.Ce.loadUserTraits();return n&&(n.name||n.email)?n:null}Me(){var e=this;return t((function*(){if(e.de)try{var t,i=yield e.markAsRead(e.de);e.ge=i.unread_count,null==(t=e.ae)||t.setUnreadCount(0),ht.info("Messages marked as read",{unreadCount:i.unread_count})}catch(e){ht.error("Failed to mark messages as read",e)}}))()}Re(){var e=this;return t((function*(){if(e.de)try{var t,i=yield e.getMessages(e.de,e.he||void 0);if(G(i.unread_count))e.ge=i.unread_count,null==(t=e.ae)||t.setUnreadCount(i.unread_count),i.unread_count>0&&e.De()&&e.Me();if(i.messages.length>0){var r;null==(r=e.ae)||r.addMessages(i.messages);var n=i.messages[i.messages.length-1];e.he=n.created_at}}catch(e){ht.error("Failed to load messages",e)}}))()}De(){return"open"===this.me}Fe(){var e=this;return t((function*(){try{var t,i,r=yield e.getTickets();e.ke=r.results,e._e=r.results.length>1,null==(t=e.ae)||t.updateTickets(r.results);var n=r.results.reduce(((e,t)=>e+(t.unread_count||0)),0);e.ge=n,null==(i=e.ae)||i.setUnreadCount(n),ht.info("Tickets loaded",{count:r.results.length,totalUnread:n})}catch(e){ht.error("Failed to load tickets",e)}}))()}Ge(){var e=this;return t((function*(){try{var t=yield e.getTickets();e.ke=t.results,e._e=t.results.length>1;var i=t.results.reduce(((e,t)=>e+(t.unread_count||0)),0);return e.ge=i,t.results.length>=2?{view:"tickets",tickets:t.results}:(1===t.results.length&&(e.de=t.results[0].id,e.Ce.saveTicketId(t.results[0].id)),{view:"messages",tickets:t.results})}catch(e){return ht.error("Failed to determine initial view",e),{view:"messages",tickets:[]}}}))()}Je(){this.ce||(this.qe(),this.ce=null==K?void 0:K.setInterval((()=>{this.qe()}),5e3),ht.info("Started polling",{view:this.be}))}Ze(){this.ce&&(null==K||K.clearInterval(this.ce),this.ce=null,ht.info("Stopped polling for messages"))}Ve(){this.ve=this._posthog.on("eventCaptured",(e=>{var t;"$identify"===e.event&&(null==(t=this.ae)||t.setUserIdentified())}))}show(){this.Ae?this.ye||this.He():ht.warn("Cannot show widget: current domain is not allowed")}hide(){this.Ze(),this.ue&&(U(null,this.ue),this.ue.remove(),this.ue=null),this.ae=null,this.ye=!1,this.we=null,this.he=null}isVisible(){return this.ye}getTickets(e){var i=this;return t((function*(){var t,r,n=i.Be.token,o={widget_session_id:i.Ne,limit:String(null!==(t=null==e?void 0:e.limit)&&void 0!==t?t:20),offset:String(null!==(r=null==e?void 0:e.offset)&&void 0!==r?r:0)};return null!=e&&e.status&&(o.status=e.status),new Promise(((e,t)=>{i._posthog._send_request({url:i._posthog.requestRouter.endpointFor("api","/api/conversations/v1/widget/tickets?"+lt(o)),method:"GET",headers:{"X-Conversations-Token":n},callback:i=>{if(429!==i.statusCode){if(200!==i.statusCode){var r,n,o=(null==(r=i.json)?void 0:r.detail)||(null==(n=i.json)?void 0:n.message)||"Failed to fetch tickets";return ht.error("Failed to fetch tickets",{status:i.statusCode}),void t(new Error(o))}if(i.json){var s=i.json;e(s)}else t(new Error("Invalid response from server"))}else t(new Error("Too many requests. Please wait before trying again."))}})}))}))()}requestRestoreLink(e){var i=this;return t((function*(){var t,r=e.trim().toLowerCase();if(!r)throw new Error("Email is required");var n=i.Be.token,o={email:r,request_url:(null==K||null==(t=K.location)?void 0:t.href)||""};return new Promise(((e,t)=>{i._posthog._send_request({url:i._posthog.requestRouter.endpointFor("api","/api/conversations/v1/widget/restore/request"),method:"POST",data:o,headers:{"X-Conversations-Token":n},callback:i=>{if(429!==i.statusCode)if(200===i.statusCode)e({ok:!0});else{var r,n,o,s=(null==(r=i.json)?void 0:r.error)||(null==(n=i.json)?void 0:n.detail)||(null==(o=i.json)?void 0:o.message)||"Failed to request restore link";t(new Error(s))}else t(new Error("Too many requests. Please wait before trying again."))}})}))}))()}restoreFromToken(e){var i=this;return t((function*(){var t=e.trim();if(!t)throw new Error("Restore token is required");try{return yield i.Oe(t)}finally{ct()}}))()}restoreFromUrlToken(){var e=this;return t((function*(){var t=dt();if(!t)return null;try{return yield e.restoreFromToken(t)}finally{ct()}}))()}getCurrentTicketId(){return this.de}getWidgetSessionId(){return this.Ne}destroy(){this.Ze(),this.ve&&(this.ve(),this.ve=null),this.ue&&(U(null,this.ue),this.ue.remove(),this.ue=null),this.ae=null,pt===this&&(pt=null),ht.info("Widget destroyed")}reset(){this.Ce.clearAll(),this.de=null,this.he=null,this.ge=0,this.destroy(),ht.info("Conversations reset")}Ke(e,t,i,r){if(void 0===i&&(i="messages"),void 0===r&&(r=[]),ee){var n=ee.getElementById(ft);if(!n){if(!ee.body)return void ht.info("Conversations widget not rendered: Document body not available yet");(n=ee.createElement("div")).id=ft,ee.body.appendChild(n)}this.ue=n,U(we(nt,{ref:e=>{this.ae=e},config:this.Be,initialState:e,initialUserTraits:t,isUserIdentified:this._posthog._isIdentified(),initialView:i,initialTickets:r,hasMultipleTickets:this._e,onSendMessage:this.$,onStateChange:this.Te,onIdentify:this.Se,onRequestRestoreLink:this.Ee,onSelectTicket:this.D,onNewConversation:this.B,onBackToTickets:this.N,onViewChange:this.ze}),n)}else ht.info("Conversations widget not rendered: Document not available")}}function gt(e,t){return pt?(ht.info("ConversationsManager already exists, reusing singleton"),pt):(ht.info("initConversations called",{hasConfig:!!e,hasPosthog:!!t}),pt=new vt(e,t))}te.__PosthogExtensions__=te.__PosthogExtensions__||{},te.__PosthogExtensions__.initConversations=gt}();
//# sourceMappingURL=conversations.js.map
