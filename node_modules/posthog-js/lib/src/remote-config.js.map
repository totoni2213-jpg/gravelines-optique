{"version":3,"file":"remote-config.js","sourceRoot":"","sources":["../../src/remote-config.ts"],"names":[],"mappings":"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","sourcesContent":["import { PostHog } from './posthog-core'\nimport { RemoteConfig } from './types'\n\nimport { createLogger } from './utils/logger'\nimport { assignableWindow, document } from './utils/globals'\n\nconst logger = createLogger('[RemoteConfig]')\n\n// Refresh interval for feature flags in long-running sessions.\n// 5 minutes balances freshness with server load - flags typically don't change\n// frequently, and most sessions are shorter than this anyway.\nconst REFRESH_INTERVAL = 5 * 60 * 1000\n\nexport class RemoteConfigLoader {\n    private _refreshInterval: ReturnType<typeof setInterval> | undefined\n\n    constructor(private readonly _instance: PostHog) {}\n\n    get remoteConfig(): RemoteConfig | undefined {\n        return assignableWindow._POSTHOG_REMOTE_CONFIG?.[this._instance.config.token]?.config\n    }\n\n    private _loadRemoteConfigJs(cb: (config?: RemoteConfig) => void): void {\n        if (assignableWindow.__PosthogExtensions__?.loadExternalDependency) {\n            assignableWindow.__PosthogExtensions__?.loadExternalDependency?.(this._instance, 'remote-config', () => {\n                return cb(this.remoteConfig)\n            })\n        } else {\n            cb()\n        }\n    }\n\n    private _loadRemoteConfigJSON(cb: (config?: RemoteConfig) => void): void {\n        this._instance._send_request({\n            method: 'GET',\n            url: this._instance.requestRouter.endpointFor('assets', `/array/${this._instance.config.token}/config`),\n            callback: (response) => {\n                cb(response.json as RemoteConfig | undefined)\n            },\n        })\n    }\n\n    load(): void {\n        try {\n            // Attempt 1 - use the pre-loaded config if it came as part of the token-specific array.js\n            if (this.remoteConfig) {\n                logger.info('Using preloaded remote config', this.remoteConfig)\n                this._onRemoteConfig(this.remoteConfig)\n                this._startRefreshInterval()\n                return\n            }\n\n            if (this._instance._shouldDisableFlags()) {\n                // This setting is essentially saying \"dont call external APIs\" hence we respect it here\n                logger.warn('Remote config is disabled. Falling back to local config.')\n                return\n            }\n\n            // Attempt 2 - if we have the external deps loader then lets load the script version of the config that includes site apps\n            this._loadRemoteConfigJs((config) => {\n                if (!config) {\n                    logger.info('No config found after loading remote JS config. Falling back to JSON.')\n                    // Attempt 3 Load the config json instead of the script - we won't get site apps etc. but we will get the config\n                    this._loadRemoteConfigJSON((config) => {\n                        this._onRemoteConfig(config)\n                        this._startRefreshInterval()\n                    })\n                    return\n                }\n\n                this._onRemoteConfig(config)\n                this._startRefreshInterval()\n            })\n        } catch (error) {\n            logger.error('Error loading remote config', error)\n        }\n    }\n\n    stop(): void {\n        if (this._refreshInterval) {\n            clearInterval(this._refreshInterval)\n            this._refreshInterval = undefined\n        }\n    }\n\n    /**\n     * Refresh feature flags for long-running sessions.\n     * Calls reloadFeatureFlags() directly rather than re-fetching config â€” the initial\n     * config load already determined whether flags are enabled, and reloadFeatureFlags()\n     * is a no-op when flags are disabled. This avoids an unnecessary network round-trip.\n     */\n    refresh(): void {\n        if (this._instance._shouldDisableFlags() || document?.visibilityState === 'hidden') {\n            return\n        }\n\n        this._instance.featureFlags.reloadFeatureFlags()\n    }\n\n    private _startRefreshInterval(): void {\n        if (this._refreshInterval) {\n            return\n        }\n\n        this._refreshInterval = setInterval(() => {\n            this.refresh()\n        }, REFRESH_INTERVAL)\n    }\n\n    private _onRemoteConfig(config?: RemoteConfig): void {\n        if (!config) {\n            logger.error('Failed to fetch remote config from PostHog.')\n        }\n\n        // Config and flags are loaded separately: config from /array/{token}/config,\n        // flags from /flags/?v=2. Features like surveys, session recording, and product\n        // tours reference flags in their config (e.g. survey.linked_flag_key), but this\n        // is safe because those flag checks happen lazily at runtime (e.g. when deciding\n        // whether to show a survey), not during config processing. By the time a linked\n        // flag is evaluated, flags have already loaded.\n        //\n        // Even when config fails, we pass an empty object so extensions (autocapture,\n        // session recording, etc.) still initialize with their defaults.\n        this._instance._onRemoteConfig(config ?? ({} as RemoteConfig))\n\n        if (config?.hasFeatureFlags !== false) {\n            if (!this._instance.config.advanced_disable_feature_flags_on_first_load) {\n                this._instance.featureFlags.ensureFlagsLoaded()\n            }\n        }\n    }\n}\n"]}