{"version":3,"file":"RichContent.js","sourceRoot":"","sources":["../../../../../../src/extensions/conversations/external/components/RichContent.tsx"],"names":[],"mappings":"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","sourcesContent":["// eslint-disable-next-line @typescript-eslint/no-unused-vars\nimport { h, Fragment } from 'preact'\nimport { useMemo } from 'preact/hooks'\nimport { isUndefined, isNumber, isArray } from '@posthog/core'\nimport { TipTapDoc, TipTapNode, TipTapMark } from '../../../../posthog-conversations-types'\n\ninterface RichContentProps {\n    /** Rich content in TipTap JSON format (preferred) */\n    richContent?: TipTapDoc\n    /** Plain text fallback if rich_content is missing or invalid */\n    content: string\n    /** Whether message is from customer (affects styling) */\n    isCustomer: boolean\n    /** Primary color for links */\n    primaryColor: string\n}\n\n/**\n * Sanitize URL to prevent javascript: and other dangerous protocols.\n * Only allows http:, https:, mailto:, tel:, and relative URLs.\n *\n * Security measures:\n * - Removes ASCII control characters (0x00-0x1F, 0x7F) that could obfuscate protocols\n * - Removes Unicode whitespace and zero-width characters\n * - Collapses whitespace when checking protocols to prevent \"java script:\" bypasses\n * - Blocks javascript:, vbscript:, data:, and file: protocols\n * - Blocks protocol-relative URLs (//example.com)\n */\nfunction sanitizeUrl(url: string): string | undefined {\n    if (!url || typeof url !== 'string') {\n        return undefined\n    }\n\n    // Remove ASCII control characters (0x00-0x1F, 0x7F DEL) that could obfuscate protocols\n    // Also remove zero-width characters (U+200B-U+200D, U+FEFF) that could be used for obfuscation\n    // eslint-disable-next-line no-control-regex\n    const cleanedUrl = url.replace(/[\\x00-\\x1f\\x7f\\u200b-\\u200d\\ufeff]/g, '')\n    const trimmedUrl = cleanedUrl.trim()\n    if (!trimmedUrl) {\n        return undefined\n    }\n\n    // Collapse all whitespace (including Unicode whitespace) when checking protocol\n    // This prevents bypasses like \"java script:\" or \"java\\u00A0script:\" (non-breaking space)\n    const normalizedForCheck = trimmedUrl.replace(/\\s+/g, '').toLowerCase()\n\n    // Block dangerous protocols\n    if (\n        normalizedForCheck.startsWith('javascript:') ||\n        normalizedForCheck.startsWith('vbscript:') ||\n        normalizedForCheck.startsWith('data:') ||\n        normalizedForCheck.startsWith('file:')\n    ) {\n        return undefined\n    }\n\n    // Allow relative URLs (check against trimmed URL, not normalized)\n    // Note: We explicitly check for '//' first to block protocol-relative URLs (e.g., //evil.com)\n    // which could be used to load content from attacker-controlled domains\n    if (trimmedUrl.startsWith('//')) {\n        return undefined\n    }\n    if (\n        trimmedUrl.startsWith('/') ||\n        trimmedUrl.startsWith('./') ||\n        trimmedUrl.startsWith('../') ||\n        trimmedUrl.startsWith('#')\n    ) {\n        return trimmedUrl\n    }\n\n    // Allow safe absolute URLs\n    const lowerUrl = trimmedUrl.toLowerCase()\n    if (\n        lowerUrl.startsWith('http://') ||\n        lowerUrl.startsWith('https://') ||\n        lowerUrl.startsWith('mailto:') ||\n        lowerUrl.startsWith('tel:')\n    ) {\n        return trimmedUrl\n    }\n\n    return undefined\n}\n\n/** Maximum recursion depth to prevent stack overflow */\nconst MAX_DEPTH = 20\n\nfunction getStyles(isCustomer: boolean, primaryColor: string) {\n    return {\n        code: {\n            fontFamily: 'ui-monospace, SFMono-Regular, \"SF Mono\", Menlo, Consolas, \"Liberation Mono\", monospace',\n            fontSize: '0.9em',\n            padding: '2px 4px',\n            borderRadius: '3px',\n            background: isCustomer ? 'rgba(255, 255, 255, 0.2)' : 'rgba(0, 0, 0, 0.06)',\n        },\n        codeBlock: {\n            fontFamily: 'ui-monospace, SFMono-Regular, \"SF Mono\", Menlo, Consolas, \"Liberation Mono\", monospace',\n            fontSize: '0.85em',\n            padding: '8px 10px',\n            borderRadius: '6px',\n            background: isCustomer ? 'rgba(255, 255, 255, 0.15)' : '#f4f4f5',\n            overflowX: 'auto' as const,\n            whiteSpace: 'pre-wrap' as const,\n            wordWrap: 'break-word' as const,\n            wordBreak: 'break-word' as const,\n            margin: '8px 0',\n            display: 'block',\n            lineHeight: 1.5,\n            border: isCustomer ? 'none' : '1px solid #e4e4e7',\n        },\n        link: {\n            color: isCustomer ? 'white' : primaryColor,\n            textDecoration: 'underline',\n        },\n        image: {\n            maxWidth: '100%',\n            borderRadius: '4px',\n            marginTop: '4px',\n            marginBottom: '4px',\n            display: 'block',\n        },\n    }\n}\n\n/**\n * Render a text node with its marks (bold, italic, underline, etc.)\n * Marks are applied by wrapping the content in nested elements.\n */\nfunction renderTextWithMarks(\n    text: string,\n    marks: TipTapMark[] | undefined,\n    styles: ReturnType<typeof getStyles>,\n    key: string\n): preact.JSX.Element {\n    if (!marks || marks.length === 0) {\n        return <span key={key}>{text}</span>\n    }\n\n    // Build the element by wrapping with marks from inside out\n    let element: preact.JSX.Element = <>{text}</>\n\n    for (const mark of marks) {\n        switch (mark.type) {\n            case 'bold':\n                element = <strong style={{ fontWeight: 700 }}>{element}</strong>\n                break\n            case 'italic':\n                element = <em style={{ fontStyle: 'italic' }}>{element}</em>\n                break\n            case 'underline':\n                element = <u style={{ textDecoration: 'underline' }}>{element}</u>\n                break\n            case 'strike':\n                element = <s style={{ textDecoration: 'line-through' }}>{element}</s>\n                break\n            case 'code':\n                element = <code style={styles.code}>{element}</code>\n                break\n            case 'link': {\n                const href = mark.attrs?.href\n                const safeUrl = typeof href === 'string' ? sanitizeUrl(href) : undefined\n                if (safeUrl) {\n                    element = (\n                        <a\n                            href={safeUrl}\n                            target=\"_blank\"\n                            rel=\"noopener noreferrer\"\n                            referrerPolicy=\"no-referrer\"\n                            style={styles.link}\n                        >\n                            {element}\n                        </a>\n                    )\n                }\n                break\n            }\n            // Ignore unknown mark types for safety\n        }\n    }\n\n    return <span key={key}>{element}</span>\n}\n\n/**\n * Recursively render a TipTap node and its children\n */\nfunction renderNode(\n    node: TipTapNode | TipTapDoc,\n    styles: ReturnType<typeof getStyles>,\n    depth: number,\n    key: string\n): preact.JSX.Element | null {\n    // Safety: prevent infinite recursion\n    if (depth > MAX_DEPTH) {\n        return null\n    }\n\n    // Text node with optional marks\n    if (node.type === 'text' && !isUndefined(node.text)) {\n        return renderTextWithMarks(node.text, node.marks, styles, key)\n    }\n\n    // Render children recursively\n    const children = node.content?.map((child, index) => renderNode(child, styles, depth + 1, `${key}-${index}`)) || []\n\n    switch (node.type) {\n        case 'doc':\n            return <>{children}</>\n\n        case 'paragraph':\n            return (\n                <p key={key} style={{ margin: '0 0 8px 0' }}>\n                    {children.length > 0 ? children : <br />}\n                </p>\n            )\n\n        case 'hardBreak':\n            return <br key={key} />\n\n        case 'codeBlock': {\n            // Code blocks store text in content[0].text\n            const codeText = node.content?.[0]?.text || ''\n            return (\n                <pre key={key} style={styles.codeBlock}>\n                    <code>{codeText}</code>\n                </pre>\n            )\n        }\n\n        case 'image': {\n            const src = node.attrs?.src\n            const alt = node.attrs?.alt\n            const safeUrl = typeof src === 'string' ? sanitizeUrl(src) : undefined\n            if (!safeUrl) {\n                return null\n            }\n            return (\n                <img\n                    key={key}\n                    src={safeUrl}\n                    alt={typeof alt === 'string' ? alt : ''}\n                    style={styles.image}\n                    onError={(e) => {\n                        ;(e.target as HTMLImageElement).style.display = 'none'\n                    }}\n                />\n            )\n        }\n\n        case 'bulletList':\n            return (\n                <ul key={key} style={{ margin: '8px 0', paddingLeft: '24px' }}>\n                    {children}\n                </ul>\n            )\n\n        case 'orderedList':\n            return (\n                <ol key={key} style={{ margin: '8px 0', paddingLeft: '24px' }}>\n                    {children}\n                </ol>\n            )\n\n        case 'listItem':\n            return (\n                <li key={key} style={{ margin: '4px 0' }}>\n                    {children}\n                </li>\n            )\n\n        case 'blockquote':\n            return (\n                <blockquote\n                    key={key}\n                    style={{\n                        margin: '8px 0',\n                        paddingLeft: '12px',\n                        borderLeft: '3px solid #e4e4e7',\n                        color: '#71717a',\n                    }}\n                >\n                    {children}\n                </blockquote>\n            )\n\n        case 'heading': {\n            const rawLevel = node.attrs?.level\n            const level = isNumber(rawLevel) ? rawLevel : 1\n            const HeadingTag = `h${Math.min(Math.max(level, 1), 6)}` as 'h1' | 'h2' | 'h3' | 'h4' | 'h5' | 'h6'\n            return (\n                <HeadingTag key={key} style={{ margin: '12px 0 8px 0' }}>\n                    {children}\n                </HeadingTag>\n            )\n        }\n\n        case 'horizontalRule':\n            return <hr key={key} style={{ margin: '12px 0', border: 'none', borderTop: '1px solid #e4e4e7' }} />\n\n        default:\n            // Unknown node types: render children if any, otherwise ignore\n            if (children.length > 0) {\n                return <span key={key}>{children}</span>\n            }\n            return null\n    }\n}\n\n/**\n * Validate that the content looks like a valid TipTap document\n */\nfunction isValidTipTapDoc(doc: unknown): doc is TipTapDoc {\n    if (!doc || typeof doc !== 'object') {\n        return false\n    }\n    const d = doc as TipTapDoc\n    return d.type === 'doc' && (isUndefined(d.content) || isArray(d.content))\n}\n\n/**\n * Render plain text with line breaks preserved\n */\nfunction renderPlainText(text: string): preact.JSX.Element {\n    if (!text) {\n        return <></>\n    }\n    const lines = text.split('\\n')\n    return (\n        <>\n            {lines.map((line, index) => (\n                <Fragment key={index}>\n                    {line}\n                    {index < lines.length - 1 && <br />}\n                </Fragment>\n            ))}\n        </>\n    )\n}\n\n/**\n * RichContent component - renders TipTap JSON content with plain text fallback\n *\n * Rendering logic:\n * 1. If richContent is present and valid, render as TipTap tree\n * 2. If richContent is missing or invalid, fall back to plain text content\n * 3. Wrap TipTap rendering in try/catch for safety\n */\nexport function RichContent({ richContent, content, isCustomer, primaryColor }: RichContentProps) {\n    const styles = useMemo(() => getStyles(isCustomer, primaryColor), [isCustomer, primaryColor])\n\n    // Try to render rich content if available\n    if (richContent) {\n        try {\n            if (isValidTipTapDoc(richContent)) {\n                const rendered = renderNode(richContent, styles, 0, 'root')\n                if (rendered) {\n                    return rendered\n                }\n            }\n        } catch {\n            // Fall through to plain text on any error\n        }\n    }\n\n    // Fallback: render plain text content\n    return renderPlainText(content)\n}\n"]}