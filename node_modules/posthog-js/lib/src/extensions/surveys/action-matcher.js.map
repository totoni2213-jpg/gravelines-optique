{"version":3,"file":"action-matcher.js","sourceRoot":"","sources":["../../../../src/extensions/surveys/action-matcher.ts"],"names":[],"mappings":"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","sourcesContent":["import { PostHog } from '../../posthog-core'\nimport { ActionStepType, PropertyFilters, SurveyActionType, SurveyElement } from '../../posthog-surveys-types'\nimport { SimpleEventEmitter } from '../../utils/simple-event-emitter'\nimport { CaptureResult, PropertyMatchType } from '../../types'\nimport { isArray, isUndefined } from '@posthog/core'\nimport { matchPropertyFilters } from '../../utils/property-utils'\nimport { extractTexts, extractHref, matchString, matchTexts } from '../../utils/elements-chain-utils'\n\nexport class ActionMatcher {\n    private readonly _actionRegistry?: Set<SurveyActionType>\n    private readonly _instance?: PostHog\n    private readonly _actionEvents: Set<string>\n    private _debugEventEmitter = new SimpleEventEmitter()\n\n    constructor(instance?: PostHog) {\n        this._instance = instance\n        this._actionEvents = new Set<string>()\n        this._actionRegistry = new Set<SurveyActionType>()\n    }\n\n    init() {\n        if (!isUndefined(this._instance?._addCaptureHook)) {\n            const matchEventToAction = (eventName: string, eventPayload: any) => {\n                this.on(eventName, eventPayload)\n            }\n            this._instance?._addCaptureHook(matchEventToAction)\n        }\n    }\n\n    register(actions: SurveyActionType[]): void {\n        if (isUndefined(this._instance?._addCaptureHook)) {\n            return\n        }\n\n        actions.forEach((action) => {\n            this._actionRegistry?.add(action)\n            action.steps?.forEach((step) => {\n                this._actionEvents?.add(step?.event || '')\n            })\n        })\n\n        if (this._instance?.autocapture) {\n            const selectorsToWatch: Set<string> = new Set<string>()\n            actions.forEach((action) => {\n                action.steps?.forEach((step) => {\n                    if (step?.selector) {\n                        selectorsToWatch.add(step?.selector)\n                    }\n                })\n            })\n            this._instance?.autocapture.setElementSelectors(selectorsToWatch)\n        }\n    }\n\n    on(eventName: string, eventPayload?: CaptureResult) {\n        if (eventPayload == null || eventName.length == 0) {\n            return\n        }\n\n        if (!this._actionEvents.has(eventName) && !this._actionEvents.has(<string>eventPayload?.event)) {\n            return\n        }\n\n        if (this._actionRegistry && this._actionRegistry?.size > 0) {\n            this._actionRegistry.forEach((action) => {\n                if (this._checkAction(eventPayload, action)) {\n                    this._debugEventEmitter.emit('actionCaptured', action.name)\n                }\n            })\n        }\n    }\n\n    _addActionHook(callback: (actionName: string, eventPayload?: any) => void): void {\n        this.onAction('actionCaptured', (data) => callback(data))\n    }\n\n    private _checkAction(event?: CaptureResult, action?: SurveyActionType): boolean {\n        if (action?.steps == null) {\n            return false\n        }\n\n        for (const step of action.steps) {\n            if (this._checkStep(event, step)) {\n                return true\n            }\n        }\n\n        return false\n    }\n\n    onAction(event: 'actionCaptured', cb: (...args: any[]) => void): () => void {\n        return this._debugEventEmitter.on(event, cb)\n    }\n\n    private _checkStep = (event?: CaptureResult, step?: ActionStepType): boolean => {\n        return (\n            this._checkStepEvent(event, step) &&\n            this._checkStepUrl(event, step) &&\n            this._checkStepElement(event, step) &&\n            this._checkStepProperties(event, step)\n        )\n    }\n\n    private _checkStepEvent = (event?: CaptureResult, step?: ActionStepType): boolean => {\n        // CHECK CONDITIONS, OTHERWISE SKIPPED\n        if (step?.event && event?.event !== step?.event) {\n            return false // EVENT NAME IS A MISMATCH\n        }\n        return true\n    }\n\n    private _checkStepUrl(event?: CaptureResult, step?: ActionStepType): boolean {\n        // CHECK CONDITIONS, OTHERWISE SKIPPED\n        if (step?.url) {\n            const eventUrl = event?.properties?.$current_url\n            if (!eventUrl || typeof eventUrl !== 'string') {\n                return false\n            }\n            if (!matchString(eventUrl, step.url, step.url_matching || 'contains')) {\n                return false\n            }\n        }\n        return true\n    }\n\n    private _checkStepElement(event?: CaptureResult, step?: ActionStepType): boolean {\n        if (!this._checkStepHref(event, step)) return false\n        if (!this._checkStepText(event, step)) return false\n        if (!this._checkStepSelector(event, step)) return false\n        return true\n    }\n\n    private _checkStepHref(event?: CaptureResult, step?: ActionStepType): boolean {\n        if (!step?.href) return true\n\n        const elements = this._getElementsList(event)\n        if (elements.length > 0) {\n            return elements.some((el) => matchString(el.href, step.href!, step.href_matching || 'exact'))\n        }\n\n        const chain = (event?.properties?.$elements_chain as string) || ''\n        if (chain) {\n            return matchString(extractHref(chain), step.href, step.href_matching || 'exact')\n        }\n\n        return false\n    }\n\n    private _checkStepText(event?: CaptureResult, step?: ActionStepType): boolean {\n        if (!step?.text) return true\n\n        const elements = this._getElementsList(event)\n        if (elements.length > 0) {\n            return elements.some(\n                (el) =>\n                    matchString(el.text, step.text!, step.text_matching || 'exact') ||\n                    matchString(el.$el_text, step.text!, step.text_matching || 'exact')\n            )\n        }\n\n        const chain = (event?.properties?.$elements_chain as string) || ''\n        if (chain) {\n            return matchTexts(extractTexts(chain), step.text, step.text_matching || 'exact')\n        }\n\n        return false\n    }\n\n    private _checkStepSelector(event?: CaptureResult, step?: ActionStepType): boolean {\n        if (!step?.selector) return true\n\n        // check exact match on $element_selectors from autocapture\n        const elementSelectors = event?.properties?.$element_selectors as string[] | undefined\n        if (elementSelectors?.includes(step.selector)) {\n            return true\n        }\n\n        // check against compiled regex\n        const chain = (event?.properties?.$elements_chain as string) || ''\n        if (step.selector_regex && chain) {\n            try {\n                return new RegExp(step.selector_regex).test(chain)\n            } catch {\n                return false\n            }\n        }\n\n        return false\n    }\n\n    private _getElementsList(event?: CaptureResult): SurveyElement[] {\n        if (event?.properties?.$elements == null) {\n            return []\n        }\n\n        return event?.properties.$elements as unknown as SurveyElement[]\n    }\n\n    private _checkStepProperties(event?: CaptureResult, step?: ActionStepType): boolean {\n        if (!step?.properties || step.properties.length === 0) {\n            return true\n        }\n\n        // transform to match same property format as normal events\n        const propertyFilters: PropertyFilters = step.properties.reduce<PropertyFilters>((acc, filter) => {\n            const values = isArray(filter.value)\n                ? filter.value.map(String)\n                : filter.value != null\n                  ? [String(filter.value)]\n                  : []\n\n            acc[filter.key] = {\n                values,\n                operator: (filter.operator || 'exact') as PropertyMatchType,\n            }\n            return acc\n        }, {})\n\n        return matchPropertyFilters(propertyFilters, event?.properties)\n    }\n}\n"]}