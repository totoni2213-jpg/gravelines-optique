{"version":3,"file":"element-inference.js","sourceRoot":"","sources":["../../../../src/extensions/product-tours/element-inference.ts"],"names":[],"mappings":"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","sourcesContent":["import { querySelectorAllDeep } from 'query-selector-shadow-dom'\nimport { window as _window } from '../../utils/globals'\nimport { createLogger, isArray, isUndefined } from '@posthog/core'\n\nconst window = _window as Window & typeof globalThis\nconst logger = createLogger('[Element Inference]')\n\n// this is copied directly from the main repo: /frontend/src/toolbar/utils.ts\n// TODO: once this is deployed, we can have the main repo reference this instead\nexport function elementIsVisible(element: HTMLElement, cache: WeakMap<HTMLElement, boolean>): boolean {\n    try {\n        const alreadyCached = cache.get(element)\n        if (!isUndefined(alreadyCached)) {\n            return alreadyCached\n        }\n\n        if (element.checkVisibility) {\n            const nativeIsVisible = element.checkVisibility({\n                checkOpacity: true,\n                checkVisibilityCSS: true,\n            })\n            cache.set(element, nativeIsVisible)\n            return nativeIsVisible\n        }\n\n        const style = window.getComputedStyle(element)\n        const isInvisible = style.display === 'none' || style.visibility === 'hidden' || parseFloat(style.opacity) === 0\n        if (isInvisible) {\n            cache.set(element, false)\n            return false\n        }\n\n        // Check parent chain for display/visibility\n        let parent = element.parentElement\n        while (parent) {\n            // Check cache first\n            const cached = cache.get(parent)\n            if (!isUndefined(cached)) {\n                if (!cached) {\n                    return false\n                }\n                // If cached as visible, skip to next parent\n                parent = parent.parentElement\n                continue\n            }\n\n            const parentStyle = window.getComputedStyle(parent)\n            const parentVisible = parentStyle.display !== 'none' && parentStyle.visibility !== 'hidden'\n\n            cache.set(parent, parentVisible)\n\n            if (!parentVisible) {\n                return false\n            }\n            parent = parent.parentElement\n        }\n\n        // Check if element has actual rendered dimensions\n        const rect = element.getBoundingClientRect()\n        const elementHasActualRenderedDimensions =\n            rect.width > 0 ||\n            rect.height > 0 ||\n            // Some elements might be 0x0 but still visible (e.g., inline elements with content)\n            element.getClientRects().length > 0\n        cache.set(element, elementHasActualRenderedDimensions)\n        return elementHasActualRenderedDimensions\n    } catch {\n        // if we can't get the computed style, we'll assume the element is visible\n        return true\n    }\n}\n\nexport interface SelectorGroup {\n    cardinality: number\n    cssSelectors: Array<{\n        css: string\n        offset: number\n    }>\n}\n\nexport interface AutoData {\n    notextGroups: SelectorGroup[]\n    textGroups: SelectorGroup[]\n}\n\nexport interface InferredSelector {\n    autoData: string\n    text: string | null\n    excludeText?: boolean\n    precision?: number\n}\n\nfunction getElementText(element: HTMLElement): string | null {\n    const text = element.innerText?.trim()\n    // anything higher than 250 chars -> prob not a good selector / button / target\n    if (!text || text.length > 250) {\n        return null\n    }\n    return text\n}\n\nfunction elementMatchesText(element: HTMLElement, text: string): boolean {\n    const elementText = getElementText(element)\n    return elementText?.toLowerCase() === text.toLowerCase()\n}\n\n// generator to query elements, filtering by text and visibility\nfunction* queryElements(\n    selector: string,\n    text: string | null,\n    visibilityCache: WeakMap<HTMLElement, boolean>\n): Generator<HTMLElement, void, undefined> {\n    let elements: HTMLElement[]\n\n    try {\n        elements = querySelectorAllDeep(selector) as unknown as HTMLElement[]\n    } catch {\n        return\n    }\n\n    for (const el of elements) {\n        const element = el as HTMLElement\n        if (text && !elementMatchesText(element, text)) {\n            continue\n        }\n        if (!elementIsVisible(element, visibilityCache)) {\n            continue\n        }\n        yield element\n    }\n}\n\n// could be inlined, but wanna keep lazy eval from queryElements\nfunction nth<T>(iterable: Iterable<T>, n: number): T | null {\n    let idx = 0\n    for (const item of iterable) {\n        if (idx === n) {\n            return item\n        }\n        idx++\n    }\n    return null\n}\n\n/**\n * if inferSelector is the sauce, this is the nugget\n *\n * find an element in the dom using the element inference data\n *\n * 1. try each group of selectors, starting with most specific (lowest cardinality)\n * 2. try each selector in the group - run the css query, go to offset\n * 3. \"vote\" for the element if it was found\n * 4. return early if any element gets majority votes\n * 5. return element w/ most votes\n */\nexport function findElement(selector: InferredSelector): HTMLElement | null {\n    try {\n        const autoData = JSON.parse(selector.autoData) as AutoData\n        if (!isArray(autoData?.textGroups) || !isArray(autoData?.notextGroups)) {\n            logger.error('Invalid autoData structure:', autoData)\n            return null\n        }\n        const { text, excludeText, precision = 1 } = selector\n\n        // excludeText -> user setting, usually if the target element\n        // has dynamic/localized text\n        const useText = text != null && !excludeText\n\n        // choose appropriate group + sort\n        const groups = (useText ? autoData.textGroups : autoData.notextGroups).sort(\n            (a, b) => a.cardinality - b.cardinality\n        )\n\n        if (groups.length === 0) {\n            return null\n        }\n\n        // precision controls how many groups to search\n        // 1 = strict (only most specific group), 0 = loose (all groups)\n        const maxGroups = Math.max(1, Math.ceil((1 - precision) * groups.length))\n\n        const visibilityCache = new WeakMap<HTMLElement, boolean>()\n\n        // try each selector group, starting w/ most specific (lowest cardinality)\n        for (let i = 0; i < maxGroups; i++) {\n            const group = groups[i]\n            const votes = new Map<HTMLElement, number>()\n            let winner: HTMLElement | null = null\n            let maxVotes = 0\n\n            // test each selector in the group\n            for (const { css, offset } of group.cssSelectors) {\n                // get matches, jump to offset to find our target\n                const element = nth(queryElements(css, useText ? text : null, visibilityCache), offset)\n\n                if (!element) {\n                    continue\n                }\n\n                // if we found something, this element gets a vote\n                const voteCount = (votes.get(element) ?? 0) + 1\n                votes.set(element, voteCount)\n\n                if (voteCount > maxVotes) {\n                    maxVotes = voteCount\n                    winner = element\n\n                    // break early if we have a majority\n                    if (voteCount >= Math.ceil(group.cssSelectors.length / 2)) {\n                        return winner\n                    }\n                }\n            }\n\n            if (winner) {\n                return winner\n            }\n        }\n\n        return null\n    } catch (error) {\n        logger.error('Error finding element:', error)\n        return null\n    }\n}\n\nexport function getElementPath(el: HTMLElement | null, depth = 4): string | null {\n    if (!el) {\n        return null\n    }\n    const parts: string[] = []\n    let current: HTMLElement | null = el\n\n    while (current && parts.length < depth && current.tagName !== 'BODY') {\n        let part = current.tagName.toLowerCase()\n        if (current.id) {\n            part += `#${current.id}`\n        } else if (current.classList.length) {\n            part += `.${current.classList[0]}`\n        }\n        parts.unshift(part)\n        current = current.parentElement\n    }\n\n    return parts.join(' > ')\n}\n"]}