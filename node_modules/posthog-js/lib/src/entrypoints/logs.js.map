{"version":3,"file":"logs.js","sourceRoot":"","sources":["../../../src/entrypoints/logs.ts"],"names":[],"mappings":"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","sourcesContent":["import { logs } from '@opentelemetry/api-logs'\nimport { OTLPLogExporter } from '@opentelemetry/exporter-logs-otlp-http'\nimport { LoggerProvider, BatchLogRecordProcessor } from '@opentelemetry/sdk-logs'\nimport { resourceFromAttributes } from '@opentelemetry/resources'\n\nimport { assignableWindow } from '../utils/globals'\nimport { PostHog } from '../posthog-core'\nimport { isNull, isObject } from '@posthog/core'\n\nconst setupOpenTelemetry = (posthog: PostHog) => {\n    let attributes: Record<string, string> = {\n        'service.name': 'posthog-browser-logs',\n        host: assignableWindow.location.host,\n    }\n\n    if (posthog.sessionManager) {\n        const { sessionId, windowId } = posthog.sessionManager.checkAndGetSessionAndWindowId(true)\n        attributes = {\n            ...attributes,\n            'session.id': sessionId,\n            'window.id': windowId,\n        }\n    }\n\n    logs.setGlobalLoggerProvider(\n        new LoggerProvider({\n            resource: resourceFromAttributes(attributes),\n            processors: [\n                new BatchLogRecordProcessor(\n                    new OTLPLogExporter({\n                        url: `${posthog.config.api_host}/i/v1/logs?token=${posthog.config.token}`,\n                        // 1. Force the content type to text/plain to avoid OPTIONS preflight\n                        headers: {\n                            'Content-Type': 'text/plain',\n                        },\n                    })\n                ),\n            ],\n        })\n    )\n}\n\nconst LOG_BODY_SIZE_LIMIT = 10000\nconst LOG_ATTRIBUTES_LIMIT = 50\n\n/**\n * Flattens a nested object into a single level dot-notation object.\n * By default limit to 200kB or 50 keys.\n */\nconst flattenObject = (\n    obj: any,\n    prefix = '',\n    result = {} as Record<string, any>,\n    keys_limit = LOG_ATTRIBUTES_LIMIT,\n    size_limit = LOG_BODY_SIZE_LIMIT,\n    seen = new WeakSet()\n) => {\n    if (seen.has(obj)) {\n        result[prefix || 'circular'] = '[Circular]'\n        return result\n    }\n    seen.add(obj)\n\n    for (const key in obj) {\n        if (Object.prototype.hasOwnProperty.call(obj, key)) {\n            const value = obj[key]\n            const newKey = prefix ? `${prefix}.${key}` : key\n\n            if (isObject(value)) {\n                flattenObject(value, newKey, result, keys_limit, size_limit, seen)\n            } else {\n                keys_limit -= 1\n                size_limit -= String(value).length\n                size_limit -= newKey.length\n                if (keys_limit <= 0 || size_limit <= 0) {\n                    result['attributes_truncated'] = true\n                    return\n                } else {\n                    result[newKey] = value\n                }\n            }\n        }\n    }\n    return result\n}\n\nconst SEVERITY_MAP = {\n    log: 'INFO',\n    warn: 'WARNING',\n    error: 'ERROR',\n    debug: 'DEBUG',\n    info: 'INFO',\n}\n\nconst initializeLogs = (posthog: PostHog) => {\n    setupOpenTelemetry(posthog)\n\n    const logger = logs.getLogger('console')\n    let attributes: Record<string, string> = {}\n    if (posthog.sessionManager) {\n        const { sessionStartTimestamp, lastActivityTimestamp } =\n            posthog.sessionManager.checkAndGetSessionAndWindowId(true)\n        attributes = {\n            sessionStartTimestamp: sessionStartTimestamp.toString(),\n            lastActivityTimestamp: lastActivityTimestamp.toString(),\n        }\n    }\n\n    for (const level of ['debug', 'log', 'warn', 'error', 'info'] as ('debug' | 'log' | 'warn' | 'error' | 'info')[]) {\n        const createReplacer = () => {\n            const seen = new WeakSet()\n            return (_: any, value: any) => {\n                if (value instanceof Error) {\n                    return {\n                        ...value,\n                        name: value.name,\n                        message: value.message,\n                        stack: value.stack,\n                    }\n                }\n                if (typeof value === 'object' && !isNull(value)) {\n                    if (seen.has(value)) {\n                        return '[Circular]'\n                    }\n                    seen.add(value)\n                }\n                return value\n            }\n        }\n        const logWrapper =\n            (originalConsoleLog: any) =>\n            (...args: any[]) => {\n                if (args.length > 0) {\n                    let body = args.map((a) => JSON.stringify(a, createReplacer())).join(' ')\n                    if (body.length > LOG_BODY_SIZE_LIMIT) {\n                        body = body.slice(0, LOG_BODY_SIZE_LIMIT) + '...'\n                        attributes.body_truncated = 'true'\n                    }\n                    logger.emit({\n                        severityText: SEVERITY_MAP[level],\n                        body: body,\n                        attributes: {\n                            'log.source': `console.${level}`,\n                            distinct_id: posthog.get_distinct_id(),\n                            'location.href': assignableWindow.location.href,\n                            ...attributes,\n                            ...(isObject(args[0]) ? flattenObject(args[0]) : {}),\n                        },\n                    })\n                    originalConsoleLog.apply(assignableWindow.console, args)\n                }\n            }\n\n        const originalConsoleLog = assignableWindow.console[level]\n        assignableWindow.console[level] = logWrapper(originalConsoleLog)\n    }\n}\n\nassignableWindow.__PosthogExtensions__ = assignableWindow.__PosthogExtensions__ || {}\nassignableWindow.__PosthogExtensions__.logs = { initializeLogs }\n"]}