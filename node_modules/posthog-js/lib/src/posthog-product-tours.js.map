{"version":3,"file":"posthog-product-tours.js","sourceRoot":"","sources":["../../src/posthog-product-tours.ts"],"names":[],"mappings":"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","sourcesContent":["import { PostHog } from './posthog-core'\nimport { ProductTour, ProductTourCallback } from './posthog-product-tours-types'\nimport { PRODUCT_TOURS_ENABLED_SERVER_SIDE } from './constants'\nimport { RemoteConfig } from './types'\nimport { createLogger } from './utils/logger'\nimport { isArray, isNullish } from '@posthog/core'\nimport { assignableWindow } from './utils/globals'\n\nconst logger = createLogger('[Product Tours]')\n\nconst PRODUCT_TOURS_STORAGE_KEY = 'ph_product_tours'\n\ninterface ProductTourManagerInterface {\n    start: () => void\n    stop: () => void\n    showTourById: (tourId: string) => void\n    previewTour: (tour: ProductTour) => void\n    dismissTour: (reason: string) => void\n    nextStep: () => void\n    previousStep: () => void\n    getActiveProductTours: (callback: ProductTourCallback) => void\n    resetTour: (tourId: string) => void\n    resetAllTours: () => void\n    cancelPendingTour: (tourId: string) => void\n}\n\nconst isProductToursEnabled = (instance: PostHog): boolean => {\n    if (instance.config.disable_product_tours) {\n        return false\n    }\n    return !!instance.persistence?.get_property(PRODUCT_TOURS_ENABLED_SERVER_SIDE)\n}\n\nexport class PostHogProductTours {\n    private _instance: PostHog\n    private _productTourManager: ProductTourManagerInterface | null = null\n    private _cachedTours: ProductTour[] | null = null\n\n    constructor(instance: PostHog) {\n        this._instance = instance\n    }\n\n    onRemoteConfig(response: RemoteConfig): void {\n        if (!('productTours' in response)) {\n            return\n        }\n\n        if (this._instance.persistence) {\n            this._instance.persistence.register({\n                [PRODUCT_TOURS_ENABLED_SERVER_SIDE]: !!response.productTours,\n            })\n        }\n        this.loadIfEnabled()\n    }\n\n    loadIfEnabled(): void {\n        if (this._productTourManager || !isProductToursEnabled(this._instance)) {\n            return\n        }\n        this._loadScript(() => this._startProductTours())\n    }\n\n    private _loadScript(cb: () => void): void {\n        if (assignableWindow.__PosthogExtensions__?.generateProductTours) {\n            cb()\n            return\n        }\n        assignableWindow.__PosthogExtensions__?.loadExternalDependency?.(this._instance, 'product-tours', (err) => {\n            if (err) {\n                logger.error('Could not load product tours script', err)\n                return\n            }\n            cb()\n        })\n    }\n\n    private _startProductTours(): void {\n        if (this._productTourManager || !assignableWindow.__PosthogExtensions__?.generateProductTours) {\n            return\n        }\n        this._productTourManager = assignableWindow.__PosthogExtensions__.generateProductTours(this._instance, true)\n    }\n\n    getProductTours(callback: ProductTourCallback, forceReload: boolean = false): void {\n        if (isArray(this._cachedTours) && !forceReload) {\n            callback(this._cachedTours, { isLoaded: true })\n            return\n        }\n\n        const persistence = this._instance.persistence\n        if (persistence) {\n            const storedTours = persistence.props[PRODUCT_TOURS_STORAGE_KEY]\n            if (isArray(storedTours) && !forceReload) {\n                this._cachedTours = storedTours\n                callback(storedTours, { isLoaded: true })\n                return\n            }\n        }\n\n        this._instance._send_request({\n            url: this._instance.requestRouter.endpointFor(\n                'api',\n                `/api/product_tours/?token=${this._instance.config.token}`\n            ),\n            method: 'GET',\n            callback: (response) => {\n                const statusCode = response.statusCode\n                if (statusCode !== 200 || !response.json) {\n                    const error = `Product Tours API could not be loaded, status: ${statusCode}`\n                    logger.error(error)\n                    callback([], { isLoaded: false, error })\n                    return\n                }\n\n                const tours: ProductTour[] = isArray(response.json.product_tours) ? response.json.product_tours : []\n                this._cachedTours = tours\n\n                if (persistence) {\n                    persistence.register({ [PRODUCT_TOURS_STORAGE_KEY]: tours })\n                }\n\n                callback(tours, { isLoaded: true })\n            },\n        })\n    }\n\n    getActiveProductTours(callback: ProductTourCallback): void {\n        if (isNullish(this._productTourManager)) {\n            callback([], { isLoaded: false, error: 'Product tours not loaded' })\n            return\n        }\n        this._productTourManager.getActiveProductTours(callback)\n    }\n\n    showProductTour(tourId: string): void {\n        this._productTourManager?.showTourById(tourId)\n    }\n\n    // force load product tours extension and render a tour,\n    // ignoring all display conditions.\n    previewTour(tour: ProductTour): void {\n        if (this._productTourManager) {\n            this._productTourManager.previewTour(tour)\n            return\n        }\n\n        this._loadScript(() => {\n            this._startProductTours()\n            this._productTourManager?.previewTour(tour)\n        })\n    }\n\n    dismissProductTour(): void {\n        this._productTourManager?.dismissTour('user_clicked_skip')\n    }\n\n    nextStep(): void {\n        this._productTourManager?.nextStep()\n    }\n\n    previousStep(): void {\n        this._productTourManager?.previousStep()\n    }\n\n    clearCache(): void {\n        this._cachedTours = null\n        this._instance.persistence?.unregister(PRODUCT_TOURS_STORAGE_KEY)\n    }\n\n    resetTour(tourId: string): void {\n        this._productTourManager?.resetTour(tourId)\n    }\n\n    resetAllTours(): void {\n        this._productTourManager?.resetAllTours()\n    }\n\n    cancelPendingTour(tourId: string): void {\n        this._productTourManager?.cancelPendingTour(tourId)\n    }\n}\n"]}