{"version":3,"file":"property-utils.js","sourceRoot":"","sources":["../../../src/utils/property-utils.ts"],"names":[],"mappings":"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","sourcesContent":["import { isNull, isUndefined } from '@posthog/core'\nimport { jsonStringify } from '../request'\nimport { PropertyFilters, PropertyOperator } from '../posthog-surveys-types'\nimport type { Properties } from '../types'\nimport { isMatchingRegex } from './regex-utils'\n\nexport function getPersonPropertiesHash(\n    distinct_id: string,\n    userPropertiesToSet?: Properties,\n    userPropertiesToSetOnce?: Properties\n): string {\n    return jsonStringify({ distinct_id, userPropertiesToSet, userPropertiesToSetOnce })\n}\n\nexport const propertyComparisons: Record<PropertyOperator, (targets: string[], values: string[]) => boolean> = {\n    exact: (targets, values) => values.some((value) => targets.some((target) => value === target)),\n    is_not: (targets, values) => values.every((value) => targets.every((target) => value !== target)),\n    regex: (targets, values) => values.some((value) => targets.some((target) => isMatchingRegex(value, target))),\n    not_regex: (targets, values) => values.every((value) => targets.every((target) => !isMatchingRegex(value, target))),\n    icontains: (targets, values) =>\n        values.map(toLowerCase).some((value) => targets.map(toLowerCase).some((target) => value.includes(target))),\n    not_icontains: (targets, values) =>\n        values.map(toLowerCase).every((value) => targets.map(toLowerCase).every((target) => !value.includes(target))),\n    gt: (targets, values) =>\n        values.some((value) => {\n            const numValue = parseFloat(value)\n            return !isNaN(numValue) && targets.some((t) => numValue > parseFloat(t))\n        }),\n    lt: (targets, values) =>\n        values.some((value) => {\n            const numValue = parseFloat(value)\n            return !isNaN(numValue) && targets.some((t) => numValue < parseFloat(t))\n        }),\n}\n\nconst toLowerCase = (v: string): string => v.toLowerCase()\n\nexport function matchPropertyFilters(\n    propertyFilters: PropertyFilters | undefined,\n    eventProperties: Properties | undefined\n): boolean {\n    // if there are no property filters, it means we're only matching on event name\n    if (!propertyFilters) {\n        return true\n    }\n\n    return Object.entries(propertyFilters).every(([propertyName, filter]) => {\n        const eventPropertyValue = eventProperties?.[propertyName]\n\n        if (isUndefined(eventPropertyValue) || isNull(eventPropertyValue)) {\n            return false\n        }\n\n        // convert event property to string array for comparison\n        const eventValues = [String(eventPropertyValue)]\n\n        const comparisonFunction = propertyComparisons[filter.operator]\n        if (!comparisonFunction) {\n            return false\n        }\n\n        return comparisonFunction(filter.values, eventValues)\n    })\n}\n"]}