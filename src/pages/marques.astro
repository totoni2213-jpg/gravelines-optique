---
import Layout from '../layouts/Layout.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import marquesData from '../data/marques.json';

const brands = marquesData.marques;
const marqueeItems = [...brands, ...brands, ...brands];

const usedCats = marquesData.categories.filter(c =>
  brands.some((b: { category: string }) => b.category === c)
);
const categories = ['Toutes', ...usedCats];

const countByCat: Record<string, number> = {};
categories.forEach(c => {
  countByCat[c] = c === 'Toutes' ? brands.length : brands.filter((b: { category: string }) => b.category === c).length;
});
---

<Layout
  title="Nos Marques | Opticien à Montivilliers — Gravelines Optique"
  description="30+ marques de lunettes : Ray-Ban, Lafont, David Beckham, IKKS enfants. Essayage gratuit en boutique chez votre opticien à Montivilliers."
>
  <Header />

  <!-- ══ HERO ══════════════════════════════════════════════════════════════ -->
  <section class="pt-[74px] bg-dark text-white relative overflow-hidden">
    <div class="absolute inset-0 bg-dots-dark pointer-events-none"></div>
    <div class="absolute top-0 left-0 right-0 h-px bg-gradient-to-r from-transparent via-gold/50 to-transparent"></div>
    <div class="absolute -right-24 top-8 w-72 h-72 rounded-full bg-gold/[0.04] blur-3xl pointer-events-none"></div>

    <div class="relative max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-20 sm:py-28 text-center">
      <span class="section-label mb-5 block justify-center">Notre sélection</span>
      <h1 class="font-serif text-[clamp(2.8rem,7vw,5rem)] text-white mb-6 leading-[1.05]">
        {brands.length}+ Marques <em class="text-gold italic">d'Exception</em>
      </h1>
      <p class="text-white/50 text-lg max-w-xl mx-auto leading-relaxed">
        Des créateurs indépendants aux grandes maisons, nous sélectionnons avec exigence
        chaque marque pour vous offrir le meilleur de l'optique.
      </p>
    </div>
  </section>

  <!-- ══ MARQUEE ════════════════════════════════════════════════════════════ -->
  <div class="marquee-section overflow-hidden bg-dark">
    <div class="h-px bg-gradient-to-r from-transparent via-gold/40 to-transparent"></div>
    <div class="marquee-wrap py-8 relative">
      <div class="pointer-events-none absolute inset-y-0 left-0 z-10 w-28 bg-gradient-to-r from-dark to-transparent"></div>
      <div class="pointer-events-none absolute inset-y-0 right-0 z-10 w-28 bg-gradient-to-l from-dark to-transparent"></div>
      <div class="marquee-track">
        {marqueeItems.map((brand: { logo: string; name: string }) => (
          <div class="marquee-item">
            <img
              src={brand.logo}
              alt={brand.name}
              loading="lazy"
              onerror="this.parentElement.style.display='none'"
            />
          </div>
        ))}
      </div>
    </div>
    <div class="h-px bg-gradient-to-r from-transparent via-gold/40 to-transparent"></div>
  </div>

  <!-- ══ BRANDS SHOWCASE ════════════════════════════════════════════════════ -->
  <section class="py-20 bg-cream">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">

      <!-- Category filter -->
      <div class="flex flex-wrap gap-2 mb-14 reveal">
        {categories.map((cat) => (
          <button
            data-filter={cat}
            class={`filter-btn group flex-shrink-0 flex items-center gap-2 px-4 py-2 text-[12px] font-semibold rounded-full border transition-all duration-200 tracking-wide whitespace-nowrap
              ${cat === 'Toutes'
                ? 'bg-dark text-white border-dark active'
                : 'border-dark/12 bg-white text-dark/45 hover:border-dark/40 hover:text-dark hover:bg-white'
              }`}
          >
            {cat}
            <span class={`inline-flex items-center justify-center w-4.5 h-4 text-[9.5px] font-bold rounded-full transition-colors
              ${cat === 'Toutes' ? 'bg-white/15 text-white' : 'bg-dark/6 text-dark/50 group-hover:bg-dark/10'}`}>
              {countByCat[cat]}
            </span>
          </button>
        ))}
      </div>

      <!-- Brands Grid -->
      <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-3.5" id="brands-grid">
        {brands.map((brand: { name: string; logo: string; category: string; featured: boolean }, i: number) => (
          <div
            class="brand-card reveal group"
            data-category={brand.category}
            style={`transition-delay: ${(i % 15) * 30}ms`}
          >
            <div class="logo-frame">
              <img
                src={brand.logo}
                alt={`Logo ${brand.name}`}
                loading="lazy"
                onerror="this.style.display='none'; this.nextElementSibling.style.display='flex'"
              />
              <div class="logo-fallback" style="display:none">
                <span>{brand.name[0]}</span>
              </div>
            </div>
            <div class="card-info">
              <div class="brand-name">{brand.name}</div>
              <div class="brand-cat">{brand.category}</div>
            </div>
            {brand.featured && (
              <div class="featured-badge" title="Marque mise en avant"></div>
            )}
          </div>
        ))}
      </div>

      <div id="empty-state" class="hidden text-center py-20 text-dark/30">
        <div class="text-5xl mb-4 opacity-40">◎</div>
        <p class="font-serif text-xl">Aucune marque dans cette catégorie</p>
      </div>
    </div>
  </section>

  <!-- ══ CTA ════════════════════════════════════════════════════════════════ -->
  <section class="py-28 bg-dark text-white relative overflow-hidden">
    <div class="absolute inset-0 bg-dots-dark pointer-events-none"></div>
    <div class="absolute top-0 left-0 right-0 h-px bg-gradient-to-r from-transparent via-gold/40 to-transparent"></div>
    <div class="absolute -bottom-24 left-1/2 -translate-x-1/2 w-80 h-80 rounded-full bg-gold/[0.06] blur-3xl pointer-events-none"></div>

    <div class="relative max-w-3xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
      <span class="section-label mb-5 block justify-center">Sans rendez-vous</span>
      <h2 class="font-serif text-[2.5rem] sm:text-[3rem] text-white mb-6 leading-tight">
        Essayage gratuit<br/><em class="text-gold italic">en boutique</em>
      </h2>
      <div class="gold-divider mx-auto mb-8"></div>
      <p class="text-white/40 text-[15px] mb-10 max-w-sm mx-auto leading-relaxed">
        Venez essayer toutes nos montures. Notre équipe vous conseille selon votre
        morphologie, votre style et votre correction.
      </p>
      <a href="/contact" class="btn-primary">
        Voir les horaires
        <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" d="M13.5 4.5L21 12m0 0l-7.5 7.5M21 12H3" />
        </svg>
      </a>
    </div>
  </section>

  <Footer />
</Layout>

<style>
  /* ── MARQUEE ─────────────────────────────────────────────────────────── */
  .marquee-wrap { overflow: hidden; position: relative; }
  .marquee-track {
    display: flex;
    align-items: center;
    animation: marquee-scroll 55s linear infinite;
    width: max-content;
  }
  .marquee-section:hover .marquee-track { animation-play-state: paused; }
  .marquee-item {
    flex-shrink: 0;
    padding: 0 3.5rem;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  .marquee-item img {
    height: 52px;
    max-width: 140px;
    object-fit: contain;
    filter: brightness(0) invert(1);
    opacity: 0.55;
    transition: opacity 0.35s ease;
    pointer-events: none;
  }
  .marquee-item:hover img { opacity: 0.9; }
  @keyframes marquee-scroll {
    from { transform: translateX(0); }
    to   { transform: translateX(-33.333%); }
  }

  /* ── FILTER PILLS ────────────────────────────────────────────────────── */
  .filter-btn.active {
    background: #C9A961 !important;
    color: #080808 !important;
    border-color: #C9A961 !important;
  }
  .filter-btn.active span { background: rgba(8,8,8,0.15); color: #080808; }

  /* ── BRAND CARDS ─────────────────────────────────────────────────────── */
  .brand-card {
    position: relative;
    background: #fff;
    border: 1px solid rgba(237,232,223,0.9);
    border-radius: 6px;
    padding: 22px 14px 14px;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 12px;
    overflow: hidden;
    transition:
      transform 0.35s cubic-bezier(0.16,1,0.3,1),
      border-color 0.3s ease,
      box-shadow 0.35s ease;
    cursor: default;
  }
  .brand-card:hover {
    transform: translateY(-4px);
    border-color: rgba(201,169,97,0.45);
    box-shadow: 0 12px 40px rgba(0,0,0,0.09), 0 0 0 1px rgba(201,169,97,0.18);
  }

  /* Top accent line on hover */
  .brand-card::before {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0;
    height: 2px;
    background: linear-gradient(90deg, transparent, #C9A961, transparent);
    opacity: 0;
    transition: opacity 0.3s ease;
  }
  .brand-card:hover::before { opacity: 1; }

  .logo-frame {
    width: 100%;
    aspect-ratio: 3/2;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 6px 10px;
  }
  .logo-frame img {
    max-height: 54px;
    max-width: 100%;
    object-fit: contain;
    transition: transform 0.35s cubic-bezier(0.16,1,0.3,1);
  }
  .brand-card:hover .logo-frame img { transform: scale(1.08); }

  .logo-fallback {
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 20px;
    font-weight: 700;
    color: #bbb;
    font-family: serif;
    width: 100%;
    height: 54px;
  }

  .card-info { text-align: center; width: 100%; }
  .brand-name {
    font-size: 12.5px;
    font-weight: 600;
    color: #1a1a1a;
    letter-spacing: 0.01em;
    line-height: 1.3;
    margin-bottom: 3px;
    transition: color 0.2s;
  }
  .brand-card:hover .brand-name { color: #0a0a0a; }
  .brand-cat {
    font-size: 9.5px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: #C9A961;
    opacity: 0.65;
    transition: opacity 0.2s;
  }
  .brand-card:hover .brand-cat { opacity: 1; }

  /* Featured indicator */
  .featured-badge {
    position: absolute;
    top: 8px; right: 8px;
    width: 5px; height: 5px;
    background: #C9A961;
    border-radius: 50%;
    box-shadow: 0 0 6px rgba(201,169,97,0.8);
  }
</style>

<script>
  const filterBtns = document.querySelectorAll<HTMLButtonElement>('.filter-btn');
  const brandCards = document.querySelectorAll<HTMLElement>('.brand-card');
  const emptyState = document.getElementById('empty-state');

  filterBtns.forEach((btn) => {
    btn.addEventListener('click', () => {
      const filter = btn.getAttribute('data-filter') || 'Toutes';

      // Update active state
      filterBtns.forEach(b => {
        b.classList.remove('active');
        b.style.background = '';
        b.style.color = '';
        b.style.borderColor = '';
      });
      btn.classList.add('active');

      let visible = 0;
      brandCards.forEach((card) => {
        const category = card.getAttribute('data-category');
        const show = filter === 'Toutes' || category === filter;
        if (show) {
          card.style.display = 'flex';
          card.style.transitionDelay = `${(visible % 15) * 30}ms`;
          visible++;
        } else {
          card.style.display = 'none';
          card.style.transitionDelay = '0ms';
        }
      });

      if (emptyState) emptyState.classList.toggle('hidden', visible > 0);
    });
  });
</script>
