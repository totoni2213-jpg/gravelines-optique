<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Administration â€” Gravelines Optique</title>
  <link rel="stylesheet" href="https://unpkg.com/easymde/dist/easymde.min.css" />
  <style>
    :root {
      --gold: #C9A961; --gold-light: #dfc07e;
      --dark: #0A0A0A; --bg: #f0f2f5;
      --white: #fff; --border: #e2e8f0;
      --red: #e53e3e; --green: #38a169; --blue: #3182ce;
      --sidebar: 250px;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: var(--bg); color: #1a202c; }

    /* â”€â”€ LOGIN â”€â”€ */
    #login-screen { min-height: 100vh; display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg, #0A0A0A 0%, #1a1a2e 100%); }
    .login-box { background: white; border-radius: 16px; padding: 48px 40px; width: 400px; box-shadow: 0 25px 80px rgba(0,0,0,0.4); }
    .login-logo { text-align: center; margin-bottom: 36px; }
    .login-logo .logo-icon { width: 64px; height: 64px; background: linear-gradient(135deg, var(--gold), var(--gold-light)); border-radius: 16px; display: inline-flex; align-items: center; justify-content: center; font-size: 32px; margin-bottom: 16px; }
    .login-logo h1 { font-size: 20px; font-weight: 700; color: var(--dark); }
    .login-logo p { color: #718096; font-size: 13px; margin-top: 4px; }
    .login-field { margin-bottom: 16px; }
    .login-field label { display: block; font-size: 13px; font-weight: 600; color: #4a5568; margin-bottom: 6px; }
    .login-field input { width: 100%; padding: 12px 16px; border: 2px solid var(--border); border-radius: 10px; font-size: 15px; outline: none; transition: border-color 0.2s, box-shadow 0.2s; }
    .login-field input:focus { border-color: var(--gold); box-shadow: 0 0 0 3px rgba(201,169,97,0.15); }
    .btn-login { width: 100%; padding: 14px; background: linear-gradient(135deg, var(--gold), var(--gold-light)); color: white; border: none; border-radius: 10px; font-size: 15px; font-weight: 700; cursor: pointer; margin-top: 8px; transition: opacity 0.2s, transform 0.1s; }
    .btn-login:hover { opacity: 0.92; transform: translateY(-1px); }
    .btn-login:active { transform: translateY(0); }
    .login-error { color: var(--red); font-size: 13px; margin-top: 10px; text-align: center; display: none; padding: 10px; background: #fff5f5; border-radius: 8px; }

    /* â”€â”€ APP â”€â”€ */
    #app { display: none; min-height: 100vh; }

    /* â”€â”€ SIDEBAR â”€â”€ */
    .sidebar { position: fixed; top: 0; left: 0; width: var(--sidebar); height: 100vh; background: var(--dark); overflow-y: auto; z-index: 100; display: flex; flex-direction: column; }
    .sidebar-logo { padding: 22px 20px; border-bottom: 1px solid #1a1a1a; display: flex; align-items: center; gap: 12px; }
    .sidebar-logo .logo-sq { width: 36px; height: 36px; background: linear-gradient(135deg, var(--gold), var(--gold-light)); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 18px; flex-shrink: 0; }
    .sidebar-logo strong { color: white; font-size: 13px; line-height: 1.4; display: block; }
    .sidebar-logo small { color: #4a5568; font-size: 11px; }
    .sidebar-site-link { margin: 12px 16px; padding: 8px 12px; background: #111; border: 1px solid #222; border-radius: 8px; color: #666; font-size: 12px; text-decoration: none; display: flex; align-items: center; gap: 6px; transition: all 0.2s; cursor: pointer; }
    .sidebar-site-link:hover { color: var(--gold); border-color: #333; }
    nav { padding: 8px 0; flex: 1; }
    .nav-section { padding: 12px 20px 4px; color: #333; font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 1.5px; }
    .nav-item { display: flex; align-items: center; gap: 10px; padding: 10px 20px; color: #718096; cursor: pointer; transition: all 0.15s; font-size: 13.5px; border-left: 3px solid transparent; }
    .nav-item:hover { color: #e2e8f0; background: #111; }
    .nav-item.active { color: var(--gold); background: rgba(201,169,97,0.08); border-left-color: var(--gold); }
    .nav-item .ni { font-size: 16px; width: 22px; text-align: center; }
    .sidebar-footer { padding: 16px; border-top: 1px solid #111; }
    .btn-logout { width: 100%; padding: 9px; background: transparent; border: 1px solid #222; color: #555; border-radius: 8px; cursor: pointer; font-size: 12px; transition: all 0.2s; }
    .btn-logout:hover { border-color: #444; color: #aaa; }

    /* â”€â”€ MAIN â”€â”€ */
    .main { margin-left: var(--sidebar); padding: 28px 32px; min-height: 100vh; }

    /* â”€â”€ PAGE HEADER â”€â”€ */
    .page-header { margin-bottom: 24px; display: flex; align-items: flex-start; justify-content: space-between; flex-wrap: wrap; gap: 12px; }
    .page-header h2 { font-size: 22px; font-weight: 700; color: var(--dark); }
    .page-header p { color: #718096; font-size: 13px; margin-top: 3px; }

    /* â”€â”€ DASHBOARD â”€â”€ */
    .dash-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; margin-bottom: 28px; }
    .dash-card { background: white; border-radius: 12px; padding: 22px; box-shadow: 0 1px 4px rgba(0,0,0,0.06); border: 1px solid var(--border); }
    .dash-card .dc-icon { font-size: 28px; margin-bottom: 10px; }
    .dash-card .dc-val { font-size: 30px; font-weight: 800; color: var(--gold); line-height: 1; }
    .dash-card .dc-label { font-size: 13px; color: #718096; margin-top: 4px; }
    .dash-actions { display: grid; grid-template-columns: repeat(2, 1fr); gap: 14px; }
    .dash-action { background: white; border-radius: 12px; padding: 20px; border: 1px solid var(--border); cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 14px; }
    .dash-action:hover { border-color: var(--gold); box-shadow: 0 4px 16px rgba(201,169,97,0.12); transform: translateY(-2px); }
    .dash-action .da-icon { width: 46px; height: 46px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 22px; flex-shrink: 0; }
    .da-gold { background: rgba(201,169,97,0.12); }
    .da-blue { background: rgba(49,130,206,0.1); }
    .da-green { background: rgba(56,161,105,0.1); }
    .da-purple { background: rgba(128,90,213,0.1); }
    .dash-action strong { display: block; font-size: 14px; font-weight: 600; color: var(--dark); }
    .dash-action span { font-size: 12px; color: #718096; }

    /* â”€â”€ STATS CARDS â”€â”€ */
    .stats-row { display: grid; grid-template-columns: repeat(3, 1fr); gap: 14px; margin-bottom: 24px; }
    .stat-card { background: white; border-radius: 10px; padding: 18px 20px; box-shadow: 0 1px 4px rgba(0,0,0,0.06); border: 1px solid var(--border); }
    .stat-card .sv { font-size: 26px; font-weight: 800; color: var(--gold); }
    .stat-card .sl { font-size: 12px; color: #718096; margin-top: 3px; }

    /* â”€â”€ ARTICLES â”€â”€ */
    .articles-panel { background: white; border-radius: 12px; box-shadow: 0 1px 4px rgba(0,0,0,0.06); border: 1px solid var(--border); overflow: hidden; }
    .panel-header { padding: 16px 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
    .panel-title { font-size: 14px; font-weight: 600; color: var(--dark); }
    .btn-new { padding: 9px 18px; background: var(--gold); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 13px; font-weight: 600; display: flex; align-items: center; gap: 6px; transition: opacity 0.2s; }
    .btn-new:hover { opacity: 0.88; }
    .article-row { padding: 14px 20px; border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 14px; transition: background 0.12s; }
    .article-row:last-child { border-bottom: none; }
    .article-row:hover { background: #fafafa; }
    .article-thumb { width: 52px; height: 40px; border-radius: 6px; background: #f0f2f5; object-fit: cover; flex-shrink: 0; display: flex; align-items: center; justify-content: center; color: #cbd5e0; font-size: 18px; overflow: hidden; }
    .article-thumb img { width: 100%; height: 100%; object-fit: cover; }
    .art-info { flex: 1; min-width: 0; }
    .art-title { font-weight: 600; font-size: 14px; color: var(--dark); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .art-meta { font-size: 11px; color: #a0aec0; margin-top: 2px; }
    .badge { display: inline-flex; align-items: center; padding: 2px 9px; border-radius: 99px; font-size: 11px; font-weight: 600; white-space: nowrap; }
    .badge-green { background: #f0fff4; color: #276749; }
    .badge-gray { background: #f7fafc; color: #718096; }
    .badge-cat { padding: 2px 8px; border-radius: 4px; font-size: 10px; font-weight: 600; }
    .cat-ActualitÃ©s { background: #ebf8ff; color: #2b6cb0; }
    .cat-Conseils { background: #f0fff4; color: #276749; }
    .cat-NouveautÃ©s { background: #faf5ff; color: #6b46c1; }
    .cat-Promotions { background: #fff5f5; color: #c53030; }
    .cat-Ã‰vÃ©nements { background: #fffaf0; color: #c05621; }
    .art-btns { display: flex; gap: 6px; flex-shrink: 0; }
    .btn-sm { padding: 5px 12px; border: none; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 500; transition: background 0.15s; }
    .btn-edit-sm { background: #edf2f7; color: #4a5568; }
    .btn-edit-sm:hover { background: #e2e8f0; }
    .btn-del-sm { background: #fff5f5; color: var(--red); }
    .btn-del-sm:hover { background: #fed7d7; }
    .empty-state { text-align: center; padding: 56px 20px; color: #a0aec0; }
    .empty-icon { font-size: 44px; display: block; margin-bottom: 10px; }

    /* â”€â”€ EDITOR â”€â”€ */
    .editor-wrap { background: white; border-radius: 12px; border: 1px solid var(--border); box-shadow: 0 1px 4px rgba(0,0,0,0.06); overflow: hidden; }
    .editor-top { padding: 14px 20px; border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 12px; }
    .btn-back { padding: 7px 14px; background: #edf2f7; border: none; border-radius: 7px; cursor: pointer; font-size: 13px; color: #4a5568; display: flex; align-items: center; gap: 5px; transition: background 0.15s; }
    .btn-back:hover { background: #e2e8f0; }
    .editor-title { font-size: 16px; font-weight: 600; }
    .editor-body { padding: 24px 28px; }
    .form-group { margin-bottom: 20px; }
    .form-group label { display: block; font-size: 12px; font-weight: 600; color: #4a5568; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px; }
    .form-group input, .form-group select, .form-group textarea {
      width: 100%; padding: 10px 14px; border: 2px solid var(--border); border-radius: 8px;
      font-size: 14px; outline: none; transition: border-color 0.2s, box-shadow 0.2s; font-family: inherit; color: var(--dark);
    }
    .form-group input:focus, .form-group select:focus, .form-group textarea:focus { border-color: var(--gold); box-shadow: 0 0 0 3px rgba(201,169,97,0.12); }
    .form-2col { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    .form-3col { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px; }
    .col-full { grid-column: 1 / -1; }
    .toggle-row { display: flex; align-items: center; gap: 10px; }
    .toggle { position: relative; display: inline-block; width: 46px; height: 25px; flex-shrink: 0; }
    .toggle input { opacity: 0; width: 0; height: 0; }
    .tslider { position: absolute; inset: 0; background: #cbd5e0; border-radius: 25px; cursor: pointer; transition: 0.25s; }
    .tslider:before { content: ''; position: absolute; height: 19px; width: 19px; left: 3px; bottom: 3px; background: white; border-radius: 50%; transition: 0.25s; }
    .toggle input:checked + .tslider { background: var(--gold); }
    .toggle input:checked + .tslider:before { transform: translateX(21px); }
    .editor-footer { padding: 14px 24px; border-top: 1px solid var(--border); display: flex; gap: 10px; justify-content: flex-end; background: #fafafa; }
    .btn-save { padding: 10px 26px; background: var(--gold); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600; transition: opacity 0.2s; display: flex; align-items: center; gap: 8px; min-width: 160px; justify-content: center; }
    .btn-save:hover:not(:disabled) { opacity: 0.88; }
    .btn-save:disabled { opacity: 0.6; cursor: not-allowed; }
    .btn-cancel { padding: 10px 18px; background: #edf2f7; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; color: #4a5568; }
    .btn-cancel:hover { background: #e2e8f0; }

    /* â”€â”€ IMAGE UPLOAD â”€â”€ */
    .img-upload-zone { border: 2px dashed var(--border); border-radius: 10px; padding: 20px; text-align: center; cursor: pointer; transition: all 0.2s; background: #fafafa; }
    .img-upload-zone:hover, .img-upload-zone.drag { border-color: var(--gold); background: rgba(201,169,97,0.04); }
    .img-upload-zone input { display: none; }
    .img-preview { width: 100%; max-height: 160px; object-fit: cover; border-radius: 8px; margin-top: 10px; display: none; }
    .img-current { font-size: 12px; color: #718096; margin-top: 6px; word-break: break-all; }
    .upload-progress { height: 4px; background: #e2e8f0; border-radius: 2px; margin-top: 10px; display: none; }
    .upload-bar { height: 100%; background: var(--gold); border-radius: 2px; width: 0; transition: width 0.3s; }

    /* â”€â”€ SECTION CARD â”€â”€ */
    .section-card { border: 1px solid var(--border); border-radius: 10px; padding: 20px; margin-bottom: 20px; }
    .section-card h3 { font-size: 14px; font-weight: 700; color: var(--dark); margin-bottom: 16px; padding-bottom: 10px; border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 8px; }

    /* â”€â”€ LIST EDITOR â”€â”€ */
    .list-editor { display: flex; flex-direction: column; gap: 8px; }
    .list-item { display: flex; gap: 8px; align-items: center; }
    .list-item input { flex: 1; padding: 8px 12px; border: 2px solid var(--border); border-radius: 7px; font-size: 13px; outline: none; transition: border-color 0.2s; }
    .list-item input:focus { border-color: var(--gold); }
    .btn-rm { padding: 7px 10px; background: #fff5f5; color: var(--red); border: none; border-radius: 6px; cursor: pointer; font-size: 14px; line-height: 1; flex-shrink: 0; transition: background 0.15s; }
    .btn-rm:hover { background: #fed7d7; }
    .btn-add { padding: 8px 14px; background: #f0fff4; color: var(--green); border: 1px dashed #9ae6b4; border-radius: 7px; cursor: pointer; font-size: 13px; font-weight: 500; margin-top: 4px; transition: all 0.15s; display: inline-flex; align-items: center; gap: 5px; }
    .btn-add:hover { background: #c6f6d5; }

    /* â”€â”€ OBJECT LIST EDITOR â”€â”€ */
    .obj-item { border: 1px solid var(--border); border-radius: 8px; padding: 14px; margin-bottom: 8px; position: relative; }
    .obj-item-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px; }
    .obj-label { font-size: 12px; font-weight: 600; color: #718096; }

    /* â”€â”€ TOAST â”€â”€ */
    .toast { position: fixed; bottom: 24px; right: 24px; padding: 13px 20px; border-radius: 10px; color: white; font-size: 13px; font-weight: 600; z-index: 9999; box-shadow: 0 8px 30px rgba(0,0,0,0.2); transform: translateY(80px); transition: transform 0.3s cubic-bezier(0.34,1.56,0.64,1); max-width: 340px; }
    .toast.show { transform: translateY(0); }
    .toast.success { background: linear-gradient(135deg, #38a169, #48bb78); }
    .toast.error { background: linear-gradient(135deg, #e53e3e, #fc8181); }
    .toast.info { background: linear-gradient(135deg, #3182ce, #63b3ed); }

    /* â”€â”€ LOADING â”€â”€ */
    .loading { text-align: center; padding: 60px 20px; color: #a0aec0; }
    .spinner { display: inline-block; width: 28px; height: 28px; border: 3px solid #e2e8f0; border-top-color: var(--gold); border-radius: 50%; animation: spin 0.7s linear infinite; }
    .spinner-sm { display: inline-block; width: 14px; height: 14px; border: 2px solid rgba(255,255,255,0.4); border-top-color: white; border-radius: 50%; animation: spin 0.7s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .EasyMDEContainer .CodeMirror { height: 320px; font-size: 14px; }
    .editor-toolbar { border-radius: 8px 8px 0 0; }

    /* â”€â”€ HORAIRE ROW â”€â”€ */
    .horaire-row { display: grid; grid-template-columns: 140px 1fr auto; gap: 10px; align-items: center; margin-bottom: 8px; }
    .horaire-row input { padding: 8px 12px; border: 2px solid var(--border); border-radius: 7px; font-size: 13px; outline: none; transition: border-color 0.2s; }
    .horaire-row input:focus { border-color: var(--gold); }
    .horaire-toggle { display: flex; align-items: center; gap: 6px; font-size: 12px; color: #718096; white-space: nowrap; }

    /* â”€â”€ MARQUE ITEM â”€â”€ */
    .marque-item { border: 1px solid var(--border); border-radius: 10px; padding: 16px; margin-bottom: 10px; display: flex; align-items: center; gap: 14px; background: white; transition: border-color 0.2s; }
    .marque-item:hover { border-color: #cbd5e0; }
    .marque-logo-preview { width: 60px; height: 40px; border-radius: 6px; background: #f7fafc; display: flex; align-items: center; justify-content: center; flex-shrink: 0; overflow: hidden; border: 1px solid var(--border); }
    .marque-logo-preview img { max-width: 100%; max-height: 100%; object-fit: contain; }
    .marque-fields { flex: 1; display: grid; grid-template-columns: 1fr 1fr; gap: 8px; align-items: center; }
    .marque-fields input, .marque-fields select { padding: 7px 10px; border: 2px solid var(--border); border-radius: 6px; font-size: 13px; outline: none; transition: border-color 0.2s; }
    .marque-fields input:focus, .marque-fields select:focus { border-color: var(--gold); }
    .marque-actions { display: flex; flex-direction: column; gap: 4px; flex-shrink: 0; align-items: center; }
    .marque-featured { display: flex; align-items: center; gap: 4px; font-size: 11px; color: #718096; white-space: nowrap; }
    .marque-featured .star { cursor: pointer; font-size: 18px; transition: transform 0.15s; }
    .marque-featured .star:hover { transform: scale(1.2); }
    .marque-upload-btn { padding: 4px 8px; background: #edf2f7; border: none; border-radius: 5px; cursor: pointer; font-size: 11px; color: #4a5568; transition: background 0.15s; white-space: nowrap; }
    .marque-upload-btn:hover { background: #e2e8f0; }

    /* â”€â”€ DEPLOY BANNER â”€â”€ */
    .deploy-banner { background: linear-gradient(135deg, rgba(201,169,97,0.1), rgba(201,169,97,0.05)); border: 1px solid rgba(201,169,97,0.3); border-radius: 10px; padding: 14px 18px; margin-bottom: 24px; display: flex; align-items: center; gap: 12px; font-size: 13px; color: #744210; }
    .deploy-banner .db-icon { font-size: 20px; }
    .deploy-banner a { color: var(--gold); font-weight: 600; text-decoration: none; }
    .deploy-banner a:hover { text-decoration: underline; }
  </style>
</head>
<body>

<!-- â”€â”€â”€ LOGIN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="login-screen">
  <div class="login-box">
    <div class="login-logo">
      <div class="logo-icon">ğŸ‘“</div>
      <h1>Gravelines Optique</h1>
      <p>Panneau d'administration</p>
    </div>
    <div class="login-field">
      <label>Mot de passe</label>
      <input type="password" id="pw" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" autocomplete="current-password" />
    </div>
    <button class="btn-login" id="login-btn" onclick="doLogin()">AccÃ©der au panneau</button>
    <div class="login-error" id="login-error">Mot de passe incorrect. RÃ©essayez.</div>
  </div>
</div>

<!-- â”€â”€â”€ APP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="app">
  <aside class="sidebar">
    <div class="sidebar-logo">
      <div class="logo-sq">ğŸ‘“</div>
      <div><strong>Gravelines Optique</strong><small>Administration</small></div>
    </div>
    <a class="sidebar-site-link" href="https://glittering-tapioca-3708c0.netlify.app" target="_blank">
      ğŸŒ Voir le site en ligne â†—
    </a>
    <nav>
      <div class="nav-section">Tableau de bord</div>
      <div class="nav-item active" onclick="showSection('dashboard')" id="nav-dashboard">
        <span class="ni">ğŸ¡</span> Accueil
      </div>
      <div class="nav-section">Contenu</div>
      <div class="nav-item" onclick="showSection('articles')" id="nav-articles">
        <span class="ni">ğŸ“°</span> Articles
      </div>
      <div class="nav-item" onclick="showSection('marques')" id="nav-marques">
        <span class="ni">ğŸ·ï¸</span> Marques
      </div>
      <div class="nav-section">ParamÃ¨tres du site</div>
      <div class="nav-item" onclick="showSection('contact')" id="nav-contact">
        <span class="ni">ğŸ“</span> Contact & Horaires
      </div>
      <div class="nav-item" onclick="showSection('accueil')" id="nav-accueil">
        <span class="ni">ğŸ </span> Page d'accueil
      </div>
      <div class="nav-item" onclick="showSection('equipe')" id="nav-equipe">
        <span class="ni">ğŸ‘¥</span> L'Ã‰quipe
      </div>
      <div class="nav-item" onclick="showSection('boutique')" id="nav-boutique">
        <span class="ni">ğŸª</span> La Boutique
      </div>
      <div class="nav-item" onclick="showSection('services')" id="nav-services">
        <span class="ni">ğŸ› ï¸</span> Services
      </div>
      <div class="nav-item" onclick="showSection('sav')" id="nav-sav">
        <span class="ni">ğŸ”§</span> SAV & RÃ©parations
      </div>
    </nav>
    <div class="sidebar-footer">
      <button class="btn-logout" onclick="logout()">â¬… DÃ©connexion</button>
    </div>
  </aside>

  <main class="main" id="main">
    <div class="loading"><div class="spinner"></div></div>
  </main>
</div>

<div class="toast" id="toast"></div>

<script src="https://unpkg.com/easymde/dist/easymde.min.js"></script>
<script>
const API = '/.netlify/functions/cms';
let pw = '', mde = null;

// â”€â”€â”€ AUTH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function doLogin() {
  const val = document.getElementById('pw').value.trim();
  if (!val) return;
  const btn = document.getElementById('login-btn');
  btn.textContent = 'Connexionâ€¦'; btn.disabled = true;
  document.getElementById('login-error').style.display = 'none';
  try {
    const r = await fetch(`${API}?path=src/content/articles`, { headers: { 'X-CMS-Password': val } });
    if (r.ok) {
      pw = val;
      document.getElementById('login-screen').style.display = 'none';
      document.getElementById('app').style.display = 'block';
      showSection('dashboard');
    } else throw new Error();
  } catch {
    document.getElementById('login-error').style.display = 'block';
    btn.textContent = 'AccÃ©der au panneau'; btn.disabled = false;
  }
}
document.getElementById('pw').addEventListener('keydown', e => e.key === 'Enter' && doLogin());

function logout() {
  pw = '';
  document.getElementById('login-screen').style.display = 'flex';
  document.getElementById('app').style.display = 'none';
  document.getElementById('pw').value = '';
}

// â”€â”€â”€ NAV â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showSection(s) {
  document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
  document.getElementById(`nav-${s}`)?.classList.add('active');
  if (s === 'dashboard') loadDashboard();
  else if (s === 'articles') loadArticles();
  else if (s === 'marques') loadJsonEditor('marques');
  else if (s === 'services') loadJsonEditor('services');
  else if (s === 'sav') loadJsonEditor('sav');
  else if (s === 'boutique') loadJsonEditor('boutique');
  else loadJsonEditor(s);
}

// â”€â”€â”€ API â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function apiGet(path) {
  const r = await fetch(`${API}?path=${encodeURIComponent(path)}`, { headers: { 'X-CMS-Password': pw } });
  if (!r.ok) throw new Error(`Erreur ${r.status}`);
  return r.json();
}
async function apiPut(path, content, sha, msg) {
  const encoded = btoa(unescape(encodeURIComponent(content)));
  const r = await fetch(`${API}?path=${encodeURIComponent(path)}`, {
    method: 'PUT', headers: { 'X-CMS-Password': pw, 'Content-Type': 'application/json' },
    body: JSON.stringify({ content: encoded, sha, message: msg || `Mise Ã  jour: ${path}` })
  });
  if (!r.ok) { const e = await r.json(); throw new Error(e.message || `Erreur ${r.status}`); }
  return r.json();
}
async function apiPutBinary(path, base64, sha, msg) {
  const r = await fetch(`${API}?path=${encodeURIComponent(path)}`, {
    method: 'PUT', headers: { 'X-CMS-Password': pw, 'Content-Type': 'application/json' },
    body: JSON.stringify({ content: base64, sha, message: msg || `Upload: ${path}`, binary: true })
  });
  if (!r.ok) { const e = await r.json(); throw new Error(e.message || `Erreur ${r.status}`); }
  return r.json();
}
async function apiDel(path, sha) {
  const r = await fetch(`${API}?path=${encodeURIComponent(path)}`, {
    method: 'DELETE', headers: { 'X-CMS-Password': pw, 'Content-Type': 'application/json' },
    body: JSON.stringify({ sha })
  });
  if (!r.ok) throw new Error(`Erreur ${r.status}`);
  return r.json();
}
function b64d(s) { try { return decodeURIComponent(escape(atob(s.replace(/\n/g,'')))); } catch { return atob(s.replace(/\n/g,'')); } }
function slug(s) { return s.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/[^a-z0-9\s-]/g,'').replace(/\s+/g,'-').replace(/-+/g,'-').substring(0,50); }

function toast(msg, type = 'success') {
  const t = document.getElementById('toast');
  t.innerHTML = (type==='success'?'âœ“ ':type==='error'?'âœ— ':'â„¹ ') + msg;
  t.className = `toast ${type} show`;
  setTimeout(() => t.classList.remove('show'), 4000);
}

// â”€â”€â”€ FRONTMATTER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function parseFM(content) {
  const m = content.match(/^---\n([\s\S]*?)\n---/);
  if (!m) return {};
  const fm = {};
  m[1].split('\n').forEach(line => {
    const idx = line.indexOf(':');
    if (idx < 0) return;
    const k = line.slice(0, idx).trim();
    let v = line.slice(idx+1).trim().replace(/^["']|["']$/g, '');
    if (v === 'true') v = true; else if (v === 'false') v = false;
    fm[k] = v;
  });
  return fm;
}
function buildFM(f) {
  const lines = ['---'];
  for (const [k,v] of Object.entries(f)) {
    if (typeof v === 'boolean') lines.push(`${k}: ${v}`);
    else if (v != null && v !== '') lines.push(`${k}: "${String(v).replace(/"/g,'\\"')}"`);
  }
  lines.push('---'); return lines.join('\n');
}

// â”€â”€â”€ DASHBOARD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadDashboard() {
  const main = document.getElementById('main');
  main.innerHTML = '<div class="loading"><div class="spinner"></div><p style="margin-top:12px">Chargementâ€¦</p></div>';
  try {
    const files = await apiGet('src/content/articles');
    const mds = files.filter(f => f.name.endsWith('.md'));
    const articles = await Promise.all(mds.map(async f => {
      try { const d = await apiGet(f.path); return parseFM(b64d(d.content)); } catch { return {}; }
    }));
    const pub = articles.filter(a => a.publie !== false).length;

    main.innerHTML = `
      <div class="page-header">
        <div><h2>ğŸ¡ Tableau de bord</h2><p>Bonjour ! GÃ©rez votre site depuis ce panneau.</p></div>
      </div>
      <div class="deploy-banner">
        <span class="db-icon">ğŸŒ</span>
        <div>Votre site est en ligne sur <a href="https://glittering-tapioca-3708c0.netlify.app" target="_blank">glittering-tapioca-3708c0.netlify.app</a>
        Â· Les modifications sont publiÃ©es automatiquement en 1â€“2 min aprÃ¨s sauvegarde.</div>
      </div>
      <div class="dash-grid">
        <div class="dash-card"><div class="dc-icon">ğŸ“°</div><div class="dc-val">${mds.length}</div><div class="dc-label">Articles au total</div></div>
        <div class="dash-card"><div class="dc-icon">âœ…</div><div class="dc-val">${pub}</div><div class="dc-label">Articles publiÃ©s</div></div>
        <div class="dash-card"><div class="dc-icon">ğŸ“</div><div class="dc-val">${mds.length - pub}</div><div class="dc-label">Brouillons</div></div>
      </div>
      <h3 style="font-size:14px;font-weight:700;color:#4a5568;margin-bottom:14px;text-transform:uppercase;letter-spacing:.5px">AccÃ¨s rapide</h3>
      <div class="dash-actions">
        <div class="dash-action" onclick="newArticle()">
          <div class="da-icon da-gold">âœï¸</div>
          <div><strong>Nouvel article</strong><span>RÃ©diger et publier un article</span></div>
        </div>
        <div class="dash-action" onclick="showSection('articles')">
          <div class="da-icon da-blue">ğŸ“°</div>
          <div><strong>Mes articles</strong><span>Modifier ou supprimer un article</span></div>
        </div>
        <div class="dash-action" onclick="showSection('contact')">
          <div class="da-icon da-green">ğŸ“</div>
          <div><strong>Contact & Horaires</strong><span>Modifier les horaires ou l'adresse</span></div>
        </div>
        <div class="dash-action" onclick="showSection('equipe')">
          <div class="da-icon da-purple">ğŸ‘¥</div>
          <div><strong>L'Ã‰quipe</strong><span>Mettre Ã  jour les membres</span></div>
        </div>
        <div class="dash-action" onclick="showSection('marques')">
          <div class="da-icon da-gold">ğŸ·ï¸</div>
          <div><strong>Nos Marques</strong><span>GÃ©rer les marques et logos</span></div>
        </div>
        <div class="dash-action" onclick="showSection('services')">
          <div class="da-icon da-blue">ğŸ› ï¸</div>
          <div><strong>Services</strong><span>Modifier les services proposÃ©s</span></div>
        </div>
        <div class="dash-action" onclick="showSection('sav')">
          <div class="da-icon da-green">ğŸ”§</div>
          <div><strong>SAV & RÃ©parations</strong><span>Tarifs et processus SAV</span></div>
        </div>
        <div class="dash-action" onclick="showSection('boutique')">
          <div class="da-icon da-purple">ğŸª</div>
          <div><strong>La Boutique</strong><span>Textes et chiffres clÃ©s</span></div>
        </div>
      </div>
    `;
  } catch(e) {
    main.innerHTML = `<div class="loading" style="color:var(--red)">Erreur: ${e.message}</div>`;
  }
}

// â”€â”€â”€ ARTICLES LIST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadArticles() {
  const main = document.getElementById('main');
  main.innerHTML = '<div class="loading"><div class="spinner"></div><p style="margin-top:12px">Chargement des articlesâ€¦</p></div>';
  try {
    const files = await apiGet('src/content/articles');
    const mds = files.filter(f => f.name.endsWith('.md'));
    const articles = await Promise.all(mds.map(async f => {
      try { const d = await apiGet(f.path); const fm = parseFM(b64d(d.content)); return { ...f, sha: d.sha, fm }; }
      catch { return { ...f, fm: {} }; }
    }));
    articles.sort((a,b) => (b.fm.date||'').localeCompare(a.fm.date||''));
    const pub = articles.filter(a => a.fm.publie !== false).length;
    const catClass = c => c ? `badge-cat cat-${c.split(' ')[0]}` : '';

    main.innerHTML = `
      <div class="page-header">
        <div><h2>ğŸ“° Articles & ActualitÃ©s</h2><p>CrÃ©ez et gÃ©rez vos articles</p></div>
        <button class="btn-new" onclick="newArticle()">ï¼‹ Nouvel article</button>
      </div>
      <div class="stats-row">
        <div class="stat-card"><div class="sv">${articles.length}</div><div class="sl">Total</div></div>
        <div class="stat-card"><div class="sv">${pub}</div><div class="sl">PubliÃ©s</div></div>
        <div class="stat-card"><div class="sv">${articles.length-pub}</div><div class="sl">Brouillons</div></div>
      </div>
      <div class="articles-panel">
        <div class="panel-header"><span class="panel-title">Tous les articles</span></div>
        ${articles.length === 0 ? `<div class="empty-state"><span class="empty-icon">ğŸ“</span><p>Aucun article.<br>CrÃ©ez votre premier article !</p></div>`
        : articles.map(a => `
          <div class="article-row">
            <div class="article-thumb">
              ${a.fm.image ? `<img src="${a.fm.image}" alt="" onerror="this.parentNode.innerHTML='ğŸ“„'">` : 'ğŸ“„'}
            </div>
            <div class="art-info">
              <div class="art-title">${esc(a.fm.titre || a.name)}</div>
              <div class="art-meta">
                ${a.fm.date ? 'ğŸ“… ' + a.fm.date.toString().substring(0,10) : ''}
                ${a.fm.categorie ? `&nbsp;<span class="badge ${catClass(a.fm.categorie)}">${a.fm.categorie}</span>` : ''}
              </div>
            </div>
            <span class="badge ${a.fm.publie !== false ? 'badge-green' : 'badge-gray'}">${a.fm.publie !== false ? 'â— PubliÃ©' : 'â—‹ Brouillon'}</span>
            <div class="art-btns">
              <button class="btn-sm btn-edit-sm" onclick="editArticle('${a.path}','${a.sha}')">Modifier</button>
              <button class="btn-sm btn-del-sm" onclick="delArticle('${a.path}','${a.sha}','${(a.fm.titre||a.name).replace(/'/g,"\\'")}')">âœ•</button>
            </div>
          </div>`).join('')}
      </div>`;
  } catch(e) {
    main.innerHTML = `<div class="loading" style="color:var(--red)">Erreur: ${e.message}</div>`;
  }
}

function esc(s) { return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }

// â”€â”€â”€ ARTICLE EDITOR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function editArticle(path, sha) {
  document.getElementById('main').innerHTML = '<div class="loading"><div class="spinner"></div></div>';
  try {
    const d = await apiGet(path);
    const content = b64d(d.content);
    const fm = parseFM(content);
    const bm = content.match(/^---\n[\s\S]*?\n---\n?([\s\S]*)$/);
    renderEditor(path, d.sha, fm, bm ? bm[1].trim() : '', false);
  } catch(e) { toast('Erreur: '+e.message,'error'); loadArticles(); }
}

function newArticle() {
  renderEditor(null, null, { titre:'', description:'', date: new Date().toISOString().split('T')[0], categorie:'', publie:true }, '', true);
}

function renderEditor(path, sha, fm, body, isNew) {
  const cats = ['ActualitÃ©s','Conseils optique','NouveautÃ©s','Promotions','Ã‰vÃ©nements'];
  document.getElementById('main').innerHTML = `
    <div class="editor-wrap">
      <div class="editor-top">
        <button class="btn-back" onclick="loadArticles()">â† Retour</button>
        <span class="editor-title">${isNew ? 'âœ¨ Nouvel article' : 'âœï¸ Modifier l\'article'}</span>
      </div>
      <div class="editor-body">
        <div class="form-2col">
          <div class="form-group col-full">
            <label>Titre *</label>
            <input id="f-titre" type="text" value="${esc(fm.titre||'')}" placeholder="Ex: Nouvelle collection printemps 2026" />
          </div>
          <div class="form-group col-full">
            <label>Description courte (pour les aperÃ§us)</label>
            <input id="f-desc" type="text" value="${esc(fm.description||'')}" placeholder="Un rÃ©sumÃ© court de l'articleâ€¦" />
          </div>
          <div class="form-group">
            <label>Date de publication</label>
            <input id="f-date" type="date" value="${fm.date?fm.date.toString().substring(0,10):''}" />
          </div>
          <div class="form-group">
            <label>CatÃ©gorie</label>
            <select id="f-cat">
              <option value="">â€” Choisir â€”</option>
              ${cats.map(c=>`<option ${fm.categorie===c?'selected':''}>${c}</option>`).join('')}
            </select>
          </div>
          <div class="form-group col-full">
            <label>Statut de publication</label>
            <div class="toggle-row">
              <label class="toggle"><input type="checkbox" id="f-pub" ${fm.publie!==false?'checked':''}><span class="tslider"></span></label>
              <span style="font-size:13px;color:#4a5568">PubliÃ© â€” visible sur le site</span>
            </div>
          </div>
          <div class="form-group col-full">
            <label>Image principale</label>
            <div class="img-upload-zone" id="upload-zone" onclick="document.getElementById('f-img-file').click()">
              <input type="file" id="f-img-file" accept="image/*" onchange="handleImgUpload(this)">
              <div id="upload-placeholder">
                <div style="font-size:28px;margin-bottom:6px">ğŸ“·</div>
                <div style="font-size:13px;color:#718096">Cliquer pour choisir une image<br><small>JPG, PNG, WEBP â€” max 5 Mo</small></div>
              </div>
              ${fm.image ? `<img class="img-preview" src="${fm.image}" style="display:block" id="img-preview-el">` : '<img class="img-preview" id="img-preview-el">'}
              <div class="img-current" id="img-current-path">${fm.image||''}</div>
              <div class="upload-progress" id="upload-prog"><div class="upload-bar" id="upload-bar"></div></div>
            </div>
            <input type="hidden" id="f-img" value="${esc(fm.image||'')}">
          </div>
          <div class="form-group col-full">
            <label>Contenu de l'article</label>
            <textarea id="f-body">${body}</textarea>
          </div>
        </div>
      </div>
      <div class="editor-footer">
        <button class="btn-cancel" onclick="loadArticles()">Annuler</button>
        <button class="btn-save" id="save-btn" onclick="saveArticle('${path||''}','${sha||''}',${isNew})">ğŸ’¾ Enregistrer</button>
      </div>
    </div>`;

  if (mde) { try { mde.toTextArea(); } catch {} mde = null; }
  mde = new EasyMDE({
    element: document.getElementById('f-body'),
    spellChecker: false, autofocus: false,
    placeholder: 'RÃ©digez votre article iciâ€¦\n\nUtilisez la barre d\'outils pour mettre en forme le texte.',
    toolbar: ['bold','italic','heading','|','quote','unordered-list','ordered-list','|','link','|','preview','side-by-side','fullscreen','|','guide'],
    status: false,
  });
}

async function handleImgUpload(input) {
  const file = input.files[0];
  if (!file) return;
  const prog = document.getElementById('upload-prog');
  const bar = document.getElementById('upload-bar');
  const placeholder = document.getElementById('upload-placeholder');
  prog.style.display = 'block'; bar.style.width = '20%';
  placeholder.style.display = 'none';

  try {
    const b64 = await compressImage(file, 1200, 0.85);
    const raw = b64.split(',')[1];
    const fname = `${Date.now()}-${slug(file.name.replace(/\.[^.]+$/,''))}.jpg`;
    const ghPath = `public/images/uploads/${fname}`;

    bar.style.width = '60%';
    await apiPutBinary(ghPath, raw, undefined, `Upload image: ${fname}`);
    bar.style.width = '100%';

    const imgPath = `/images/uploads/${fname}`;
    document.getElementById('f-img').value = imgPath;
    document.getElementById('img-current-path').textContent = imgPath;
    const prev = document.getElementById('img-preview-el');
    const reader = new FileReader();
    reader.onload = e => { prev.src = e.target.result; prev.style.display = 'block'; };
    reader.readAsDataURL(file);

    setTimeout(() => { prog.style.display = 'none'; bar.style.width = '0'; }, 800);
    toast('Image uploadÃ©e avec succÃ¨s !');
  } catch(e) {
    prog.style.display = 'none'; bar.style.width = '0';
    placeholder.style.display = 'block';
    toast('Erreur upload: '+e.message,'error');
  }
}

function fileToB64(file) {
  return new Promise((res, rej) => {
    const r = new FileReader();
    r.onload = () => res(r.result);
    r.onerror = rej;
    r.readAsDataURL(file);
  });
}

// Compress + resize image before upload (avoids Netlify 6MB body limit)
function compressImage(file, maxWidth = 1200, quality = 0.85) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onerror = reject;
    reader.onload = (e) => {
      const img = new Image();
      img.onerror = reject;
      img.onload = () => {
        const canvas = document.createElement('canvas');
        let w = img.width, h = img.height;
        if (w > maxWidth) { h = Math.round(h * maxWidth / w); w = maxWidth; }
        canvas.width = w; canvas.height = h;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(img, 0, 0, w, h);
        const dataUrl = canvas.toDataURL('image/jpeg', quality);
        resolve(dataUrl);
      };
      img.src = e.target.result;
    };
    reader.readAsDataURL(file);
  });
}

async function saveArticle(path, sha, isNew) {
  const titre = document.getElementById('f-titre').value.trim();
  if (!titre) { toast('Le titre est obligatoire','error'); return; }
  const btn = document.getElementById('save-btn');
  btn.disabled = true; btn.innerHTML = '<span class="spinner-sm"></span> Enregistrementâ€¦';
  try {
    const fm = {
      titre,
      description: document.getElementById('f-desc').value.trim(),
      date: document.getElementById('f-date').value || new Date().toISOString().split('T')[0],
      categorie: document.getElementById('f-cat').value,
      publie: document.getElementById('f-pub').checked,
    };
    const imgVal = document.getElementById('f-img').value;
    if (imgVal) fm.image = imgVal;
    const body = mde ? mde.value() : '';
    const content = buildFM(fm) + '\n\n' + body;
    const fpath = isNew ? `src/content/articles/${slug(titre)}.md` : path;
    await apiPut(fpath, content, isNew ? undefined : sha, `Article: ${titre}`);
    toast('Article enregistrÃ© ! Site mis Ã  jour dans 1â€“2 min.', 'success');
    setTimeout(() => loadArticles(), 900);
  } catch(e) {
    toast('Erreur: '+e.message,'error');
    btn.disabled = false; btn.innerHTML = 'ğŸ’¾ Enregistrer';
  }
}

async function delArticle(path, sha, titre) {
  if (!confirm(`Supprimer l'article "${titre}" ?\n\nCette action est irrÃ©versible.`)) return;
  try { await apiDel(path, sha); toast('Article supprimÃ©.'); loadArticles(); }
  catch(e) { toast('Erreur: '+e.message,'error'); }
}

// â”€â”€â”€ JSON EDITORS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const JSON_FILES = { contact:'src/data/contact.json', accueil:'src/data/home.json', equipe:'src/data/equipe.json', marques:'src/data/marques.json', services:'src/data/services.json', sav:'src/data/sav.json', boutique:'src/data/boutique.json' };

async function loadJsonEditor(section) {
  const main = document.getElementById('main');
  main.innerHTML = '<div class="loading"><div class="spinner"></div></div>';
  try {
    const d = await apiGet(JSON_FILES[section]);
    const json = JSON.parse(b64d(d.content));
    if (section === 'contact') renderContact(d.sha, json);
    else if (section === 'accueil') renderAccueil(d.sha, json);
    else if (section === 'marques') renderMarques(d.sha, json);
    else if (section === 'services') renderServices(d.sha, json);
    else if (section === 'sav') renderSAV(d.sha, json);
    else if (section === 'boutique') renderBoutique(d.sha, json);
    else renderEquipe(d.sha, json);
  } catch(e) {
    main.innerHTML = `<div class="loading" style="color:var(--red)">Erreur: ${e.message}</div>`;
  }
}

// â”€â”€ CONTACT â”€â”€
function renderContact(sha, j) {
  document.getElementById('main').innerHTML = `
    <div class="page-header"><div><h2>ğŸ“ Contact & Horaires</h2><p>CoordonnÃ©es et horaires d'ouverture</p></div></div>
    <div class="editor-wrap">
      <div class="editor-body">
        <div class="section-card">
          <h3>ğŸ“‹ Informations gÃ©nÃ©rales</h3>
          <div class="form-2col">
            <div class="form-group"><label>Nom du magasin</label><input id="c-nom" value="${esc(j.nom||'')}"/></div>
            <div class="form-group"><label>Slogan</label><input id="c-tagline" value="${esc(j.tagline||'')}"/></div>
            <div class="form-group"><label>Adresse (rue)</label><input id="c-adresse" value="${esc(j.adresse||'')}"/></div>
            <div class="form-group"><label>Ville & code postal</label><input id="c-ville" value="${esc(j.ville||'')}"/></div>
            <div class="form-group"><label>TÃ©lÃ©phone</label><input id="c-tel" value="${esc(j.telephone||'')}" type="tel"/></div>
            <div class="form-group"><label>Email</label><input id="c-email" value="${esc(j.email||'')}" type="email"/></div>
          </div>
        </div>
        <div class="section-card">
          <h3>ğŸ• Horaires d'ouverture</h3>
          <div id="horaires-list">
            ${(j.horaires||[]).map((h,i) => horaireRow(h,i)).join('')}
          </div>
        </div>
        <div class="section-card">
          <h3>âœ… Badges d'avantages</h3>
          <div class="list-editor" id="avantages-list">
            ${(j.avantages||[]).map(v => avantageItem(v)).join('')}
          </div>
          <button class="btn-add" onclick="addAvantage()">ï¼‹ Ajouter un avantage</button>
        </div>
      </div>
      <div class="editor-footer">
        <button class="btn-save" id="save-btn" onclick="saveContact('${sha}')">ğŸ’¾ Enregistrer les modifications</button>
      </div>
    </div>`;
}

function horaireRow(h, i) {
  return `<div class="horaire-row" data-i="${i}">
    <input class="h-jour" value="${esc(h.jour||'')}" placeholder="Lundi">
    <input class="h-heures" value="${esc(h.heures||'')}" placeholder="9h00 â€“ 19h00 ou FermÃ©" ${h.ferme?'style="opacity:.5"':''}>
    <div class="horaire-toggle">
      <label class="toggle"><input type="checkbox" class="h-ferme" ${h.ferme?'checked':''}
        onchange="this.closest('.horaire-row').querySelector('.h-heures').style.opacity=this.checked?'.5':'1'">
        <span class="tslider"></span></label> FermÃ©
    </div>
  </div>`;
}

function avantageItem(v) {
  return `<div class="list-item">
    <input type="text" value="${esc(v)}" placeholder="Ex: Parking gratuit">
    <button class="btn-rm" onclick="this.parentNode.remove()" title="Supprimer">âœ•</button>
  </div>`;
}

function addAvantage() {
  const list = document.getElementById('avantages-list');
  list.insertAdjacentHTML('beforeend', avantageItem(''));
  list.lastElementChild.querySelector('input').focus();
}

async function saveContact(sha) {
  const btn = document.getElementById('save-btn');
  btn.disabled = true; btn.innerHTML = '<span class="spinner-sm"></span> Enregistrementâ€¦';
  try {
    const horaires = [];
    document.querySelectorAll('#horaires-list .horaire-row').forEach(row => {
      horaires.push({ jour: row.querySelector('.h-jour').value, heures: row.querySelector('.h-heures').value, ferme: row.querySelector('.h-ferme').checked });
    });
    const avantages = [...document.querySelectorAll('#avantages-list input')].map(i=>i.value).filter(Boolean);
    const json = {
      nom: v('c-nom'), tagline: v('c-tagline'), adresse: v('c-adresse'),
      ville: v('c-ville'), telephone: v('c-tel'), email: v('c-email'),
      horaires, avantages
    };
    await apiPut(JSON_FILES.contact, JSON.stringify(json,null,2), sha, 'Mise Ã  jour Contact');
    toast('Contact enregistrÃ© ! Site mis Ã  jour dans 1â€“2 min.');
    loadJsonEditor('contact');
  } catch(e) { toast('Erreur: '+e.message,'error'); btn.disabled=false; btn.innerHTML='ğŸ’¾ Enregistrer les modifications'; }
}

// â”€â”€ ACCUEIL â”€â”€
function renderAccueil(sha, j) {
  document.getElementById('main').innerHTML = `
    <div class="page-header"><div><h2>ğŸ  Page d'accueil</h2><p>Textes et contenus de la page principale</p></div></div>
    <div class="editor-wrap">
      <div class="editor-body">
        <div class="section-card">
          <h3>ğŸ¯ BanniÃ¨re principale (Hero)</h3>
          <div class="form-group"><label>Titre principal</label><input id="h-titre" value="${esc(j.hero_titre||'')}"/></div>
          <div class="form-group"><label>Sous-titre</label><textarea id="h-sous" rows="3">${j.hero_sous_titre||''}</textarea></div>
          <div class="form-group"><label>Badge (ex: Opticien depuis 2008)</label><input id="h-badge" value="${esc(j.hero_badge||'')}"/></div>
        </div>
        <div class="section-card">
          <h3>ğŸ“Š Statistiques clÃ©s</h3>
          <div id="stats-list">
            ${(j.stats||[]).map(s=>statItem(s)).join('')}
          </div>
          <button class="btn-add" onclick="addStat()">ï¼‹ Ajouter une statistique</button>
        </div>
        <div class="section-card">
          <h3>ğŸ“– Section Histoire</h3>
          <div class="form-group"><label>Titre</label><input id="h-hist-titre" value="${esc(j.histoire_titre||'')}"/></div>
          <div class="form-group"><label>Texte</label><textarea id="h-hist-texte" rows="5">${j.histoire_texte||''}</textarea></div>
        </div>
        <div class="section-card">
          <h3>ğŸ“… Frise chronologique</h3>
          <div id="timeline-list">
            ${(j.timeline||[]).map(t=>timelineItem(t)).join('')}
          </div>
          <button class="btn-add" onclick="addTimeline()">ï¼‹ Ajouter une Ã©tape</button>
        </div>
      </div>
      <div class="editor-footer">
        <button class="btn-save" id="save-btn" onclick="saveAccueil('${sha}')">ğŸ’¾ Enregistrer les modifications</button>
      </div>
    </div>`;
}

function statItem(s) {
  return `<div class="list-item" style="margin-bottom:8px">
    <input type="text" value="${esc(s.valeur||'')}" placeholder="1000+" style="flex:.4;min-width:80px">
    <input type="text" value="${esc(s.label||'')}" placeholder="Description (ex: Montures)">
    <button class="btn-rm" onclick="this.parentNode.remove()">âœ•</button>
  </div>`;
}

function addStat() {
  const l = document.getElementById('stats-list');
  l.insertAdjacentHTML('beforeend', statItem({valeur:'',label:''}));
}

function timelineItem(t) {
  return `<div class="obj-item">
    <div class="obj-item-header"><span class="obj-label">Ã‰tape</span><button class="btn-rm" onclick="this.closest('.obj-item').remove()">âœ• Supprimer</button></div>
    <div class="form-3col">
      <div class="form-group"><label>AnnÃ©e</label><input class="tl-annee" type="text" value="${esc(t.annee||'')}" placeholder="2008"/></div>
      <div class="form-group"><label>Titre</label><input class="tl-titre" type="text" value="${esc(t.titre||'')}" placeholder="Ouverture de la boutique"/></div>
      <div class="form-group col-full"><label>Description</label><textarea class="tl-desc" rows="2">${t.description||''}</textarea></div>
    </div>
  </div>`;
}

function addTimeline() {
  document.getElementById('timeline-list').insertAdjacentHTML('beforeend', timelineItem({annee:'',titre:'',description:''}));
}

async function saveAccueil(sha) {
  const btn = document.getElementById('save-btn');
  btn.disabled=true; btn.innerHTML='<span class="spinner-sm"></span> Enregistrementâ€¦';
  try {
    const stats = [...document.querySelectorAll('#stats-list .list-item')].map(row => ({
      valeur: row.querySelectorAll('input')[0].value,
      label: row.querySelectorAll('input')[1].value
    })).filter(s=>s.valeur||s.label);
    const timeline = [...document.querySelectorAll('#timeline-list .obj-item')].map(row => ({
      annee: row.querySelector('.tl-annee').value,
      titre: row.querySelector('.tl-titre').value,
      description: row.querySelector('.tl-desc').value
    })).filter(t=>t.annee||t.titre);
    const json = {
      hero_titre: v('h-titre'), hero_sous_titre: v('h-sous'), hero_badge: v('h-badge'),
      stats, histoire_titre: v('h-hist-titre'), histoire_texte: v('h-hist-texte'), timeline
    };
    await apiPut(JSON_FILES.accueil, JSON.stringify(json,null,2), sha, 'Mise Ã  jour Page Accueil');
    toast('Page d\'accueil enregistrÃ©e ! Site mis Ã  jour dans 1â€“2 min.');
    loadJsonEditor('accueil');
  } catch(e) { toast('Erreur: '+e.message,'error'); btn.disabled=false; btn.innerHTML='ğŸ’¾ Enregistrer les modifications'; }
}

// â”€â”€ Ã‰QUIPE â”€â”€
function renderEquipe(sha, j) {
  const membres = j.membres||[];
  document.getElementById('main').innerHTML = `
    <div class="page-header"><div><h2>ğŸ‘¥ L'Ã‰quipe</h2><p>Membres et rÃ´les affichÃ©s sur le site</p></div></div>
    <div class="editor-wrap">
      <div class="editor-body">
        <div class="section-card">
          <h3>ğŸ‘¤ Membres de l'Ã©quipe</h3>
          <div id="equipe-list">
            ${membres.map((m,i) => membreItem(m,i)).join('')}
          </div>
          <button class="btn-add" onclick="addMembre()">ï¼‹ Ajouter un membre</button>
        </div>
      </div>
      <div class="editor-footer">
        <button class="btn-save" id="save-btn" onclick="saveEquipe('${sha}')">ğŸ’¾ Enregistrer les modifications</button>
      </div>
    </div>`;
}

function membreItem(m, i) {
  const photoSrc = m.photo ? `<img src="${esc(m.photo)}" alt="" style="width:100%;height:100%;object-fit:cover;object-position:top">` : 'ğŸ‘¤';
  return `<div class="obj-item">
    <div class="obj-item-header"><span class="obj-label">Membre ${i+1}</span><button class="btn-rm" onclick="this.closest('.obj-item').remove()">âœ• Supprimer</button></div>
    <div style="display:flex;gap:16px;align-items:flex-start;flex-wrap:wrap">
      <div>
        <label style="font-size:12px;font-weight:600;color:#4a5568;display:block;margin-bottom:6px">Photo</label>
        <div class="membre-photo-wrap" onclick="this.querySelector('input[type=file]')?.click()" title="Cliquer pour changer la photo" style="cursor:pointer;width:80px;height:80px;border:2px dashed var(--border);border-radius:50%;display:flex;align-items:center;justify-content:center;overflow:hidden;font-size:28px;flex-shrink:0;transition:border-color .2s" onmouseover="this.style.borderColor='var(--gold)'" onmouseout="this.style.borderColor='var(--border)'">
          ${photoSrc}
          <input type="file" accept="image/*" style="display:none" onchange="uploadMembrePhoto(this,${i})">
        </div>
        <input class="m-photo" type="text" value="${esc(m.photo||'')}" placeholder="/images/equipe/photo.jpg" style="width:80px;font-size:10px;color:#a0aec0;margin-top:4px;border:none;background:transparent;text-align:center;padding:0" readonly>
      </div>
      <div class="form-3col" style="flex:1;min-width:200px">
        <div class="form-group"><label>PrÃ©nom</label><input class="m-nom" value="${esc(m.nom||'')}" placeholder="Marie"/></div>
        <div class="form-group"><label>RÃ´le / Titre</label><input class="m-role" value="${esc(m.role||'')}" placeholder="Opticienne diplÃ´mÃ©e"/></div>
        <div class="form-group col-full"><label>Description courte</label><input class="m-exp" value="${esc(m.expertise||'')}" placeholder="SpÃ©cialiste adaptation lentilles"/></div>
      </div>
    </div>
  </div>`;
}

function addMembre() {
  const l = document.getElementById('equipe-list');
  const i = l.querySelectorAll('.obj-item').length;
  l.insertAdjacentHTML('beforeend', membreItem({nom:'',role:'',expertise:''},i));
}

async function saveEquipe(sha) {
  const btn = document.getElementById('save-btn');
  btn.disabled=true; btn.innerHTML='<span class="spinner-sm"></span> Enregistrementâ€¦';
  try {
    const membres = [...document.querySelectorAll('#equipe-list .obj-item')].map(row => ({
      nom: row.querySelector('.m-nom').value,
      role: row.querySelector('.m-role').value,
      expertise: row.querySelector('.m-exp').value,
      photo: row.querySelector('.m-photo').value,
    })).filter(m=>m.nom||m.role);
    await apiPut(JSON_FILES.equipe, JSON.stringify({membres},null,2), sha, 'Mise Ã  jour Ã‰quipe');
    toast('Ã‰quipe enregistrÃ©e ! Site mis Ã  jour dans 1â€“2 min.');
    loadJsonEditor('equipe');
  } catch(e) { toast('Erreur: '+e.message,'error'); btn.disabled=false; btn.innerHTML='ğŸ’¾ Enregistrer les modifications'; }
}

// â”€â”€â”€ MARQUES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const MARQUE_CATS = ['Iconique','CrÃ©ateur','Luxe','Mode','Lifestyle','Sport','Design','FranÃ§ais','Enfants','Premium'];

function renderMarques(sha, j) {
  const marques = j.marques || [];
  const featured = marques.filter(m => m.featured).length;
  document.getElementById('main').innerHTML = `
    <div class="page-header">
      <div><h2>ğŸ·ï¸ Nos Marques</h2><p>GÃ©rez les marques affichÃ©es sur le site</p></div>
      <button class="btn-new" onclick="addMarque()">ï¼‹ Ajouter une marque</button>
    </div>
    <div class="stats-row">
      <div class="stat-card"><div class="sv">${marques.length}</div><div class="sl">Marques au total</div></div>
      <div class="stat-card"><div class="sv">${featured}</div><div class="sl">En vedette (accueil)</div></div>
      <div class="stat-card"><div class="sv">${MARQUE_CATS.length}</div><div class="sl">CatÃ©gories</div></div>
    </div>
    <div class="editor-wrap">
      <div class="editor-body" style="padding:16px 20px">
        <div style="display:flex;align-items:center;gap:10px;margin-bottom:14px;font-size:12px;color:#718096">
          <span>â­ = AffichÃ© sur la page d'accueil</span>
          <span style="margin-left:auto">ğŸ“· = Cliquer pour changer le logo</span>
        </div>
        <div id="marques-list">
          ${marques.map((m,i) => marqueItem(m,i)).join('')}
        </div>
        <button class="btn-add" onclick="addMarque()" style="margin-top:12px">ï¼‹ Ajouter une marque</button>
      </div>
      <div class="editor-footer">
        <button class="btn-save" id="save-btn" onclick="saveMarques('${sha}')">ğŸ’¾ Enregistrer les modifications</button>
      </div>
    </div>`;
}

function marqueItem(m, i) {
  const catOptions = MARQUE_CATS.map(c => `<option ${m.category===c?'selected':''}>${c}</option>`).join('');
  const logoSrc = m.logo ? `<img src="${esc(m.logo)}" alt="" onerror="this.parentNode.innerHTML='ğŸ·ï¸'">` : 'ğŸ·ï¸';
  return `<div class="marque-item" data-idx="${i}">
    <div class="marque-logo-preview" title="Cliquer pour changer le logo" onclick="this.querySelector('input')?.click()" style="cursor:pointer">
      ${logoSrc}
      <input type="file" accept="image/*" style="display:none" onchange="uploadMarqueLogo(this,${i})">
    </div>
    <div class="marque-fields">
      <input class="mq-name" type="text" value="${esc(m.name||'')}" placeholder="Nom de la marque">
      <select class="mq-cat">
        <option value="">â€” CatÃ©gorie â€”</option>
        ${catOptions}
      </select>
      <input class="mq-logo" type="text" value="${esc(m.logo||'')}" placeholder="Chemin du logo (ex: /logos/marque.png)" style="grid-column:1/-1;font-size:11px;color:#718096">
    </div>
    <div class="marque-actions">
      <div class="marque-featured">
        <span class="star" onclick="toggleFeatured(this)" title="Afficher sur la page d'accueil">${m.featured ? 'â­' : 'â˜†'}</span>
      </div>
      <button class="btn-rm" onclick="this.closest('.marque-item').remove()" title="Supprimer" style="margin-top:4px">âœ•</button>
    </div>
  </div>`;
}

function addMarque() {
  const list = document.getElementById('marques-list');
  const i = list.querySelectorAll('.marque-item').length;
  list.insertAdjacentHTML('beforeend', marqueItem({name:'',logo:'',category:'',featured:false}, i));
  list.lastElementChild.querySelector('.mq-name').focus();
}

function toggleFeatured(star) {
  star.textContent = star.textContent === 'â­' ? 'â˜†' : 'â­';
}

async function uploadMarqueLogo(input, idx) {
  const file = input.files[0];
  if (!file) return;
  const item = input.closest('.marque-item');
  const preview = item.querySelector('.marque-logo-preview');
  const logoInput = item.querySelector('.mq-logo');
  preview.innerHTML = '<div class="spinner" style="width:20px;height:20px;border-width:2px"></div>';

  try {
    const b64 = await compressImage(file, 600, 0.9);
    const raw = b64.split(',')[1];
    const fname = `${slug(item.querySelector('.mq-name').value || 'marque')}-lunettes.jpg`;
    const ghPath = `public/logos/${fname}`;

    await apiPutBinary(ghPath, raw, undefined, `Upload logo: ${fname}`);

    const logoPath = `/logos/${fname}`;
    logoInput.value = logoPath;
    preview.innerHTML = `<img src="${b64}" alt=""><input type="file" accept="image/*" style="display:none" onchange="uploadMarqueLogo(this,${idx})">`;
    toast('Logo uploadÃ© !');
  } catch(e) {
    preview.innerHTML = 'ğŸ·ï¸<input type="file" accept="image/*" style="display:none" onchange="uploadMarqueLogo(this,' + idx + ')">';
    toast('Erreur upload: '+e.message,'error');
  }
}

async function saveMarques(sha) {
  const btn = document.getElementById('save-btn');
  btn.disabled = true; btn.innerHTML = '<span class="spinner-sm"></span> Enregistrementâ€¦';
  try {
    const marques = [...document.querySelectorAll('#marques-list .marque-item')].map(row => ({
      name: row.querySelector('.mq-name').value.trim(),
      logo: row.querySelector('.mq-logo').value.trim(),
      category: row.querySelector('.mq-cat').value,
      featured: row.querySelector('.star').textContent === 'â­'
    })).filter(m => m.name);
    const json = { categories: MARQUE_CATS, marques };
    await apiPut(JSON_FILES.marques, JSON.stringify(json, null, 2), sha, 'Mise Ã  jour Marques');
    toast('Marques enregistrÃ©es ! Site mis Ã  jour dans 1â€“2 min.');
    loadJsonEditor('marques');
  } catch(e) {
    toast('Erreur: '+e.message,'error');
    btn.disabled = false; btn.innerHTML = 'ğŸ’¾ Enregistrer les modifications';
  }
}

// â”€â”€ UPLOAD PHOTO Ã‰QUIPE â”€â”€
async function uploadMembrePhoto(input, idx) {
  const file = input.files[0];
  if (!file) return;
  const item = input.closest('.obj-item');
  const wrap = item.querySelector('.membre-photo-wrap');
  const photoInput = item.querySelector('.m-photo');
  wrap.innerHTML = '<div class="spinner" style="width:20px;height:20px;border-width:2px"></div>';
  try {
    const b64 = await compressImage(file, 600, 0.85);
    const raw = b64.split(',')[1];
    const ext = file.name.split('.').pop().toLowerCase();
    const nom = item.querySelector('.m-nom').value || 'membre';
    const fname = `${slug(nom)}-gravelines-optique.${ext}`;
    const ghPath = `public/images/equipe/${fname}`;
    await apiPutBinary(ghPath, raw, undefined, `Upload photo Ã©quipe: ${fname}`);
    const photoPath = `/images/equipe/${fname}`;
    photoInput.value = photoPath;
    wrap.innerHTML = `<img src="${b64}" alt="" style="width:100%;height:100%;object-fit:cover"><input type="file" accept="image/*" style="display:none" onchange="uploadMembrePhoto(this,${idx})">`;
    toast('Photo uploadÃ©e !');
  } catch(e) {
    wrap.innerHTML = `ğŸ‘¤<input type="file" accept="image/*" style="display:none" onchange="uploadMembrePhoto(this,${idx})">`;
    toast('Erreur upload: '+e.message,'error');
  }
}

// â”€â”€ SERVICES â”€â”€
function renderServices(sha, j) {
  const services = j.services || [];
  document.getElementById('main').innerHTML = `
    <div class="page-header">
      <div><h2>ğŸ› ï¸ Services</h2><p>GÃ©rez les services proposÃ©s par la boutique</p></div>
      <button class="btn-new" onclick="addService()">ï¼‹ Ajouter un service</button>
    </div>
    <div class="stats-row">
      <div class="stat-card"><div class="sv">${services.length}</div><div class="sl">Services au total</div></div>
      <div class="stat-card"><div class="sv">${services.filter(s=>s.accent).length}</div><div class="sl">Mis en avant</div></div>
      <div class="stat-card"><div class="sv">${services.reduce((n,s)=>n+(s.details?.length||0),0)}</div><div class="sl">Points forts au total</div></div>
    </div>
    <div class="editor-wrap">
      <div class="editor-body">
        <div id="services-list">
          ${services.map((s,i) => serviceItem(s,i)).join('')}
        </div>
        <button class="btn-add" onclick="addService()" style="margin-top:12px">ï¼‹ Ajouter un service</button>
      </div>
      <div class="editor-footer">
        <button class="btn-save" id="save-btn" onclick="saveServices('${sha}')">ğŸ’¾ Enregistrer les modifications</button>
      </div>
    </div>`;
}

function serviceItem(s, i) {
  return `<div class="obj-item" style="margin-bottom:16px">
    <div class="obj-item-header">
      <span class="obj-label">${esc(s.title||'Nouveau service')}</span>
      <div style="display:flex;align-items:center;gap:12px">
        <label style="display:flex;align-items:center;gap:6px;font-size:12px;cursor:pointer;color:#4a5568">
          <input type="checkbox" class="s-accent" ${s.accent?'checked':''}> Fond sombre (mis en avant)
        </label>
        <button class="btn-rm" onclick="this.closest('.obj-item').remove()">âœ• Supprimer</button>
      </div>
    </div>
    <div class="form-2col">
      <div class="form-group"><label>Titre du service</label><input class="s-title" value="${esc(s.title||'')}" placeholder="Examen de vue" oninput="this.closest('.obj-item').querySelector('.obj-label').textContent=this.value||'Nouveau service'"/></div>
      <div class="form-group"><label>Badge / Sous-titre</label><input class="s-subtitle" value="${esc(s.subtitle||'')}" placeholder="Gratuit & sans rendez-vous"/></div>
      <div class="form-group col-full"><label>Description</label><textarea class="s-desc" rows="3" placeholder="DÃ©crivez ce service...">${esc(s.description||'')}</textarea></div>
    </div>
    <div style="margin-top:12px">
      <label style="font-size:12px;font-weight:600;color:#4a5568;display:block;margin-bottom:6px">Points forts (liste Ã  puces)</label>
      <div class="list-editor s-details">
        ${(s.details||[]).map(d => `<div class="list-item"><input type="text" value="${esc(d)}" placeholder="Ex: Mesure de l'acuitÃ© visuelle"><button class="btn-rm" onclick="this.parentNode.remove()">âœ•</button></div>`).join('')}
      </div>
      <button class="btn-add" onclick="this.previousElementSibling.insertAdjacentHTML('beforeend','<div class=\\'list-item\\'><input type=\\'text\\' placeholder=\\'Nouveau point\\'><button class=\\'btn-rm\\' onclick=\\'this.parentNode.remove()\\'>âœ•</button></div>');this.previousElementSibling.lastElementChild.querySelector(\\'input\\').focus()" style="margin-top:4px;font-size:12px;padding:5px 12px">ï¼‹ Ajouter un point</button>
    </div>
  </div>`;
}

function addService() {
  const l = document.getElementById('services-list');
  const i = l.querySelectorAll('.obj-item').length;
  l.insertAdjacentHTML('beforeend', serviceItem({title:'',subtitle:'',description:'',details:[],accent:false}, i));
  l.lastElementChild.querySelector('.s-title').focus();
}

async function saveServices(sha) {
  const btn = document.getElementById('save-btn');
  btn.disabled=true; btn.innerHTML='<span class="spinner-sm"></span> Enregistrementâ€¦';
  try {
    const services = [...document.querySelectorAll('#services-list .obj-item')].map(row => {
      const details = [...row.querySelectorAll('.s-details input')].map(i=>i.value.trim()).filter(Boolean);
      return {
        id: slug(row.querySelector('.s-title').value || 'service'),
        title: row.querySelector('.s-title').value.trim(),
        subtitle: row.querySelector('.s-subtitle').value.trim(),
        description: row.querySelector('.s-desc').value.trim(),
        details,
        accent: row.querySelector('.s-accent').checked
      };
    }).filter(s=>s.title);
    await apiPut(JSON_FILES.services, JSON.stringify({services},null,2), sha, 'Mise Ã  jour Services');
    toast('Services enregistrÃ©s ! Site mis Ã  jour dans 1â€“2 min.');
    loadJsonEditor('services');
  } catch(e) { toast('Erreur: '+e.message,'error'); btn.disabled=false; btn.innerHTML='ğŸ’¾ Enregistrer les modifications'; }
}

// â”€â”€ SAV â”€â”€
function renderSAV(sha, j) {
  document.getElementById('main').innerHTML = `
    <div class="page-header"><div><h2>ğŸ”§ SAV & RÃ©parations</h2><p>Tarifs, garanties et processus de rÃ©paration</p></div></div>
    <div class="editor-wrap">
      <div class="editor-body">
        <div class="section-card">
          <h3>ğŸ’° Tableau des tarifs</h3>
          <div style="display:grid;grid-template-columns:1fr auto auto auto;gap:6px;align-items:center;margin-bottom:8px;font-size:11px;font-weight:700;color:#718096;padding:0 4px">
            <span>Type de rÃ©paration</span><span style="text-align:center;width:90px">DÃ©lai</span><span style="text-align:right;width:90px">Tarif</span><span style="width:28px"></span>
          </div>
          <div id="reparations-list">
            ${(j.reparations||[]).map(r => reparationRow(r)).join('')}
          </div>
          <button class="btn-add" onclick="addReparation()">ï¼‹ Ajouter une rÃ©paration</button>
        </div>
        <div class="section-card">
          <h3>ğŸ›¡ï¸ Garanties & engagements (3 blocs)</h3>
          <div id="garanties-list">
            ${(j.garanties||[]).map(g => garantieItem(g)).join('')}
          </div>
          <button class="btn-add" onclick="addGarantie()">ï¼‹ Ajouter un engagement</button>
        </div>
        <div class="section-card">
          <h3>ğŸ“‹ Ã‰tapes du processus (4 Ã©tapes max)</h3>
          <div id="etapes-list">
            ${(j.etapes||[]).map(e => etapeItem(e)).join('')}
          </div>
          <button class="btn-add" onclick="addEtape()">ï¼‹ Ajouter une Ã©tape</button>
        </div>
      </div>
      <div class="editor-footer">
        <button class="btn-save" id="save-btn" onclick="saveSAV('${sha}')">ğŸ’¾ Enregistrer les modifications</button>
      </div>
    </div>`;
}

function reparationRow(r) {
  return `<div class="list-item" style="gap:6px">
    <input class="r-title" type="text" value="${esc(r.title||'')}" placeholder="Type de rÃ©paration" style="flex:2;min-width:0">
    <input class="r-delai" type="text" value="${esc(r.delai||'')}" placeholder="24-48h" style="width:90px;text-align:center">
    <input class="r-prix" type="text" value="${esc(r.prix||'')}" placeholder="DÃ¨s 15â‚¬" style="width:90px;text-align:right">
    <button class="btn-rm" onclick="this.parentNode.remove()">âœ•</button>
  </div>`;
}

function garantieItem(g) {
  return `<div class="list-item" style="gap:8px">
    <input class="g-icon" type="text" value="${esc(g.icon||'')}" placeholder="ğŸ›¡ï¸" style="width:48px;text-align:center;font-size:18px">
    <input class="g-title" type="text" value="${esc(g.title||'')}" placeholder="Titre" style="flex:.8">
    <input class="g-desc" type="text" value="${esc(g.desc||'')}" placeholder="Description courte" style="flex:2">
    <button class="btn-rm" onclick="this.parentNode.remove()">âœ•</button>
  </div>`;
}

function etapeItem(e) {
  return `<div class="list-item" style="gap:8px">
    <input class="e-step" type="text" value="${esc(e.step||'')}" placeholder="1" style="width:40px;text-align:center;font-weight:700">
    <input class="e-title" type="text" value="${esc(e.title||'')}" placeholder="Titre de l'Ã©tape" style="flex:1">
    <input class="e-desc" type="text" value="${esc(e.desc||'')}" placeholder="Description courte" style="flex:2">
    <button class="btn-rm" onclick="this.parentNode.remove()">âœ•</button>
  </div>`;
}

function addReparation() {
  document.getElementById('reparations-list').insertAdjacentHTML('beforeend', reparationRow({title:'',delai:'',prix:''}));
  document.getElementById('reparations-list').lastElementChild.querySelector('.r-title').focus();
}
function addGarantie() {
  document.getElementById('garanties-list').insertAdjacentHTML('beforeend', garantieItem({icon:'',title:'',desc:''}));
  document.getElementById('garanties-list').lastElementChild.querySelector('.g-title').focus();
}
function addEtape() {
  const l = document.getElementById('etapes-list');
  const n = l.querySelectorAll('.list-item').length + 1;
  l.insertAdjacentHTML('beforeend', etapeItem({step:String(n),title:'',desc:''}));
  l.lastElementChild.querySelector('.e-title').focus();
}

async function saveSAV(sha) {
  const btn = document.getElementById('save-btn');
  btn.disabled=true; btn.innerHTML='<span class="spinner-sm"></span> Enregistrementâ€¦';
  try {
    const reparations = [...document.querySelectorAll('#reparations-list .list-item')].map(row => ({
      title: row.querySelector('.r-title').value.trim(),
      delai: row.querySelector('.r-delai').value.trim(),
      prix: row.querySelector('.r-prix').value.trim()
    })).filter(r=>r.title);
    const garanties = [...document.querySelectorAll('#garanties-list .list-item')].map(row => ({
      icon: row.querySelector('.g-icon').value.trim(),
      title: row.querySelector('.g-title').value.trim(),
      desc: row.querySelector('.g-desc').value.trim()
    })).filter(g=>g.title);
    const etapes = [...document.querySelectorAll('#etapes-list .list-item')].map(row => ({
      step: row.querySelector('.e-step').value.trim(),
      title: row.querySelector('.e-title').value.trim(),
      desc: row.querySelector('.e-desc').value.trim()
    })).filter(e=>e.title);
    await apiPut(JSON_FILES.sav, JSON.stringify({reparations,garanties,etapes},null,2), sha, 'Mise Ã  jour SAV');
    toast('SAV enregistrÃ© ! Site mis Ã  jour dans 1â€“2 min.');
    loadJsonEditor('sav');
  } catch(e) { toast('Erreur: '+e.message,'error'); btn.disabled=false; btn.innerHTML='ğŸ’¾ Enregistrer les modifications'; }
}

// â”€â”€ BOUTIQUE â”€â”€
function renderBoutique(sha, j) {
  document.getElementById('main').innerHTML = `
    <div class="page-header"><div><h2>ğŸª La Boutique</h2><p>Textes et chiffres clÃ©s de la page boutique</p></div></div>
    <div class="editor-wrap">
      <div class="editor-body">
        <div class="section-card">
          <h3>ğŸ“– Textes de prÃ©sentation</h3>
          <div class="form-group"><label>Paragraphe 1 (histoire, identitÃ©)</label><textarea id="b-texte1" rows="4" placeholder="Depuis 2008...">${j.texte1||''}</textarea></div>
          <div class="form-group"><label>Paragraphe 2 (boutique, sÃ©lection)</label><textarea id="b-texte2" rows="4" placeholder="FondÃ©e avec la passion...">${j.texte2||''}</textarea></div>
        </div>
        <div class="section-card">
          <h3>ğŸ“Š Chiffres clÃ©s (4 stats)</h3>
          <div id="boutique-stats">
            ${(j.stats||[]).map(s => boutiqueStatItem(s)).join('')}
          </div>
          <button class="btn-add" onclick="addBoutiqueStat()">ï¼‹ Ajouter un chiffre</button>
        </div>
        <div class="section-card">
          <h3>âœ… Avantages de la boutique (4 blocs)</h3>
          <div id="boutique-avantages">
            ${(j.avantages||[]).map(a => boutiqueAvantageItem(a)).join('')}
          </div>
          <button class="btn-add" onclick="addBoutiqueAvantage()">ï¼‹ Ajouter un avantage</button>
        </div>
      </div>
      <div class="editor-footer">
        <button class="btn-save" id="save-btn" onclick="saveBoutique('${sha}')">ğŸ’¾ Enregistrer les modifications</button>
      </div>
    </div>`;
}

function boutiqueStatItem(s) {
  return `<div class="list-item" style="gap:8px">
    <input class="bs-value" type="text" value="${esc(s.value||'')}" placeholder="2008" style="width:90px;font-weight:700;font-size:15px">
    <input class="bs-label" type="text" value="${esc(s.label||'')}" placeholder="FondÃ©e en" style="flex:1">
    <button class="btn-rm" onclick="this.parentNode.remove()">âœ•</button>
  </div>`;
}

function boutiqueAvantageItem(a) {
  return `<div class="list-item" style="gap:8px">
    <input class="ba-icon" type="text" value="${esc(a.icon||'')}" placeholder="ğŸ¤" style="width:48px;text-align:center;font-size:18px">
    <input class="ba-title" type="text" value="${esc(a.title||'')}" placeholder="Titre" style="flex:.8">
    <input class="ba-desc" type="text" value="${esc(a.desc||'')}" placeholder="Description courte" style="flex:2">
    <button class="btn-rm" onclick="this.parentNode.remove()">âœ•</button>
  </div>`;
}

function addBoutiqueStat() {
  document.getElementById('boutique-stats').insertAdjacentHTML('beforeend', boutiqueStatItem({value:'',label:''}));
  document.getElementById('boutique-stats').lastElementChild.querySelector('.bs-value').focus();
}
function addBoutiqueAvantage() {
  document.getElementById('boutique-avantages').insertAdjacentHTML('beforeend', boutiqueAvantageItem({icon:'',title:'',desc:''}));
  document.getElementById('boutique-avantages').lastElementChild.querySelector('.ba-title').focus();
}

async function saveBoutique(sha) {
  const btn = document.getElementById('save-btn');
  btn.disabled=true; btn.innerHTML='<span class="spinner-sm"></span> Enregistrementâ€¦';
  try {
    const stats = [...document.querySelectorAll('#boutique-stats .list-item')].map(row => ({
      value: row.querySelector('.bs-value').value.trim(),
      label: row.querySelector('.bs-label').value.trim()
    })).filter(s=>s.value||s.label);
    const avantages = [...document.querySelectorAll('#boutique-avantages .list-item')].map(row => ({
      icon: row.querySelector('.ba-icon').value.trim(),
      title: row.querySelector('.ba-title').value.trim(),
      desc: row.querySelector('.ba-desc').value.trim()
    })).filter(a=>a.title);
    const json = { texte1: v('b-texte1'), texte2: v('b-texte2'), stats, avantages };
    await apiPut(JSON_FILES.boutique, JSON.stringify(json,null,2), sha, 'Mise Ã  jour Boutique');
    toast('Boutique enregistrÃ©e ! Site mis Ã  jour dans 1â€“2 min.');
    loadJsonEditor('boutique');
  } catch(e) { toast('Erreur: '+e.message,'error'); btn.disabled=false; btn.innerHTML='ğŸ’¾ Enregistrer les modifications'; }
}

// â”€â”€ HELPER â”€â”€
function v(id) { const el = document.getElementById(id); return el ? el.value : ''; }
</script>
</body>
</html>
